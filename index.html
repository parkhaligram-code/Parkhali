<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>পারখালী স্মার্ট গ্রাম</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <!-- Font Awesome for official social icons (brand colors) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ================== THEME VARIABLES ================== */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f97316;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
            --header-grad: linear-gradient(135deg, #2563eb, #0891b2);
            --transition: all 0.3s ease;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Hind Siliguri', sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text-main); padding-bottom: 90px; }
        .container { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; background: var(--bg); box-shadow: 0 0 20px rgba(0,0,0,0.05); overflow-x: hidden; }

        /* ================== TOAST & LOADING ================== */
        #toast-message {
            position: fixed; bottom: 100px; left: 20px; right: 20px; max-width: 400px; margin: 0 auto;
            background: #1e293b; color: white; padding: 12px 20px; border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 1000; display: flex;
            align-items: center; gap: 10px; 
            transform: translateY(150px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            font-weight: 500; backdrop-filter: blur(10px);
        }
        #toast-message.show { 
            transform: translateY(0); 
            opacity: 1; 
            visibility: visible; 
        }
        .spinner-small { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }

        /* ================== HEADER (with text slider - fixed marquee) ================== */
        header { background: var(--header-grad); color: white; padding: 1rem 1.2rem 1.8rem; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; position: relative; z-index: 10; transition: var(--transition); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .app-title { font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; gap: 5px; }
        .datetime-display {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-family: 'Poppins', 'Hind Siliguri', sans-serif;
            line-height: 1.3;
        }
        .time {
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .date {
            font-size: 0.85rem;
            font-weight: 300;
            opacity: 0.9;
        }
        /* Premium Text Slider - fixed: now a smooth marquee using CSS animation */
        .text-slider {
            margin-top: 8px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 0.6rem 1rem;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            height: 3.2rem;
            display: flex;
            align-items: center;
            position: relative;
            white-space: nowrap;
        }
        .slider-content {
            display: inline-block;
            white-space: nowrap;
            animation: scrollMarquee 20s linear infinite;
            font-size: 1.3rem;
            font-weight: 600;
            color: white; /* default color, will be overridden by dynamic color */
            text-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-family: 'Hind Siliguri', sans-serif; /* highly readable Bengali */
            padding-right: 20px; /* space between end and restart */
        }
        /* Duplicate content for seamless loop is handled by JS */
        @keyframes scrollMarquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        /* Fallback for no texts */
        .slider-placeholder {
            color: white;
            text-align: center;
            font-size: 1.2rem;
            width: 100%;
        }
        /* hide slider on non-home pages */
        .text-slider.hidden { display: none; }

        /* ================== MAIN & CARDS ================== */
        main { padding: 0 1rem; margin-top: -1.5rem; position: relative; z-index: 20; }
        .card { background: var(--card); padding: 1.2rem; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 1rem; transition: var(--transition); }
        .title-sec { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 5px; margin-bottom: 15px; color: var(--primary); }

        .input-box { width: 100%; padding: 14px 16px; margin-bottom: 12px; border: 1px solid #e2e8f0; border-radius: 14px; font-family: inherit; font-size: 0.95rem; background: #f8fafc; transition: var(--transition); }
        .input-box:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 14px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(37,99,235,0.3); }
        .btn-success { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(16,185,129,0.3); }
        .btn-outline { background: white; color: var(--primary); border: 1px solid var(--primary); box-shadow: var(--shadow); }
        .btn-danger { background: var(--danger); color: white; }

        /* ================== FILE INPUT ================== */
        .file-upload-area {
            border: 2px dashed var(--primary); background: #f0f9ff; border-radius: 20px; padding: 20px;
            text-align: center; margin-bottom: 15px; cursor: pointer; transition: var(--transition);
            position: relative;
        }
        .file-upload-area:hover { background: #e0f2fe; }
        .file-upload-area input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .file-upload-area .material-icons-round { font-size: 40px; color: var(--primary); }
        .file-upload-area p { margin: 5px 0 0; color: var(--text-sub); }
        .image-preview { width: 100%; max-height: 150px; object-fit: cover; border-radius: 12px; margin-top: 8px; border: 1px solid #e2e8f0; }

        /* ================== BANNER SLIDER ================== */
        .banner-box { position: relative; width: 100%; padding-top: 43.75%; border-radius: 20px; overflow: hidden; background: #e2e8f0; margin-bottom: 15px; box-shadow: var(--shadow); }
        .banner-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1s; }
        .banner-img.active { opacity: 1; }

        /* ================== GLANCE GRID (updated: more compact, modern) ================== */
        .glance-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .glance-card {
            background: white;
            padding: 8px 4px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border: 1px solid #f1f5f9;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .glance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }
        .glance-card:active { transform: scale(0.95); }
        .glance-card .material-icons-round { font-size: 22px; padding: 6px; border-radius: 50%; margin-bottom: 2px; }
        .glance-title { font-size: 0.8rem; font-weight: 600; color: var(--text-main); }

        /* ================== HOME ACTION CARDS (Sports & Group Chat) ================== */
        .home-action-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .home-action-card {
            flex: 1;
            background: white;
            border-radius: 16px;
            padding: 15px 5px;
            text-align: center;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #f1f5f9;
        }
        .home-action-card:active {
            transform: scale(0.96);
        }
        .home-action-card .material-icons-round {
            font-size: 32px;
            color: var(--primary);
        }
        .home-action-card .glance-title {
            font-size: 1rem;
            font-weight: 600;
        }

        /* ================== LISTS & CARDS ================== */
        .list-item { background: white; padding: 15px; border-radius: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; }
        .list-item:active { background: #f8fafc; }
        .avatar { width: 45px; height: 45px; background: #eff6ff; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; margin-right: 15px; overflow: hidden; cursor: pointer; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .info h4 { margin: 0 0 3px; font-size: 1.05rem; }
        .info p { margin: 0; font-size: 0.85rem; color: var(--text-sub); }
        .call-btn { width: 40px; height: 40px; background: #dcfce7; color: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; }

        .place-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; margin-right: 10px; }

        .service-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .service-card { background: white; padding: 15px; text-align: center; border-radius: 20px; box-shadow: var(--shadow); cursor: pointer; transition: 0.2s; }
        .service-card:active { transform: scale(0.97); }
        .s-icon { width: 55px; height: 55px; margin: 0 auto 10px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 28px; }

        /* ================== GALLERY GRID (also for important persons) ================== */
        .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .gallery-item { position: relative; aspect-ratio: 1/1; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); cursor: pointer; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-download { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; padding: 4px; cursor: pointer; z-index: 2; }

        /* ================== SPORTS CARD ================== */
        .sports-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 10px; }
        .sports-card { background: white; border-radius: 20px; padding: 15px; box-shadow: var(--shadow); cursor: pointer; transition: 0.2s; }
        .sports-card:active { transform: scale(0.98); }
        .sports-card img { width: 100%; max-height: 180px; object-fit: cover; border-radius: 12px; margin-bottom: 10px; }
        .sports-card h3 { margin: 0 0 5px; font-size: 1.2rem; color: var(--primary); }
        .sports-card p { margin: 0; color: var(--text-sub); font-size: 0.9rem; }

        /* ================== DRIVER CARD ================== */
        .driver-card {
            background: white;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .driver-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #e2e8f0;
            overflow: hidden;
            flex-shrink: 0;
        }
        .driver-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .driver-info {
            flex: 1;
        }
        .driver-info h4 {
            margin: 0 0 5px;
            font-size: 1.1rem;
        }
        .driver-info p {
            margin: 0;
            color: var(--text-sub);
            font-size: 0.9rem;
        }
        .driver-call {
            background: var(--accent);
            color: white;
            border-radius: 40px;
            padding: 8px 15px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }

        /* ================== BOTTOM NAV ================== */
        .bottom-nav { position: fixed; bottom: 15px; left: 15px; right: 15px; max-width: 450px; margin: 0 auto; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 8px 20px; border-radius: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: none; justify-content: space-between; align-items: center; z-index: 100; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; color: #94a3b8; font-size: 0.75rem; font-weight: 600; cursor: pointer; flex: 1; transition: 0.2s; }
        .nav-btn.active { color: var(--primary); }
        .nav-center { width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-top: -35px; border: 4px solid white; box-shadow: 0 5px 15px rgba(37,99,235,0.4); transition: var(--transition); }

        /* ================== MODALS ================== */
        .modal-bg {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200;
            display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 400px; padding: 20px;
            border-radius: 25px; max-height: 85vh; overflow-y: auto;
            transform: scale(0.8); opacity: 0;
            transition: transform 0.3s ease, opacity 0.2s ease;
        }
        .modal-bg.show .modal-content {
            transform: scale(1); opacity: 1;
        }
        .close-icon { float: right; background: #f1f5f9; border-radius: 50%; padding: 5px; cursor: pointer; color: #64748b; }

        /* ================== CONDITIONAL FIELDS ================== */
        .conditional-field {
            display: none;
            animation: slideDown 0.3s ease;
        }
        .conditional-field.show {
            display: block;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Image view modal */
        #image-view-modal .modal-content { text-align: center; }
        #image-view-modal img { max-width: 100%; max-height: 60vh; border-radius: 12px; margin: 15px 0; }
        .download-btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 30px; display: inline-flex; align-items: center; gap: 8px; cursor: pointer; font-size: 1rem; }

        /* ================== SPLASH ================== */
        #splash {
            position: fixed; inset: 0; background: var(--header-grad); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; transition: 0.5s;
        }
        .splash-text {
            font-size: 3rem;
            font-weight: 700;
            animation: bounceText 1.2s infinite alternate ease-in-out;
            letter-spacing: 2px;
            text-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        @keyframes bounceText {
            0% { transform: scale(1); letter-spacing: 2px; }
            100% { transform: scale(1.1); letter-spacing: 6px; }
        }
        .loader { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-top: 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .success-box { position: fixed; inset: 0; background: white; z-index: 999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .check-anim { width: 80px; height: 80px; background: var(--accent); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 40px; margin-bottom: 15px; animation: pop 0.5s; }
        @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        /* ================== PROFILE ================== */
        .profile-cover {
            background: linear-gradient(145deg, var(--primary), var(--primary-dark));
            height: 120px; border-radius: 20px 20px 0 0; margin: -1.2rem -1.2rem 1rem -1.2rem;
            position: relative;
        }
        .profile-avatar-wrapper {
            position: relative; width: 110px; height: 110px; margin: -55px auto 10px; z-index: 10;
        }
        .profile-avatar {
            width: 100%; height: 100%; border-radius: 50%; overflow: hidden;
            background: white; border: 4px solid white; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
        }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-avatar .material-icons-round { font-size: 60px; color: var(--text-sub); background: #f1f5f9; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .edit-avatar-btn {
            position: absolute; bottom: 5px; right: 5px; background: white;
            width: 36px; height: 36px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer; border: 2px solid white; color: var(--primary);
        }
        .profile-name {
            text-align: center; margin: 5px 0 0;
        }
        .profile-name h3 { font-size: 1.4rem; margin: 0; }
        .profile-name p { color: var(--text-sub); margin: 5px 0 0; }

        .info-grid {
            display: flex; gap: 15px; justify-content: center; margin: 15px 0;
        }
        .info-chip {
            background: #f8fafc; padding: 8px 16px; border-radius: 30px; font-size: 0.9rem;
            display: flex; align-items: center; gap: 5px; color: var(--text-main);
        }
        .info-chip .material-icons-round { font-size: 18px; color: var(--primary); }

        /* Social Icons in Profile (brand colors) */
        .social-icons {
            display: flex; gap: 20px; justify-content: center; margin: 15px 0;
        }
        .social-icons a {
            text-decoration: none;
            transition: transform 0.2s;
            font-size: 30px;
        }
        .social-icons a:hover {
            transform: scale(1.1);
        }
        .fa-facebook { color: #1877f2; }
        .fa-whatsapp { color: #25D366; }
        .fa-telegram { color: #0088cc; }

        /* ================== NOTICE CARD ================== */
        .notice-card {
            background: white; padding: 12px; border-left: 4px solid var(--primary);
            border-radius: 12px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer; transition: 0.2s;
        }
        .notice-card:active { background: #f8fafc; }
        .notice-card h4 { margin: 0 0 5px; }
        .notice-card p { margin: 0 0 8px; font-size: 0.85rem; color: #64748b; }
        .notice-img { width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px; margin-top: 8px; }

        /* ================== ADMIN CARDS ================== */
        .admin-stat { background: #1e293b; color: white; padding: 15px; border-radius: 16px; flex: 1; text-align: center; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .exampro-card {
            background: #1e293b; border-radius: 20px; padding: 22px 10px; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); border-bottom: 3px solid #38bdf8;
            cursor: pointer; transition: 0.2s;
        }
        .exampro-card:active { transform: scale(0.95); }
        .exampro-card .material-icons-round { color: #38bdf8; font-size: 38px; margin-bottom: 10px; }
        .exampro-card span { color: #f8fafc; font-weight: 600; font-size: 1rem; }

        .admin-banner-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8fafc; border-radius: 10px; margin-bottom: 10px; }
        .admin-banner-img { height: 50px; width: 80px; object-fit: cover; border-radius: 6px; }
        .action-btn { padding: 6px 12px; border: none; border-radius: 30px; color: white; cursor: pointer; font-size: 0.8rem; margin-left: 5px; }

        /* ================== THEME SELECTOR ================== */
        .theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .theme-item { height: 60px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; background-size: cover; }
        .theme-item.active { border-color: var(--primary); transform: scale(1.02); }

        /* ================== WEATHER MODULE ================== */
        .weather-large-card {
            background: linear-gradient(145deg, #0ea5e9, #38bdf8);
            padding: 15px;
            border-radius: 20px;
            color: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }
        .weather-large-card h3 { margin: 0 0 5px; font-size: 1.3rem; }
        .weather-temp-today { font-size: 3rem; font-weight: 700; line-height: 1; }
        .weather-temp-tomorrow { font-size: 2rem; font-weight: 600; }
        .weather-forecast-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 5px;
        }
        /* Weather animations container */
        .weather-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        /* Rain */
        .rain {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
        }
        .rain:after {
            content: '';
            position: absolute;
            top: -30%;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(transparent 0%, rgba(255,255,255,0.3) 30%, transparent 70%);
            animation: rain-fall 0.5s linear infinite;
            opacity: 0.4;
        }
        .rain.heavy:after {
            animation-duration: 0.2s;
            opacity: 0.8;
            background: linear-gradient(transparent 0%, rgba(255,255,255,0.6) 30%, transparent 70%);
        }
        @keyframes rain-fall {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        /* Cloudy */
        .cloud {
            position: absolute;
            top: 10%;
            left: -10%;
            width: 150px;
            height: 70px;
            background: rgba(255,255,255,0.7);
            border-radius: 100px;
            filter: blur(8px);
            animation: cloud-move 15s linear infinite;
            opacity: 0.5;
        }
        .cloud:before, .cloud:after {
            content: '';
            position: absolute;
            background: rgba(255,255,255,0.7);
            border-radius: 50%;
        }
        .cloud:before {
            width: 70px;
            height: 70px;
            top: -30px;
            left: 20px;
        }
        .cloud:after {
            width: 90px;
            height: 90px;
            top: -40px;
            left: 60px;
        }
        @keyframes cloud-move {
            0% { left: -20%; }
            100% { left: 120%; }
        }
        /* Sunny */
        .sun {
            position: absolute;
            top: 10%;
            right: 10%;
            width: 60px;
            height: 60px;
            background: #ffeb3b;
            border-radius: 50%;
            box-shadow: 0 0 40px #ffeb3b;
            animation: sun-pulse 3s infinite alternate;
        }
        @keyframes sun-pulse {
            0% { transform: scale(0.9); opacity: 0.7; }
            100% { transform: scale(1.1); opacity: 1; }
        }
        /* Windy/Stormy */
        .wind {
            position: absolute;
            top: 20%;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: wind-blow 2s linear infinite;
        }
        .wind:nth-child(2) { top: 40%; animation-delay: 0.5s; }
        .wind:nth-child(3) { top: 60%; animation-delay: 1s; }
        @keyframes wind-blow {
            0% { transform: translateX(-100%); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }
        /* Theme animations */
        .theme-animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            overflow: hidden;
        }
        /* Bangladesh flag */
        .flag-bd {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 100px;
            height: 60px;
            background: #006a4e;
            overflow: hidden;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .flag-bd .circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: #f42a41;
            border-radius: 50%;
            animation: flag-wave 0.3s infinite alternate ease-in-out;
        }
        @keyframes flag-wave {
            0% { transform: translate(-50%, -50%) skewX(0deg); }
            100% { transform: translate(-50%, -50%) skewX(3deg); }
        }
        /* Night sky */
        .moon {
            position: absolute;
            top: 20px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: #f5f0d7;
            border-radius: 50%;
            box-shadow: 0 0 30px #fff8e7;
        }
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px white;
            animation: twinkle 1.5s infinite alternate;
        }
        @keyframes twinkle {
            0% { opacity: 0.2; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1.2); }
        }
        /* Language Movement */
        .shaheed-minar {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 80px;
            height: 50px;
            background: #b87333;
            clip-path: polygon(0% 100%, 20% 0%, 40% 100%, 60% 0%, 80% 100%, 100% 0%);
            animation: fade-pulse 2s infinite;
        }
        @keyframes fade-pulse {
            0% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        /* Ramadan */
        .crescent {
            position: absolute;
            top: 15px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: #f9e076;
            border-radius: 50%;
            box-shadow: -10px 0 0 0 #f9e076;
            transform: rotate(25deg);
        }
        .lantern {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 30px;
            height: 40px;
            background: #f39c12;
            border-radius: 50% 50% 30% 30%;
            animation: lantern-sway 2s infinite alternate;
        }
        .lantern:before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 15px;
            background: #f1c40f;
            border-radius: 5px;
        }
        @keyframes lantern-sway {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(5deg); }
        }

        /* ================== TEXT SLIDE ADMIN ================== */
        .text-slide-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        /* ================== IMPORTANT PERSONS GRID ================== */
        .imp-person-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        .imp-person-card {
            background: white;
            border-radius: 16px;
            padding: 12px 5px;
            text-align: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #f1f5f9;
        }
        .imp-person-card:active {
            transform: scale(0.95);
        }
        .imp-person-avatar {
            width: 70px;
            height: 70px;
            margin: 0 auto 8px;
            border-radius: 50%;
            overflow: hidden;
            background: #eff6ff;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--primary);
        }
        .imp-person-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .imp-person-avatar span {
            font-size: 28px;
            color: var(--primary);
        }
        .imp-person-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-main);
        }

        /* ================== USER MODAL LAYOUT FIX (image centered above name) ================== */
        .um-avatar-large {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            border-radius: 50%;
            overflow: hidden;
            background: #eff6ff;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .um-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .um-avatar-large span {
            font-size: 48px;
            color: var(--primary);
        }

        /* ================== MARKET PRICE STYLES ================== */
        .market-price-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        .market-price-card {
            background: white;
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            text-align: center;
            border: 1px solid #e2e8f0;
            transition: transform 0.2s;
        }
        .market-price-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        .market-price-card .commodity-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }
        .market-price-card .price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        .market-price-card .unit {
            font-size: 0.85rem;
            color: var(--text-sub);
            margin-top: 3px;
        }
    </style>
</head>
<body>

    <!-- Splash Screen -->
    <div id="splash">
        <span class="material-icons-round" style="font-size: 70px;">holiday_village</span>
        <div class="splash-text">পারখালী</div>
        <p style="margin:5px 0 10px;">স্মার্ট ভিলেজ অ্যাপ</p>
        <div class="loader"></div>
    </div>

    <!-- Success View -->
    <div id="success-view" class="success-box">
        <div class="check-anim"><span class="material-icons-round">check</span></div>
        <h2 style="color: var(--text-main); margin:0;">অভিনন্দন!</h2>
        <p style="color: var(--text-sub);">অপারেশন সফল হয়েছে</p>
    </div>

    <!-- Toast Message -->
    <div id="toast-message">
        <span class="material-icons-round" id="toast-icon">info</span>
        <span id="toast-text">Message</span>
    </div>

    <!-- Theme Animation Container (for dynamic themes) -->
    <div id="theme-animation" class="theme-animation-container"></div>

    <div class="container">
        <header>
            <div class="header-top">
                <div class="app-title"><span class="material-icons-round">widgets</span> পারখালী</div>
                <div class="datetime-display">
                    <span class="time" id="current-time">--:--:--</span>
                    <span class="date" id="current-date">---, -- --- ----</span>
                </div>
            </div>
            <!-- Premium Text Slider (fixed marquee) - hidden by default, shown only on home -->
            <div id="text-slider-container" class="text-slider hidden">
                <div id="slider-content" class="slider-content" style="color: white;">
                    <!-- Dynamic items will be inserted here as a single text string -->
                </div>
                <div id="slider-placeholder" class="slider-placeholder" style="display: none;">Welcome to Parkhali</div>
            </div>
        </header>

        <main>
            <!-- AUTH VIEW -->
            <div id="view-auth" style="display: none; padding-top: 15px;">
                <div class="card" style="text-align: center;">
                    <h3 id="auth-head" style="color: var(--primary);">লগইন করুন</h3>
                    <input type="email" id="auth-email" class="input-box" placeholder="ইমেইল অ্যাড্রেস">
                    <input type="password" id="auth-pass" class="input-box" placeholder="পাসওয়ার্ড">
                    <button id="auth-action" class="btn btn-primary">লগইন</button>
                    <p style="margin-top: 20px; font-size: 0.9rem;">
                        <span id="auth-hint">অ্যাকাউন্ট নেই?</span> 
                        <b id="auth-toggle" style="color: var(--primary); cursor: pointer;">রেজিস্ট্রেশন করুন</b>
                    </p>
                </div>
            </div>

            <!-- SETUP VIEW (Dynamic Form) -->
            <div id="view-setup" style="display: none;">
                <div class="card">
                    <div class="title-sec">আপনার তথ্য দিন</div>
                    <p style="font-size: 0.85rem; color: var(--text-sub); margin-top:-10px; margin-bottom:15px">গ্রামবাসী তালিকায় যুক্ত হতে সঠিক তথ্য দিন</p>
                    <input id="set-name" class="input-box" placeholder="আপনার পূর্ণ নাম">
                    
                    <!-- Profession Dropdown (added "ডাক্তার") -->
                    <select id="set-prof" class="input-box">
                        <option value="">পেশা নির্বাচন করুন</option>
                        <option value="চাষি">চাষি</option>
                        <option value="ব্যবসায়ী">ব্যবসায়ী</option>
                        <option value="চাকুরিজীবি">চাকুরিজীবি</option>
                        <option value="ড্রাইভার">ড্রাইভার</option>
                        <option value="প্রবাসী">প্রবাসী</option>
                        <option value="ছাত্র">ছাত্র</option>
                        <option value="ডাক্তার">ডাক্তার</option>
                        <option value="অন্যান্য">অন্যান্য</option>
                    </select>
                    
                    <!-- Conditional Fields -->
                    <div id="driver-field" class="conditional-field">
                        <input type="text" id="set-vehicle" class="input-box" placeholder="গাড়ির ধরন (যেমন: ট্রাক, সিএনজি)">
                    </div>
                    <div id="expat-field" class="conditional-field">
                        <input type="text" id="set-country" class="input-box" placeholder="দেশের নাম">
                    </div>
                    <div id="student-field" class="conditional-field">
                        <input type="text" id="set-institution" class="input-box" placeholder="শিক্ষাপ্রতিষ্ঠানের নাম">
                    </div>

                    <select id="set-blood" class="input-box">
                        <option value="">রক্তের গ্রুপ নির্বাচন করুন</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
                    </select>
                    <input type="tel" id="set-phone" class="input-box" placeholder="মোবাইল নম্বর">
                    <!-- Social Media Fields -->
                    <input id="set-facebook" class="input-box" placeholder="Facebook (username বা link)">
                    <input id="set-whatsapp" class="input-box" placeholder="WhatsApp (নম্বর)">
                    <input id="set-telegram" class="input-box" placeholder="Telegram (username)">
                    <input id="set-addr" class="input-box" placeholder="গ্রামের পাড়া/ওয়ার্ড">
                    <div class="file-upload-area" id="setup-upload-area">
                        <input type="file" id="setup-photo" accept="image/*">
                        <span class="material-icons-round">add_photo_alternate</span>
                        <p>প্রোফাইল ছবি (ঐচ্ছিক)</p>
                    </div>
                    <img id="setup-preview" class="image-preview" style="display:none;">
                    <button id="save-setup" class="btn btn-success">সাবমিট করুন <span class="material-icons-round">check_circle</span></button>
                </div>
            </div>

            <!-- HOME VIEW -->
            <div id="view-home" style="display: none;">
                <div class="banner-box" id="banner-slider">
                    <div style="display:flex; justify-content:center; align-items:center; height:100%; color:#94a3b8">লোড হচ্ছে...</div>
                </div>

                <div class="title-sec" style="margin-left: 5px; margin-top: 10px;">এক নজরে গ্রামটি</div>
                <div class="glance-grid">
                    <div class="glance-card" onclick="switchTab('mosque'); loadPlaces('mosques', 'mosque-list')">
                        <span class="material-icons-round" style="color:#0ea5e9; background:#e0f2fe">mosque</span>
                        <span class="glance-title">মসজিদ</span>
                    </div>
                    <div class="glance-card" onclick="switchTab('school'); loadPlaces('schools', 'school-list')">
                        <span class="material-icons-round" style="color:#8b5cf6; background:#ede9fe">school</span>
                        <span class="glance-title">বিদ্যালয়</span>
                    </div>
                    <div class="glance-card" onclick="switchTab('shop'); loadPlaces('shops', 'shop-list')">
                        <span class="material-icons-round" style="color:#f59e0b; background:#fef3c7">storefront</span>
                        <span class="glance-title">দোকান</span>
                    </div>
                    <div class="glance-card" onclick="switchTab('villagers')">
                        <span class="material-icons-round" style="color:#10b981; background:#d1fae5">groups</span>
                        <span class="glance-title">গ্রামবাসী</span>
                    </div>
                    <div class="glance-card" onclick="switchTab('map')">
                        <span class="material-icons-round" style="color:#ef4444; background:#fee2e2">map</span>
                        <span class="glance-title">Map</span>
                    </div>
                    <div class="glance-card" onclick="switchTab('gallery'); loadGallery()">
                        <span class="material-icons-round" style="color:#db2777; background:#fae8ff">photo_library</span>
                        <span class="glance-title">গ্যালারি</span>
                    </div>
                </div>

                <!-- Home Action Row: Sports and Group Chat (deep linking updated) -->
                <div class="home-action-row">
                    <div class="home-action-card" onclick="switchTab('sports')">
                        <span class="material-icons-round">sports_soccer</span>
                        <span class="glance-title">খেলাধুলা</span>
                    </div>
                    <div class="home-action-card" onclick="openMessengerDeepLink()">
                        <span class="material-icons-round">chat</span>
                        <span class="glance-title">গ্রুপ চ্যাট</span>
                    </div>
                </div>

                <div class="card" style="padding: 15px 10px;">
                    <div class="title-sec" style="margin-left: 5px;"><span class="material-icons-round">campaign</span> নোটিশ বোর্ড</div>
                    <div id="notice-list"><p style="text-align:center; color:#94a3b8">লোড হচ্ছে...</p></div>
                </div>
            </div>

            <!-- MOSQUE VIEW -->
            <div id="view-mosque" style="display: none;">
                <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="switchTab('home')">arrow_back</span> গ্রামের মসজিদসমূহ</div>
                <div id="mosque-list"><p style="text-align:center; color:#94a3b8">লোড হচ্ছে...</p></div>
            </div>

            <!-- SCHOOL VIEW -->
            <div id="view-school" style="display: none;">
                <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="switchTab('home')">arrow_back</span> শিক্ষাপ্রতিষ্ঠানসমূহ</div>
                <div id="school-list"><p style="text-align:center; color:#94a3b8">লোড হচ্ছে...</p></div>
            </div>

            <!-- SHOP VIEW -->
            <div id="view-shop" style="display: none;">
                <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="switchTab('home')">arrow_back</span> স্থানীয় বাজার ও দোকান</div>
                <div id="shop-list"><p style="text-align:center; color:#94a3b8">লোড হচ্ছে...</p></div>
            </div>

            <!-- MAP VIEW -->
            <div id="view-map" style="display: none;">
                <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="switchTab('home')">arrow_back</span> গ্রামের ম্যাপ</div>
                <div style="width: 100%; height: 400px; background: #e2e8f0; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow);">
                    <iframe id="map-iframe" src="" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                </div>
            </div>

            <!-- SERVICES VIEW -->
            <div id="view-services" style="display: none;">
                <div class="title-sec" style="margin-bottom: 20px; font-size: 1.2rem;">জনপ্রিয় সেবাসমূহ</div>
                <div class="service-grid">
                    <div class="service-card" onclick="openModal('blood-modal'); loadDonors('All')">
                        <div class="s-icon" style="background:#fee2e2; color:var(--danger)"><span class="material-icons-round">bloodtype</span></div>
                        <b>ব্লাড ডোনার</b>
                    </div>
                    <div class="service-card" onclick="openModal('emergency-modal'); loadEmergencyContacts()">
                        <div class="s-icon" style="background:#ffedd5; color:var(--warning)"><span class="material-icons-round">support_agent</span></div>
                        <b>জরুরী সেবা</b>
                    </div>
                    <div class="service-card" onclick="openModal('agri-modal'); loadAgriInfo()">
                        <div class="s-icon" style="background:#dcfce7; color:var(--accent)"><span class="material-icons-round">agriculture</span></div>
                        <b>কৃষি তথ্য</b>
                    </div>
                    <div class="service-card" onclick="openModal('transport-modal'); loadDrivers()">
                        <div class="s-icon" style="background:#e0f2fe; color:#0284c7"><span class="material-icons-round">local_shipping</span></div>
                        <b>যানবাহন</b>
                    </div>
                    <!-- Weather card -->
                    <div class="service-card" onclick="openModal('weather-modal'); loadWeather()">
                        <div class="s-icon" style="background:#e0f2fe; color:#0284c7"><span class="material-icons-round">wb_sunny</span></div>
                        <b>আবহাওয়া</b>
                    </div>
                    <!-- Ambulance card -->
                    <div class="service-card" onclick="openModal('ambulance-modal'); loadAmbulance()">
                        <div class="s-icon" style="background:#fee2e2; color:var(--danger)"><span class="material-icons-round">local_hospital</span></div>
                        <b>অ্যাম্বুলেন্স</b>
                    </div>
                    <!-- Police card -->
                    <div class="service-card" onclick="openModal('police-modal'); loadPolice()">
                        <div class="s-icon" style="background:#e0f2fe; color:var(--primary)"><span class="material-icons-round">local_police</span></div>
                        <b>পুলিশ</b>
                    </div>
                    <!-- Fire Service card -->
                    <div class="service-card" onclick="openModal('fire-modal'); loadFire()">
                        <div class="s-icon" style="background:#ffedd5; color:var(--warning)"><span class="material-icons-round">fire_truck</span></div>
                        <b>ফায়ার সার্ভিস</b>
                    </div>
                    <!-- NEW: গুরুত্বপূর্ণ ব্যক্তি card -->
                    <div class="service-card" onclick="switchTab('importantpersons')">
                        <div class="s-icon" style="background:#fef9c3; color:#ca8a04"><span class="material-icons-round">star</span></div>
                        <b>গুরুত্বপূর্ণ ব্যক্তি</b>
                    </div>
                    <!-- NEW: ডাক্তার card -->
                    <div class="service-card" onclick="openModal('doctor-modal'); loadDoctors()">
                        <div class="s-icon" style="background:#cffafe; color:#0891b2"><span class="material-icons-round">medical_services</span></div>
                        <b>ডাক্তার</b>
                    </div>
                    <!-- NEW: বাজারদর card -->
                    <div class="service-card" onclick="openModal('market-price-modal'); loadMarketPrices()">
                        <div class="s-icon" style="background:#fef9c3; color:#ca8a04"><span class="material-icons-round">shopping_cart</span></div>
                        <b>বাজারদর</b>
                    </div>
                </div>
            </div>

            <!-- VILLAGERS VIEW -->
            <div id="view-villagers" style="display: none;">
                <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="switchTab('home')">arrow_back</span> গ্রামবাসী তালিকা</div>
                <div style="position: sticky; top: 0; background: var(--bg); padding-bottom: 10px; z-index: 30;">
                    <input type="text" id="search-villager" class="input-box" placeholder="🔍 নাম, নম্বর বা পেশা দিয়ে খুঁজুন..." style="border-radius: 30px; margin: 0;">
                </div>
                <div id="villager-list">
                    <p style="text-align:center; color:#94a3b8">লোড হচ্ছে...</p>
                </div>
            </div>

            <!-- PROFILE VIEW -->
            <div id="view-profile" style="display: none;">
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div class="profile-cover"></div>
                    <div class="profile-avatar-wrapper">
                        <div class="profile-avatar" id="profile-avatar">
                            <img id="profile-avatar-img" src="" style="display:none;">
                            <span id="profile-avatar-icon" class="material-icons-round">person</span>
                        </div>
                        <div class="edit-avatar-btn" id="edit-avatar-btn">
                            <span class="material-icons-round">edit</span>
                        </div>
                    </div>
                    <div class="profile-name">
                        <h3 id="my-name">নাম</h3>
                        <p id="my-role">ইমেইল</p>
                    </div>
                    <div class="info-grid" id="profile-info-grid">
                        <!-- Dynamically filled -->
                    </div>
                    <!-- Social Icons for Profile (brand colors) -->
                    <div class="social-icons" id="profile-social-icons">
                        <a id="profile-facebook" href="#" target="_blank" style="display: none;"><i class="fab fa-facebook"></i></a>
                        <a id="profile-whatsapp" href="#" target="_blank" style="display: none;"><i class="fab fa-whatsapp"></i></a>
                        <a id="profile-telegram" href="#" target="_blank" style="display: none;"><i class="fab fa-telegram"></i></a>
                    </div>
                    <div style="padding: 0 1.2rem 1.2rem;">
                        <button id="profile-logout" class="btn btn-outline" style="color:var(--danger); border-color:var(--danger);"><span class="material-icons-round">logout</span> লগআউট</button>
                    </div>
                </div>
                <div class="card">
                    <div class="title-sec">তথ্য আপডেট</div>
                    <input id="up-name" class="input-box" placeholder="নাম">
                    
                    <!-- Profession dropdown for profile (added "ডাক্তার") -->
                    <select id="up-prof" class="input-box">
                        <option value="">পেশা নির্বাচন করুন</option>
                        <option value="চাষি">চাষি</option>
                        <option value="ব্যবসায়ী">ব্যবসায়ী</option>
                        <option value="চাকুরিজীবি">চাকুরিজীবি</option>
                        <option value="ড্রাইভার">ড্রাইভার</option>
                        <option value="প্রবাসী">প্রবাসী</option>
                        <option value="ছাত্র">ছাত্র</option>
                        <option value="ডাক্তার">ডাক্তার</option>
                        <option value="অন্যান্য">অন্যান্য</option>
                    </select>
                    
                    <!-- Conditional fields in profile -->
                    <div id="up-driver-field" class="conditional-field">
                        <input type="text" id="up-vehicle" class="input-box" placeholder="গাড়ির ধরন">
                    </div>
                    <div id="up-expat-field" class="conditional-field">
                        <input type="text" id="up-country" class="input-box" placeholder="দেশের নাম">
                    </div>
                    <div id="up-student-field" class="conditional-field">
                        <input type="text" id="up-institution" class="input-box" placeholder="শিক্ষাপ্রতিষ্ঠান">
                    </div>

                    <input id="up-phone" class="input-box" placeholder="মোবাইল">
                    <!-- Social Media Fields in Profile Update -->
                    <input id="up-facebook" class="input-box" placeholder="Facebook (username বা link)">
                    <input id="up-whatsapp" class="input-box" placeholder="WhatsApp (নম্বর)">
                    <input id="up-telegram" class="input-box" placeholder="Telegram (username)">
                    <select id="up-blood" class="input-box">
                        <option value="">রক্তের গ্রুপ</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
                    </select>
                    <input id="up-addr" class="input-box" placeholder="ঠিকানা">
                    <input type="file" id="profile-photo" accept="image/*" style="display:none;">
                    <img id="profile-preview" class="image-preview" style="display:none;">
                    <button id="up-btn" class="btn btn-primary">আপডেট করুন</button>
                </div>
            </div>

            <!-- GALLERY VIEW -->
            <div id="view-gallery" style="display: none;">
                <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="switchTab('home')">arrow_back</span> গ্রামের গ্যালারি</div>
                <div id="gallery-grid" class="gallery-grid">
                    <p style="text-align:center; color:#94a3b8">লোড হচ্ছে...</p>
                </div>
            </div>

            <!-- SPORTS VIEW -->
            <div id="view-sports" style="display: none;">
                <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="switchTab('home')">arrow_back</span> খেলাধুলার খবর</div>
                <div id="sports-list" class="sports-grid">
                    <p style="text-align:center; color:#94a3b8">লোড হচ্ছে...</p>
                </div>
            </div>

            <!-- IMPORTANT PERSONS VIEW -->
            <div id="view-importantpersons" style="display: none;">
                <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="switchTab('home')">arrow_back</span> গুরুত্বপূর্ণ ব্যক্তি</div>
                <div id="important-persons-grid" class="imp-person-grid">
                    <p style="text-align:center; color:#94a3b8">লোড হচ্ছে...</p>
                </div>
            </div>

            <!-- ADMIN VIEW -->
            <div id="view-admin" style="display: none;">
                <!-- Admin Main Dashboard -->
                <div id="admin-main">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <div class="admin-stat"><h2 id="st-user" style="margin:0">0</h2><small>Users</small></div>
                        <div class="admin-stat" style="background:var(--accent)"><h2 id="st-note" style="margin:0">0</h2><small>Notices</small></div>
                    </div>

                    <div class="admin-grid">
                        <div class="exampro-card" onclick="openAdminSub('places')">
                            <span class="material-icons-round">domain</span>
                            <span>প্রতিষ্ঠান</span>
                        </div>
                        <div class="exampro-card" onclick="openAdminSub('users')">
                            <span class="material-icons-round">people</span>
                            <span>ইউজার্স</span>
                        </div>
                        <div class="exampro-card" onclick="openAdminSub('notices')">
                            <span class="material-icons-round">campaign</span>
                            <span>নোটিশ</span>
                        </div>
                        <div class="exampro-card" onclick="openAdminSub('banners')">
                            <span class="material-icons-round">view_carousel</span>
                            <span>ব্যানার</span>
                        </div>
                        <div class="exampro-card" onclick="openAdminSub('gallery')">
                            <span class="material-icons-round">photo_library</span>
                            <span>গ্যালারি</span>
                        </div>
                        <div class="exampro-card" onclick="openAdminSub('theme')">
                            <span class="material-icons-round">palette</span>
                            <span>থিম</span>
                        </div>
                        <div class="exampro-card" onclick="openAdminSub('map')">
                            <span class="material-icons-round">map</span>
                            <span>ম্যাপ লিংক</span>
                        </div>
                        <div class="exampro-card" onclick="openAdminSub('sports')">
                            <span class="material-icons-round">sports_volleyball</span>
                            <span>খেলাধুলা</span>
                        </div>
                        <div class="exampro-card" onclick="openAdminSub('blood')">
                            <span class="material-icons-round">bloodtype</span>
                            <span>ব্লাড ডোনার</span>
                        </div>
                        <div class="exampro-card" onclick="openAdminSub('emergency')">
                            <span class="material-icons-round">emergency</span>
                            <span>জরুরী সেবা</span>
                        </div>
                        <div class="exampro-card" onclick="openAdminSub('agri')">
                            <span class="material-icons-round">agriculture</span>
                            <span>কৃষি তথ্য</span>
                        </div>
                        <div class="exampro-card" onclick="openAdminSub('transport')">
                            <span class="material-icons-round">local_shipping</span>
                            <span>যানবাহন</span>
                        </div>
                        <!-- New Admin Cards -->
                        <div class="exampro-card" onclick="openAdminSub('ambulance')">
                            <span class="material-icons-round">local_hospital</span>
                            <span>অ্যাম্বুলেন্স</span>
                        </div>
                        <div class="exampro-card" onclick="openAdminSub('police')">
                            <span class="material-icons-round">local_police</span>
                            <span>পুলিশ</span>
                        </div>
                        <div class="exampro-card" onclick="openAdminSub('fire')">
                            <span class="material-icons-round">fire_truck</span>
                            <span>ফায়ার সার্ভিস</span>
                        </div>
                        <!-- Text Slide Admin Card -->
                        <div class="exampro-card" onclick="openAdminSub('textslide')">
                            <span class="material-icons-round">subtitles</span>
                            <span>টেক্সট স্লাইড</span>
                        </div>
                        <!-- Important Persons Admin Card -->
                        <div class="exampro-card" onclick="openAdminSub('importantpersons')">
                            <span class="material-icons-round">star</span>
                            <span>গুরুত্বপূর্ণ ব্যক্তি</span>
                        </div>
                        <!-- NEW: ডাক্তার Admin Card -->
                        <div class="exampro-card" onclick="openAdminSub('doctors')">
                            <span class="material-icons-round">medical_services</span>
                            <span>ডাক্তার</span>
                        </div>
                        <!-- NEW: বাজারদর Admin Card -->
                        <div class="exampro-card" onclick="openAdminSub('marketprice')">
                            <span class="material-icons-round">shopping_cart</span>
                            <span>বাজারদর</span>
                        </div>
                    </div>
                </div>

                <!-- Admin Sub: Places (updated with map link and edit) -->
                <div id="admin-sub-places" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> প্রতিষ্ঠান/স্থান যোগ করুন</div>
                    <div class="card">
                        <select id="ap-col" class="input-box">
                            <option value="mosques">মসজিদ</option>
                            <option value="schools">বিদ্যালয়</option>
                            <option value="shops">দোকান</option>
                        </select>
                        <input id="ap-name" class="input-box" placeholder="প্রতিষ্ঠানের নাম">
                        <textarea id="ap-desc" class="input-box" rows="2" placeholder="বিস্তারিত/ঠিকানা"></textarea>
                        <!-- NEW: Map Link Field -->
                        <input id="ap-map-link" class="input-box" placeholder="গুগল ম্যাপ লিংক (URL)">
                        <div class="file-upload-area" id="ap-upload-area">
                            <input type="file" id="ap-image" accept="image/*">
                            <span class="material-icons-round">add_photo_alternate</span>
                            <p>ছবি আপলোড (ঐচ্ছিক)</p>
                        </div>
                        <img id="ap-preview" class="image-preview" style="display:none;">
                        <button id="ap-btn" class="btn btn-primary" style="background:var(--accent)">যুক্ত করুন</button>
                        
                        <hr style="border:0; border-top:1px solid #e2e8f0; margin:15px 0">
                        <div class="title-sec" style="font-size:1rem">তালিকা ম্যানেজমেন্ট</div>
                        <select id="ad-view-col" class="input-box" onchange="loadAdminPlaces()">
                            <option value="mosques">মসজিদ তালিকা</option>
                            <option value="schools">বিদ্যালয় তালিকা</option>
                            <option value="shops">দোকান তালিকা</option>
                        </select>
                        <div id="admin-places-list" style="max-height: 250px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Admin Sub: Users (unchanged) -->
                <div id="admin-sub-users" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> ইউজার কন্ট্রোল</div>
                    <div class="card">
                        <input id="au-search" class="input-box" placeholder="নাম, ফোন, পেশা দিয়ে খুঁজুন...">
                        <div id="admin-users" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Admin Sub: Notices (unchanged) -->
                <div id="admin-sub-notices" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> নোটিশ ম্যানেজমেন্ট</div>
                    <div class="card">
                        <input id="an-title" class="input-box" placeholder="শিরোনাম">
                        <textarea id="an-desc" class="input-box" rows="2" placeholder="বিস্তারিত"></textarea>
                        <div class="file-upload-area" id="an-upload-area">
                            <input type="file" id="an-image" accept="image/*">
                            <span class="material-icons-round">add_photo_alternate</span>
                            <p>ছবি আপলোড (ঐচ্ছিক)</p>
                        </div>
                        <img id="an-preview" class="image-preview" style="display:none;">
                        <button id="an-btn" class="btn btn-primary">পাবলিশ করুন</button>
                        
                        <hr style="border:0; border-top:1px solid #e2e8f0; margin:15px 0">
                        <div class="title-sec" style="font-size:1rem">সকল নোটিশ</div>
                        <div id="admin-notices-list" style="max-height: 250px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Admin Sub: Banners (unchanged) -->
                <div id="admin-sub-banners" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> ব্যানার ম্যানেজমেন্ট</div>
                    <div class="card">
                        <div class="file-upload-area" id="banner-upload-area">
                            <input type="file" id="banner-image" accept="image/*">
                            <span class="material-icons-round">add_photo_alternate</span>
                            <p>ব্যানার ছবি নির্বাচন করুন</p>
                        </div>
                        <img id="banner-preview" class="image-preview" style="display:none;">
                        <input id="ab-link" class="input-box" placeholder="লিঙ্ক URL (ঐচ্ছিক)">
                        <button id="ab-btn" class="btn btn-primary" style="background:#db2777">ব্যানার যোগ করুন</button>
                        <div id="admin-banners" style="margin-top: 15px; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Admin Sub: Gallery (unchanged) -->
                <div id="admin-sub-gallery" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> গ্যালারি ম্যানেজমেন্ট</div>
                    <div class="card">
                        <div class="file-upload-area" id="gallery-upload-area">
                            <input type="file" id="gallery-upload" accept="image/*" multiple>
                            <span class="material-icons-round">add_photo_alternate</span>
                            <p>একাধিক ছবি আপলোড করুন</p>
                        </div>
                        <button id="gallery-upload-btn" class="btn btn-primary" style="background:var(--accent); margin-top:10px;">আপলোড শুরু করুন</button>
                        <div id="admin-gallery-list" style="margin-top: 15px; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Admin Sub: Theme (unchanged) -->
                <div id="admin-sub-theme" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> থিম কাস্টমাইজার</div>
                    <div class="card">
                        <p style="color:var(--text-sub); margin-bottom:15px;">আপনার পছন্দের থিম নির্বাচন করুন</p>
                        <div class="theme-grid" id="theme-grid">
                            <!-- Dynamically filled -->
                        </div>
                        <button id="save-theme-btn" class="btn btn-success" style="margin-top:15px;">থিম সংরক্ষণ করুন</button>
                    </div>
                </div>

                <!-- Admin Sub: Map link (unchanged) -->
                <div id="admin-sub-map" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> ম্যাপ লিংক সেটিংস</div>
                    <div class="card">
                        <p>গুগল ম্যাপ এম্বেড URL দিন</p>
                        <input id="map-link-input" class="input-box" placeholder="https://www.google.com/maps/embed?pb=...">
                        <button id="save-map-link" class="btn btn-primary">সংরক্ষণ করুন</button>
                        <p class="hint" style="font-size:0.8rem; color:var(--text-sub); margin-top:8px;">বর্তমান লিংক: <span id="current-map-link"></span></p>
                    </div>
                </div>

                <!-- Admin Sub: Sports (unchanged) -->
                <div id="admin-sub-sports" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> খেলাধুলা ম্যানেজমেন্ট</div>
                    <div class="card">
                        <input id="sports-title" class="input-box" placeholder="শিরোনাম">
                        <textarea id="sports-desc" class="input-box" rows="2" placeholder="বিস্তারিত"></textarea>
                        <div class="file-upload-area" id="sports-upload-area">
                            <input type="file" id="sports-image" accept="image/*">
                            <span class="material-icons-round">add_photo_alternate</span>
                            <p>ছবি আপলোড (ঐচ্ছিক)</p>
                        </div>
                        <img id="sports-preview" class="image-preview" style="display:none;">
                        <button id="sports-add-btn" class="btn btn-primary" style="background:var(--accent)">পোস্ট করুন</button>
                        
                        <hr style="border:0; border-top:1px solid #e2e8f0; margin:15px 0">
                        <div class="title-sec" style="font-size:1rem">সকল পোস্ট</div>
                        <div id="admin-sports-list" style="max-height: 250px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Admin Sub: Blood Donor Management (unchanged) -->
                <div id="admin-sub-blood" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> ব্লাড ডোনার ম্যানেজমেন্ট</div>
                    <div class="card">
                        <input id="abd-name" class="input-box" placeholder="নাম">
                        <select id="abd-group" class="input-box">
                            <option value="">রক্তের গ্রুপ</option>
                            <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                            <option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
                        </select>
                        <input id="abd-phone" class="input-box" placeholder="মোবাইল নম্বর">
                        <button id="abd-add" class="btn btn-success">ডোনার যোগ করুন</button>
                        
                        <hr>
                        <div class="title-sec">বর্তমান ডোনার তালিকা</div>
                        <div id="admin-blood-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Admin Sub: Emergency Services Management (unchanged) -->
                <div id="admin-sub-emergency" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> জরুরী সেবা ম্যানেজমেন্ট</div>
                    <div class="card">
                        <input id="aem-name" class="input-box" placeholder="নাম (যেমন: ইউনিয়ন চেয়ারম্যান)">
                        <input id="aem-phone" class="input-box" placeholder="ফোন নম্বর">
                        <button id="aem-add" class="btn btn-success">যোগ করুন</button>
                        
                        <hr>
                        <div class="title-sec">বর্তমান সেবা তালিকা</div>
                        <div id="admin-emergency-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Admin Sub: Agriculture Information Management (unchanged) -->
                <div id="admin-sub-agri" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> কৃষি তথ্য ম্যানেজমেন্ট</div>
                    <div class="card">
                        <input id="aag-title" class="input-box" placeholder="শিরোনাম (যেমন: ধানের চারা)">
                        <textarea id="aag-desc" class="input-box" rows="2" placeholder="বিস্তারিত"></textarea>
                        <input id="aag-contact" class="input-box" placeholder="যোগাযোগ (ঐচ্ছিক)">
                        <button id="aag-add" class="btn btn-success">যোগ করুন</button>
                        
                        <hr>
                        <div class="title-sec">তথ্য তালিকা</div>
                        <div id="admin-agri-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Admin Sub: Transport/Driver Management (unchanged) -->
                <div id="admin-sub-transport" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> যানবাহন ম্যানেজমেন্ট</div>
                    <div class="card">
                        <input id="ad-name" class="input-box" placeholder="ড্রাইভারের নাম">
                        <input id="ad-phone" class="input-box" placeholder="মোবাইল নম্বর">
                        <input id="ad-vehicle" class="input-box" placeholder="গাড়ির ধরন (ট্রাক/সিএনজি/অটো)">
                        <div class="file-upload-area" id="ad-upload-area">
                            <input type="file" id="ad-photo" accept="image/*">
                            <span class="material-icons-round">add_photo_alternate</span>
                            <p>প্রোফাইল ছবি (ঐচ্ছিক)</p>
                        </div>
                        <img id="ad-preview" class="image-preview" style="display:none;">
                        <button id="ad-add" class="btn btn-success">ড্রাইভার যোগ করুন</button>
                        
                        <hr>
                        <div class="title-sec">ড্রাইভার তালিকা</div>
                        <input id="admin-driver-search" class="input-box" placeholder="🔍 নাম, নম্বর বা গাড়ির ধরন">
                        <div id="admin-driver-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Admin Sub: Ambulance Management (unchanged) -->
                <div id="admin-sub-ambulance" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> অ্যাম্বুলেন্স ম্যানেজমেন্ট</div>
                    <div class="card">
                        <input id="aamb-name" class="input-box" placeholder="নাম (যেমন: সিটি অ্যাম্বুলেন্স)">
                        <input id="aamb-phone" class="input-box" placeholder="ফোন নম্বর">
                        <button id="aamb-add" class="btn btn-success">যোগ করুন</button>
                        <hr>
                        <div class="title-sec">বর্তমান তালিকা</div>
                        <div id="admin-ambulance-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Admin Sub: Police Management (unchanged) -->
                <div id="admin-sub-police" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> পুলিশ ম্যানেজমেন্ট</div>
                    <div class="card">
                        <input id="apol-name" class="input-box" placeholder="নাম (যেমন: থানা)">
                        <input id="apol-phone" class="input-box" placeholder="ফোন নম্বর">
                        <button id="apol-add" class="btn btn-success">যোগ করুন</button>
                        <hr>
                        <div class="title-sec">বর্তমান তালিকা</div>
                        <div id="admin-police-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Admin Sub: Fire Service Management (unchanged) -->
                <div id="admin-sub-fire" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> ফায়ার সার্ভিস ম্যানেজমেন্ট</div>
                    <div class="card">
                        <input id="afire-name" class="input-box" placeholder="নাম (যেমন: ফায়ার স্টেশন)">
                        <input id="afire-phone" class="input-box" placeholder="ফোন নম্বর">
                        <button id="afire-add" class="btn btn-success">যোগ করুন</button>
                        <hr>
                        <div class="title-sec">বর্তমান তালিকা</div>
                        <div id="admin-fire-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Admin Sub: Text Slide Management (updated with color picker) -->
                <div id="admin-sub-textslide" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> টেক্সট স্লাইড ম্যানেজমেন্ট</div>
                    <div class="card">
                        <input id="ts-text" class="input-box" placeholder="স্লাইডের টেক্সট লিখুন">
                        <button id="ts-add" class="btn btn-success">টেক্সট যোগ করুন</button>
                        <hr>
                        <!-- NEW: Color picker for sliding text -->
                        <div class="title-sec">টেক্সট রঙ নির্বাচন করুন</div>
                        <input type="color" id="ts-color" class="input-box" value="#ffffff" style="height: 50px; padding: 5px;">
                        <button id="ts-save-color" class="btn btn-primary">রঙ সংরক্ষণ করুন</button>
                        <hr>
                        <div class="title-sec">বর্তমান টেক্সট সমূহ</div>
                        <div id="admin-textslide-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Admin Sub: Important Persons Management (unchanged) -->
                <div id="admin-sub-importantpersons" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> গুরুত্বপূর্ণ ব্যক্তি ম্যানেজমেন্ট</div>
                    <div class="card">
                        <input id="ip-name" class="input-box" placeholder="নাম">
                        <input id="ip-phone" class="input-box" placeholder="মোবাইল নম্বর (ঐচ্ছিক)">
                        <textarea id="ip-desc" class="input-box" rows="2" placeholder="বিস্তারিত (পদবী, পরিচিতি)"></textarea>
                        <div class="file-upload-area" id="ip-upload-area">
                            <input type="file" id="ip-image" accept="image/*">
                            <span class="material-icons-round">add_photo_alternate</span>
                            <p>ছবি আপলোড (ঐচ্ছিক)</p>
                        </div>
                        <img id="ip-preview" class="image-preview" style="display:none;">
                        <button id="ip-add" class="btn btn-success">যোগ করুন</button>
                        <hr>
                        <div class="title-sec">বর্তমান তালিকা</div>
                        <div id="admin-importantpersons-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- NEW Admin Sub: Doctors Management -->
                <div id="admin-sub-doctors" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> ডাক্তার ম্যানেজমেন্ট</div>
                    <div class="card">
                        <input id="doc-name" class="input-box" placeholder="নাম">
                        <input id="doc-phone" class="input-box" placeholder="মোবাইল নম্বর">
                        <div class="file-upload-area" id="doc-upload-area">
                            <input type="file" id="doc-image" accept="image/*">
                            <span class="material-icons-round">add_photo_alternate</span>
                            <p>প্রোফাইল ছবি (ঐচ্ছিক)</p>
                        </div>
                        <img id="doc-preview" class="image-preview" style="display:none;">
                        <button id="doc-add" class="btn btn-success">ডাক্তার যোগ করুন</button>
                        <hr>
                        <div class="title-sec">ডাক্তার তালিকা</div>
                        <input id="admin-doctor-search" class="input-box" placeholder="🔍 নাম বা নম্বর দিয়ে খুঁজুন">
                        <div id="admin-doctor-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- NEW Admin Sub: Market Price Management -->
                <div id="admin-sub-marketprice" style="display:none;">
                    <div class="title-sec"><span class="material-icons-round" style="cursor:pointer; margin-right:5px" onclick="closeAdminSub()">arrow_back</span> বাজারদর ম্যানেজমেন্ট</div>
                    <div class="card">
                        <input id="mp-commodity" class="input-box" placeholder="পণ্যের নাম (যেমন: চাল)">
                        <input id="mp-price" class="input-box" type="number" placeholder="মূল্য">
                        <input id="mp-unit" class="input-box" placeholder="একক (যেমন: কেজি)">
                        <button id="mp-add" class="btn btn-success">পণ্য যোগ করুন</button>
                        <hr>
                        <div class="title-sec">বর্তমান বাজারদর</div>
                        <div id="admin-marketprice-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav" id="b-nav">
            <div class="nav-btn active" id="tab-home"><span class="material-icons-round" style="font-size:26px">home</span>হোম</div>
            <div class="nav-btn" id="tab-services"><div class="nav-center"><span class="material-icons-round" style="font-size:30px">grid_view</span></div></div>
            <div class="nav-btn" id="tab-admin" style="display: none;"><span class="material-icons-round" style="font-size:26px">admin_panel_settings</span>অ্যাডমিন</div>
            <div class="nav-btn" id="tab-profile"><span class="material-icons-round" style="font-size:26px">person</span>প্রোফাইল</div>
        </nav>

        <!-- MODALS -->

        <!-- User Detail Modal -->
        <div id="user-modal" class="modal-bg" onclick="if(event.target===this) closeModal('user-modal')">
            <div class="modal-content" style="text-align: center;">
                <span class="material-icons-round close-icon" onclick="closeModal('user-modal')">close</span>
                <!-- Large avatar centered above name -->
                <div class="um-avatar-large" id="um-av-large" onclick="openImageLightbox(getAvatarUrl())">
                    <img id="um-av-img" src="" style="display:none;">
                    <span id="um-av-text">A</span>
                </div>
                <h3 id="um-name" style="margin: 10px 0 5px;">Name</h3>
                <p id="um-role" style="color:var(--text-sub); margin: 0 0 15px;">Role</p>
                <div style="background:#f8fafc; padding:15px; border-radius:12px; text-align:left; font-size:0.95rem;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px"><span>মোবাইল:</span><b id="um-phone">-</b></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px"><span>রক্তের গ্রুপ:</span><b id="um-blood" style="color:var(--danger)">-</b></div>
                    <div style="display:flex; justify-content:space-between"><span>ঠিকানা:</span><b id="um-addr">-</b></div>
                </div>
                <!-- Social Icons in User Modal (brand colors) -->
                <div class="social-icons" style="justify-content: center; margin-top: 15px;">
                    <a id="um-facebook" href="#" target="_blank" style="display: none;"><i class="fab fa-facebook"></i></a>
                    <a id="um-whatsapp" href="#" target="_blank" style="display: none;"><i class="fab fa-whatsapp"></i></a>
                    <a id="um-telegram" href="#" target="_blank" style="display: none;"><i class="fab fa-telegram"></i></a>
                </div>
                <a id="um-call" href="#" class="btn btn-success" style="margin-top: 15px; text-decoration: none;"><span class="material-icons-round">call</span> সরাসরি কল করুন</a>
            </div>
        </div>

        <!-- Place Detail Modal (updated with map button) -->
        <div id="place-modal" class="modal-bg" onclick="if(event.target===this) closeModal('place-modal')">
            <div class="modal-content">
                <span class="material-icons-round close-icon" onclick="closeModal('place-modal')">close</span>
                <img id="place-modal-img" src="" style="width:100%; max-height:200px; object-fit:cover; border-radius:12px; margin-bottom:10px;">
                <h3 id="place-modal-name" style="margin:0 0 5px;"></h3>
                <p id="place-modal-desc" style="color:var(--text-sub); margin-bottom: 15px;"></p>
                <!-- NEW: Map Button -->
                <a id="place-modal-map" href="#" target="_blank" class="btn btn-primary" style="display: none; text-decoration: none; margin-bottom: 10px;"><span class="material-icons-round">map</span> গুগল ম্যাপে দেখুন</a>
            </div>
        </div>

        <!-- Blood Modal (unchanged) -->
        <div id="blood-modal" class="modal-bg" onclick="if(event.target===this) closeModal('blood-modal')">
            <div class="modal-content">
                <span class="material-icons-round close-icon" onclick="closeModal('blood-modal')">close</span>
                <h3 style="color:var(--danger); margin:0 0 15px;"><span class="material-icons-round" style="vertical-align:middle">bloodtype</span> রক্তদাতা</h3>
                <div style="background:#fef2f2; padding:12px; border-radius:12px; margin-bottom:15px;">
                    <input id="bd-name" class="input-box" placeholder="নাম" style="margin-bottom:8px">
                    <select id="bd-grp" class="input-box" style="margin-bottom:8px"><option value="">গ্রুপ...</option><option>A+</option><option>B+</option><option>O+</option><option>AB+</option><option>A-</option><option>B-</option><option>O-</option><option>AB-</option></select>
                    <input id="bd-phone" type="tel" class="input-box" placeholder="মোবাইল" style="margin-bottom:8px">
                    <button id="bd-add" class="btn btn-primary" style="background:var(--danger); padding:10px">যুক্ত করুন</button>
                </div>
                <select id="bd-filter" class="input-box" onchange="loadDonors(this.value)"><option value="All">সকল গ্রুপের তালিকা</option><option>A+</option><option>B+</option><option>O+</option><option>AB+</option><option>A-</option><option>B-</option><option>O-</option><option>AB-</option></select>
                <div id="bd-list" style="max-height: 250px; overflow-y:auto"></div>
            </div>
        </div>

        <!-- Emergency Modal (unchanged) -->
        <div id="emergency-modal" class="modal-bg" onclick="if(event.target===this) closeModal('emergency-modal')">
            <div class="modal-content">
                <span class="material-icons-round close-icon" onclick="closeModal('emergency-modal')">close</span>
                <h3 style="color:var(--warning); margin:0 0 15px;">☎️ জরুরী সেবা</h3>
                <div id="emergency-list"></div>
            </div>
        </div>

        <!-- Agri Modal (unchanged) -->
        <div id="agri-modal" class="modal-bg" onclick="if(event.target===this) closeModal('agri-modal')">
            <div class="modal-content">
                <span class="material-icons-round close-icon" onclick="closeModal('agri-modal')">close</span>
                <h3 style="color:var(--accent); margin:0 0 15px;">🌾 কৃষি তথ্য</h3>
                <div id="agri-list"></div>
            </div>
        </div>

        <!-- Transport Modal (unchanged) -->
        <div id="transport-modal" class="modal-bg" onclick="if(event.target===this) closeModal('transport-modal')">
            <div class="modal-content">
                <span class="material-icons-round close-icon" onclick="closeModal('transport-modal')">close</span>
                <h3 style="color:#0284c7; margin:0 0 15px;">🚛 যানবাহন ও ড্রাইভার</h3>
                <input type="text" id="driver-search" class="input-box" placeholder="🔍 নাম, নম্বর বা গাড়ির ধরন খুঁজুন..." style="border-radius: 30px;">
                <div id="driver-list" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- Weather Modal (unchanged) -->
        <div id="weather-modal" class="modal-bg" onclick="if(event.target===this) closeModal('weather-modal')">
            <div class="modal-content" style="max-width: 500px;">
                <span class="material-icons-round close-icon" onclick="closeModal('weather-modal')">close</span>
                <h3 style="margin:0 0 10px; color:var(--primary);">🌤️ পারখালীর আবহাওয়া</h3>
                <div id="weather-loading" style="text-align:center;">লোড হচ্ছে...</div>
                <div id="weather-content" style="display:none;">
                    <!-- Large Today/Tomorrow Card -->
                    <div id="weather-large" class="weather-large-card">
                        <div id="weather-animation" class="weather-animation"></div>
                        <h3>আজ</h3>
                        <div id="weather-today" class="weather-temp-today">--°C</div>
                        <div id="weather-today-condition"></div>
                        <div style="margin-top: 15px;">
                            <h4>আগামীকাল</h4>
                            <div id="weather-tomorrow" class="weather-temp-tomorrow">--°C</div>
                            <div id="weather-tomorrow-condition"></div>
                        </div>
                    </div>
                    <div class="title-sec" style="margin-bottom: 10px;">১০ দিনের পূর্বাভাস</div>
                    <div id="weather-forecast" style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- Ambulance Modal (unchanged) -->
        <div id="ambulance-modal" class="modal-bg" onclick="if(event.target===this) closeModal('ambulance-modal')">
            <div class="modal-content">
                <span class="material-icons-round close-icon" onclick="closeModal('ambulance-modal')">close</span>
                <h3 style="color:var(--danger); margin:0 0 15px;">🚑 অ্যাম্বুলেন্স</h3>
                <div id="ambulance-list" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- Police Modal (unchanged) -->
        <div id="police-modal" class="modal-bg" onclick="if(event.target===this) closeModal('police-modal')">
            <div class="modal-content">
                <span class="material-icons-round close-icon" onclick="closeModal('police-modal')">close</span>
                <h3 style="color:var(--primary); margin:0 0 15px;">👮 পুলিশ</h3>
                <div id="police-list" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- Fire Service Modal (unchanged) -->
        <div id="fire-modal" class="modal-bg" onclick="if(event.target===this) closeModal('fire-modal')">
            <div class="modal-content">
                <span class="material-icons-round close-icon" onclick="closeModal('fire-modal')">close</span>
                <h3 style="color:var(--warning); margin:0 0 15px;">🔥 ফায়ার সার্ভিস</h3>
                <div id="fire-list" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- Image Lightbox Modal (unchanged) -->
        <div id="image-lightbox-modal" class="modal-bg" onclick="if(event.target===this) closeModal('image-lightbox-modal')">
            <div class="modal-content" style="text-align: center; background: transparent; box-shadow: none; max-width: 90%;">
                <span class="material-icons-round close-icon" onclick="closeModal('image-lightbox-modal')" style="background: rgba(255,255,255,0.5); color: black;">close</span>
                <img id="lightbox-img" src="" style="max-width: 100%; max-height: 80vh; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
            </div>
        </div>

        <!-- Gallery Image Modal (unchanged) -->
        <div id="gallery-modal" class="modal-bg" onclick="if(event.target===this) closeModal('gallery-modal')">
            <div class="modal-content" style="text-align: center;">
                <span class="material-icons-round close-icon" onclick="closeModal('gallery-modal')">close</span>
                <h3 style="margin:0 0 10px; color:var(--text-main); text-align: left;">ছবি দেখুন</h3>
                <img id="gallery-modal-img" src="" style="width:100%; max-height:50vh; object-fit:contain; border-radius:12px; margin-bottom:15px; background: #f8fafc;">
                <a id="gallery-modal-download" href="#" class="btn btn-success" style="text-decoration: none; display: flex; justify-content: center; gap: 8px;">
                    <span class="material-icons-round">download</span> ডাউনলোড করুন
                </a>
            </div>
        </div>

        <!-- Notice Detail Modal (unchanged) -->
        <div id="notice-detail-modal" class="modal-bg" onclick="if(event.target===this) closeModal('notice-detail-modal')">
            <div class="modal-content" style="text-align: center;">
                <span class="material-icons-round close-icon" onclick="closeModal('notice-detail-modal')">close</span>
                <h3 id="notice-modal-title" style="margin:0 0 10px; color:var(--primary);"></h3>
                <img id="notice-modal-img" src="" style="width:100%; max-height:250px; object-fit:contain; border-radius:12px; margin-bottom:15px; background:#f8fafc; display:none;">
                <p id="notice-modal-desc" style="color:var(--text-main); font-size:1rem; text-align:left;"></p>
            </div>
        </div>

        <!-- Important Person Detail Modal (unchanged) -->
        <div id="important-person-modal" class="modal-bg" onclick="if(event.target===this) closeModal('important-person-modal')">
            <div class="modal-content" style="text-align: center;">
                <span class="material-icons-round close-icon" onclick="closeModal('important-person-modal')">close</span>
                <div class="um-avatar-large" id="ipm-av-large">
                    <img id="ipm-av-img" src="" style="display:none;">
                    <span id="ipm-av-text">A</span>
                </div>
                <h3 id="ipm-name" style="margin: 10px 0 5px;"></h3>
                <p id="ipm-desc" style="color:var(--text-sub); margin: 0 0 15px;"></p>
                <div style="background:#f8fafc; padding:15px; border-radius:12px; text-align:left; font-size:0.95rem;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px"><span>মোবাইল:</span><b id="ipm-phone">-</b></div>
                </div>
                <a id="ipm-call" href="#" class="btn btn-success" style="margin-top: 15px; text-decoration: none;"><span class="material-icons-round">call</span> কল করুন</a>
            </div>
        </div>

        <!-- NEW: Doctor Modal -->
        <div id="doctor-modal" class="modal-bg" onclick="if(event.target===this) closeModal('doctor-modal')">
            <div class="modal-content">
                <span class="material-icons-round close-icon" onclick="closeModal('doctor-modal')">close</span>
                <h3 style="color:#0891b2; margin:0 0 15px;"><span class="material-icons-round">medical_services</span> ডাক্তার তালিকা</h3>
                <input type="text" id="doctor-search" class="input-box" placeholder="🔍 নাম বা নম্বর দিয়ে খুঁজুন..." style="border-radius: 30px;">
                <div id="doctor-list" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- NEW: Market Price Modal -->
        <div id="market-price-modal" class="modal-bg" onclick="if(event.target===this) closeModal('market-price-modal')">
            <div class="modal-content">
                <span class="material-icons-round close-icon" onclick="closeModal('market-price-modal')">close</span>
                <h3 style="color:#ca8a04; margin:0 0 15px;"><span class="material-icons-round">shopping_cart</span> বাজারদর</h3>
                <div id="market-price-grid" class="market-price-grid">
                    <!-- Dynamically filled -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, doc, setDoc, updateDoc, deleteDoc, query, orderBy, serverTimestamp, enableIndexedDbPersistence, where, writeBatch, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = { apiKey: "AIzaSyAuqcDRrtuQi2tdWXA2E_UWyq7pCrGpoy4", authDomain: "parkhali-village.firebaseapp.com", projectId: "parkhali-village" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app); const adminEmail = "admin@parkhali.com";

        // Enable offline persistence
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.log('Persistence failed: multiple tabs open');
            } else if (err.code == 'unimplemented') {
                console.log('Persistence not supported');
            }
        });

        // Cloudinary config
        const CLOUD_NAME = "dwnpdwnvc";
        const UPLOAD_PRESET = "parkhali";

        // ========== GLOBAL TOAST TIMEOUT ==========
        let toastTimeout;

        // ========== TOAST & LOADING ==========
        function showToast(message, icon = 'check_circle', duration = 3000) {
            const toast = document.getElementById('toast-message');
            document.getElementById('toast-icon').innerText = icon;
            document.getElementById('toast-text').innerText = message;
            toast.classList.add('show');
            
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => toast.classList.remove('show'), duration);
        }

        function showLoading(btn) {
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-small"></span> প্রসেসিং...';
            return () => {
                btn.disabled = false;
                btn.innerText = originalText;
            };
        }

        function showSuccessFull() {
            const s = document.getElementById('success-view');
            s.style.display = 'flex';
            setTimeout(() => s.style.display = 'none', 2000);
        }

        // ========== CLOUDINARY UPLOAD ==========
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: "POST", body: formData });
            const data = await res.json();
            return data.secure_url;
        }

        // ========== MODAL CONTROLS ==========
        window.openModal = (id) => { const m=document.getElementById(id); m.style.display='flex'; setTimeout(()=>m.classList.add('show'), 10); }
        window.closeModal = (id) => { const m=document.getElementById(id); m.classList.remove('show'); setTimeout(()=>m.style.display='none', 300); }

        // ========== IMAGE LIGHTBOX (for avatar zoom) ==========
        function openImageLightbox(imgUrl) {
            if (!imgUrl) return;
            document.getElementById('lightbox-img').src = imgUrl;
            openModal('image-lightbox-modal');
        }
        window.openImageLightbox = openImageLightbox;

        // Helper to get avatar URL from current user modal
        function getAvatarUrl() {
            const img = document.getElementById('um-av-img');
            if (img.style.display !== 'none' && img.src) return img.src;
            return null;
        }

        // ========== THEME MANAGEMENT (unchanged) ==========
        const themes = [
            { name: 'নীল', primary: '#2563eb', accent: '#10b981', grad: 'linear-gradient(135deg, #2563eb, #0891b2)', themeClass: '' },
            { name: 'সবুজ', primary: '#059669', accent: '#f59e0b', grad: 'linear-gradient(135deg, #059669, #10b981)', themeClass: '' },
            { name: 'লাল', primary: '#dc2626', accent: '#f97316', grad: 'linear-gradient(135deg, #dc2626, #f97316)', themeClass: '' },
            { name: 'বেগুনি', primary: '#7c3aed', accent: '#ec4899', grad: 'linear-gradient(135deg, #7c3aed, #ec4899)', themeClass: '' },
            { name: 'কমলা', primary: '#ea580c', accent: '#eab308', grad: 'linear-gradient(135deg, #ea580c, #eab308)', themeClass: '' },
            { name: 'পিংক', primary: '#db2777', accent: '#7c3aed', grad: 'linear-gradient(135deg, #db2777, #7c3aed)', themeClass: '' },
            { name: 'ভাষা দিবস', primary: '#b45309', accent: '#f59e0b', grad: 'linear-gradient(135deg, #b45309, #fbbf24)', themeClass: '' },
            { name: 'স্বাধীনতা দিবস', primary: '#b91c1c', accent: '#16a34a', grad: 'linear-gradient(135deg, #b91c1c, #16a34a)', themeClass: '' },
            { name: 'বিজয় দিবস', primary: '#1e3a8a', accent: '#059669', grad: 'linear-gradient(135deg, #1e3a8a, #059669)', themeClass: '' },
            { name: 'রামাদান', primary: '#2c3e50', accent: '#f1c40f', grad: 'linear-gradient(135deg, #2c3e50, #f1c40f)', themeClass: 'ramadan-theme' },
            { name: 'ঈদ', primary: '#16a34a', accent: '#fbbf24', grad: 'linear-gradient(135deg, #16a34a, #fbbf24)', themeClass: '' },
            { name: 'নিউ ইয়ার', primary: '#6b21a8', accent: '#eab308', grad: 'linear-gradient(135deg, #6b21a8, #eab308)', themeClass: '' },
            { name: 'শীত', primary: '#0f172a', accent: '#38bdf8', grad: 'linear-gradient(135deg, #0f172a, #38bdf8)', themeClass: '' },
            { name: 'গ্রীষ্ম', primary: '#c2410c', accent: '#fde047', grad: 'linear-gradient(135deg, #c2410c, #fde047)', themeClass: '' },
            { name: 'বর্ষা', primary: '#0284c7', accent: '#22c55e', grad: 'linear-gradient(135deg, #0284c7, #22c55e)', themeClass: '' },
            { name: 'বাংলাদেশ', primary: '#006a4e', accent: '#f42a41', grad: 'linear-gradient(135deg, #006a4e, #f42a41)', themeClass: 'bangladesh-theme' },
            { name: 'নাইট স্কাই', primary: '#0f172a', accent: '#38bdf8', grad: 'linear-gradient(135deg, #0f172a, #1e293b)', themeClass: 'night-theme' },
            { name: 'একুশে ফেব্রুয়ারি', primary: '#b91c1c', accent: '#f59e0b', grad: 'linear-gradient(135deg, #b91c1c, #f97316)', themeClass: 'language-theme' },
            { name: 'রমজান', primary: '#2c3e50', accent: '#f1c40f', grad: 'linear-gradient(135deg, #2c3e50, #f39c12)', themeClass: 'ramadan-theme' }
        ];

        async function loadTheme() {
            const themeDoc = await getDoc(doc(db, "settings", "appearance"));
            if (themeDoc.exists()) {
                const t = themeDoc.data();
                applyTheme(t);
            } else {
                applyTheme(themes[0]);
            }
        }

        function applyTheme(theme) {
            document.documentElement.style.setProperty('--primary', theme.primary);
            document.documentElement.style.setProperty('--accent', theme.accent);
            document.documentElement.style.setProperty('--header-grad', theme.grad);
            
            const animContainer = document.getElementById('theme-animation');
            animContainer.innerHTML = '';
            if (theme.themeClass === 'bangladesh-theme') {
                animContainer.innerHTML = '<div class="flag-bd"><div class="circle"></div></div>';
            } else if (theme.themeClass === 'night-theme') {
                animContainer.innerHTML = '<div class="moon"></div>';
                for (let i = 0; i < 20; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.top = Math.random() * 80 + '%';
                    star.style.left = Math.random() * 80 + '%';
                    star.style.width = Math.random() * 4 + 2 + 'px';
                    star.style.height = star.style.width;
                    star.style.animationDelay = Math.random() * 2 + 's';
                    animContainer.appendChild(star);
                }
            } else if (theme.themeClass === 'language-theme') {
                animContainer.innerHTML = '<div class="shaheed-minar"></div>';
                for (let i = 0; i < 3; i++) {
                    const ray = document.createElement('div');
                    ray.style.position = 'absolute';
                    ray.style.background = '#ffaa33';
                    ray.style.width = '2px';
                    ray.style.height = '20px';
                    ray.style.bottom = '10px';
                    ray.style.left = 20 + i * 15 + 'px';
                    ray.style.transform = 'rotate(' + (i * 10 - 20) + 'deg)';
                    ray.style.animation = 'fade-pulse 1.5s infinite alternate';
                    ray.style.animationDelay = i * 0.2 + 's';
                    animContainer.appendChild(ray);
                }
            } else if (theme.themeClass === 'ramadan-theme') {
                animContainer.innerHTML = '<div class="crescent"></div><div class="lantern"></div>';
            }
        }

        async function saveTheme(theme) {
            await setDoc(doc(db, "settings", "appearance"), theme);
            applyTheme(theme);
            showToast('থিম আপডেট হয়েছে', 'palette');
        }

        function renderThemeGrid() {
            const grid = document.getElementById('theme-grid');
            grid.innerHTML = '';
            themes.forEach((t, idx) => {
                const div = document.createElement('div');
                div.className = 'theme-item';
                div.style.background = t.grad;
                div.setAttribute('data-index', idx);
                div.onclick = () => {
                    document.querySelectorAll('.theme-item').forEach(el => el.classList.remove('active'));
                    div.classList.add('active');
                };
                grid.appendChild(div);
            });
            getDoc(doc(db, "settings", "appearance")).then(doc => {
                if (doc.exists()) {
                    const curr = doc.data();
                    const index = themes.findIndex(t => t.primary === curr.primary && t.accent === curr.accent);
                    if (index !== -1) grid.children[index]?.classList.add('active');
                } else {
                    grid.children[0]?.classList.add('active');
                }
            });
        }

        document.getElementById('save-theme-btn')?.addEventListener('click', () => {
            const active = document.querySelector('.theme-item.active');
            if (!active) return;
            const idx = active.getAttribute('data-index');
            saveTheme(themes[idx]);
        });

        // ========== DATETIME DISPLAY ==========
        function updateDateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
            const dateStr = now.toLocaleDateString('bn-BD', options);
            document.getElementById('current-time').innerText = timeStr;
            document.getElementById('current-date').innerText = dateStr;
        }
        setInterval(updateDateTime, 1000);

        // ========== TEXT SLIDER MANAGEMENT (with color) ==========
        let sliderTexts = [];
        let sliderColor = '#ffffff'; // default

        async function loadTextSlides() {
            const snap = await getDocs(query(collection(db, "text_slides"), orderBy("order", "asc")));
            sliderTexts = [];
            snap.forEach(doc => sliderTexts.push({ id: doc.id, text: doc.data().text }));
            renderTextSlider();
        }

        async function loadTextSlideColor() {
            const colorDoc = await getDoc(doc(db, "settings", "textSlideColor"));
            if (colorDoc.exists()) {
                sliderColor = colorDoc.data().color;
            } else {
                sliderColor = '#ffffff';
            }
            document.getElementById('slider-content').style.color = sliderColor;
            document.getElementById('ts-color').value = sliderColor;
        }

        async function saveTextSlideColor(color) {
            await setDoc(doc(db, "settings", "textSlideColor"), { color: color });
            sliderColor = color;
            document.getElementById('slider-content').style.color = color;
            showToast('রঙ সংরক্ষিত হয়েছে');
        }

        function renderTextSlider() {
            const container = document.getElementById('slider-content');
            const placeholder = document.getElementById('slider-placeholder');
            if (sliderTexts.length === 0) {
                container.innerHTML = '';
                placeholder.style.display = 'block';
                return;
            }
            placeholder.style.display = 'none';
            const textString = sliderTexts.map(t => t.text).join(' • ');
            container.innerText = textString + ' • ';
        }

        // Admin Text Slide Management (updated with color)
        async function loadAdminTextSlides() {
            const list = document.getElementById('admin-textslide-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "text_slides"), orderBy("order", "asc")));
            list.innerHTML = '';
            if (snaps.empty) {
                list.innerHTML = '<p style="text-align:center; color:#94a3b8;">কোনো টেক্সট নেই</p>';
                return;
            }
            snaps.forEach((doc, index) => {
                const data = doc.data();
                list.innerHTML += `
                    <div class="text-slide-item">
                        <div style="flex:1">${data.text}</div>
                        <div>
                            <button onclick="editTextSlide('${doc.id}', '${data.text}')" class="action-btn" style="background:var(--primary)">Edit</button>
                            <button onclick="deleteTextSlide('${doc.id}')" class="action-btn" style="background:var(--danger)">Del</button>
                        </div>
                    </div>
                `;
            });
        }

        window.editTextSlide = (id, oldText) => {
            const newText = prompt('টেক্সট পরিবর্তন করুন:', oldText);
            if (newText && newText !== oldText) {
                updateDoc(doc(db, "text_slides", id), { text: newText });
                showToast('আপডেট হয়েছে');
                loadAdminTextSlides();
                loadTextSlides();
            }
        };

        window.deleteTextSlide = async (id) => {
            if (confirm('ডিলিট করতে চান?')) {
                await deleteDoc(doc(db, "text_slides", id));
                showToast('ডিলিট হয়েছে');
                loadAdminTextSlides();
                loadTextSlides();
            }
        };

        document.getElementById('ts-add').onclick = async () => {
            const text = document.getElementById('ts-text').value;
            if (!text) return alert('টেক্সট দিন');
            const snaps = await getDocs(query(collection(db, "text_slides"), orderBy("order", "desc")));
            let maxOrder = 0;
            if (!snaps.empty) {
                maxOrder = snaps.docs[0].data().order || 0;
            }
            await addDoc(collection(db, "text_slides"), { text, order: maxOrder + 1, createdAt: serverTimestamp() });
            showToast('টেক্সট যোগ হয়েছে');
            document.getElementById('ts-text').value = '';
            loadAdminTextSlides();
            loadTextSlides();
        };

        document.getElementById('ts-save-color').onclick = () => {
            const color = document.getElementById('ts-color').value;
            saveTextSlideColor(color);
        };

        // ========== NAVIGATION & HISTORY ==========
        const tabs = { 
            home:'view-home', services:'view-services', villagers:'view-villagers', profile:'view-profile', 
            admin:'view-admin', auth:'view-auth', setup:'view-setup', mosque:'view-mosque', school:'view-school', 
            shop:'view-shop', map:'view-map', gallery:'view-gallery', sports:'view-sports',
            importantpersons:'view-importantpersons'
        };
        const navBtns = { home:'tab-home', services:'tab-services', profile:'tab-profile', admin:'tab-admin' };
        let backCount = 0;
        let backTimer;

        // Store current user data
        let currentUserData = null;

        window.switchTab = (tabName, pushState = true) => {
            Object.values(tabs).forEach(id => document.getElementById(id).style.display = 'none');
            Object.values(navBtns).forEach(id => document.getElementById(id).classList.remove('active'));

            document.getElementById(tabs[tabName]).style.display = 'block';

            if(['villagers', 'mosque', 'school', 'shop', 'map', 'gallery', 'sports', 'importantpersons'].includes(tabName)) { 
                document.getElementById('tab-home').classList.add('active'); 
            } else if(navBtns[tabName]) { 
                document.getElementById(navBtns[tabName]).classList.add('active'); 
            }

            // Conditional text slider visibility: only on home page
            const slider = document.getElementById('text-slider-container');
            if (tabName === 'home') {
                slider.classList.remove('hidden');
            } else {
                slider.classList.add('hidden');
            }

            if(tabName === 'home') { 
                loadBanners(); 
                loadNotices(); 
            }
            else if(tabName === 'services') { 
            }
            else if(tabName === 'villagers') { 
                loadVillagers(); 
            }
            else if(tabName === 'profile') { 
                loadProfile(); 
            }
            else if(tabName === 'admin') { 
                window.closeAdminSub(); 
                loadAdminData(); 
            }
            else if(tabName === 'mosque') { 
            }
            else if(tabName === 'school') { 
            }
            else if(tabName === 'shop') { 
            }
            else if(tabName === 'map') { 
                loadMapLink(); 
            }
            else if(tabName === 'gallery') { 
                loadGallery(); 
            }
            else if(tabName === 'sports') { 
                loadSportsPosts(); 
            }
            else if(tabName === 'importantpersons') {
                loadImportantPersons();
            }

            if (pushState) {
                history.pushState({ tab: tabName }, '');
            }
        };

        window.addEventListener('popstate', (e) => {
            if (e.state && e.state.tab) {
                switchTab(e.state.tab, false);
            } else {
                const currentTab = Object.keys(tabs).find(key => document.getElementById(tabs[key]).style.display === 'block');
                if (currentTab === 'home') {
                    backCount++;
                    if (backCount === 1) {
                        showToast('আবার ব্যাক বাটন চাপুন প্রস্থান করতে', 'info', 2000);
                        backTimer = setTimeout(() => backCount = 0, 2000);
                    } else if (backCount >= 2) {
                        clearTimeout(backTimer);
                        backCount = 0;
                        if (navigator.app) {
                            navigator.app.exitApp();
                        } else {
                            window.close();
                        }
                    }
                } else {
                    switchTab('home', true);
                }
            }
        });

        history.replaceState({ tab: 'home' }, '');

        Object.keys(navBtns).forEach(k => document.getElementById(navBtns[k]).addEventListener('click', () => switchTab(k)));

        // ========== AUTH ==========
        onAuthStateChanged(auth, async (user) => {
            setTimeout(() => document.getElementById('splash').style.display = 'none', 1500);
            
            try {
                await loadTheme();
                await loadTextSlides(); // Load text slider on startup
                await loadTextSlideColor(); // Load text color
            } catch (error) {
                console.log("Theme load failed, applying default.", error);
            }

            if(user) {
                const uDoc = await getDoc(doc(db, "users", user.uid));
                if(uDoc.exists()) {
                    const data = uDoc.data();
                    currentUserData = data;
                    if(data.status === "banned" && user.email !== adminEmail) { signOut(auth); alert("আপনার অ্যাকাউন্ট ব্যান করা হয়েছে!"); return; }
                    
                    if(!data.name && user.email !== adminEmail) {
                        document.getElementById('b-nav').style.display = "none";
                        switchTab('setup');
                    } else {
                        document.getElementById('b-nav').style.display = "flex";
                        document.getElementById('tab-admin').style.display = (user.email === adminEmail) ? "flex" : "none";
                        switchTab('home');
                    }
                } else {
                    await setDoc(doc(db, "users", user.uid), { email:user.email, role:"user", status:"active" });
                    switchTab('setup');
                }
            } else {
                document.getElementById('b-nav').style.display = "none";
                switchTab('auth');
            }
        });

        let isLog = true;
        document.getElementById('auth-toggle').onclick = () => {
            isLog = !isLog;
            document.getElementById('auth-head').innerText = isLog ? "লগইন করুন" : "নতুন অ্যাকাউন্ট";
            document.getElementById('auth-action').innerText = isLog ? "লগইন" : "রেজিস্টার";
            document.getElementById('auth-hint').innerText = isLog ? "অ্যাকাউন্ট নেই?" : "অ্যাকাউন্ট আছে?";
            document.getElementById('auth-toggle').innerText = isLog ? "রেজিস্ট্রেশন করুন" : "লগইন করুন";
        };

        document.getElementById('auth-action').onclick = async () => {
            const e = document.getElementById('auth-email').value; const p = document.getElementById('auth-pass').value;
            if(!e || !p) return;
            try {
                if(isLog) await signInWithEmailAndPassword(auth, e, p);
                else {
                    const c = await createUserWithEmailAndPassword(auth, e, p);
                    await setDoc(doc(db, "users", c.user.uid), { email:e, role: e===adminEmail?"admin":"user", status:"active", createdAt:serverTimestamp() });
                }
            } catch(er) { alert("Error: " + er.message); }
        };

        document.getElementById('profile-logout').onclick = () => signOut(auth);

        // ========== DYNAMIC FORM HELPERS ==========
        function setupProfessionListeners() {
            const profSelect = document.getElementById('set-prof');
            const driverField = document.getElementById('driver-field');
            const expatField = document.getElementById('expat-field');
            const studentField = document.getElementById('student-field');
            
            if (profSelect) {
                profSelect.addEventListener('change', () => {
                    const val = profSelect.value;
                    driverField.classList.remove('show');
                    expatField.classList.remove('show');
                    studentField.classList.remove('show');
                    if (val === 'ড্রাইভার') driverField.classList.add('show');
                    else if (val === 'প্রবাসী') expatField.classList.add('show');
                    else if (val === 'ছাত্র') studentField.classList.add('show');
                });
            }

            const upProf = document.getElementById('up-prof');
            const upDriver = document.getElementById('up-driver-field');
            const upExpat = document.getElementById('up-expat-field');
            const upStudent = document.getElementById('up-student-field');
            
            if (upProf) {
                upProf.addEventListener('change', () => {
                    const val = upProf.value;
                    upDriver.classList.remove('show');
                    upExpat.classList.remove('show');
                    upStudent.classList.remove('show');
                    if (val === 'ড্রাইভার') upDriver.classList.add('show');
                    else if (val === 'প্রবাসী') upExpat.classList.add('show');
                    else if (val === 'ছাত্র') upStudent.classList.add('show');
                });
            }
        }

        // ========== SETUP ==========
        document.getElementById('setup-photo').addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const preview = document.getElementById('setup-preview');
                    preview.src = event.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        async function updateDriverFromUser(userId, userData) {
            if (userData.profession === 'ড্রাইভার') {
                const driverRef = doc(db, "drivers", userId);
                await setDoc(driverRef, {
                    name: userData.name,
                    phone: userData.phone,
                    vehicleType: userData.vehicleType || '',
                    photoURL: userData.photoURL || '',
                    userId: userId,
                    updatedAt: serverTimestamp()
                }, { merge: true });
            } else {
                try {
                    await deleteDoc(doc(db, "drivers", userId));
                } catch (e) { /* ignore if not exists */ }
            }
        }

        // NEW: Update doctor collection based on user profession
        async function updateDoctorFromUser(userId, userData) {
            if (userData.profession === 'ডাক্তার') {
                const doctorRef = doc(db, "doctors", userId);
                await setDoc(doctorRef, {
                    name: userData.name,
                    phone: userData.phone,
                    photoURL: userData.photoURL || '',
                    userId: userId,
                    updatedAt: serverTimestamp()
                }, { merge: true });
            } else {
                try {
                    await deleteDoc(doc(db, "doctors", userId));
                } catch (e) { /* ignore if not exists */ }
            }
        }

        document.getElementById('save-setup').onclick = async () => {
            const n = document.getElementById('set-name').value; 
            const addr = document.getElementById('set-addr').value;
            if(!n || !addr) return alert("নাম এবং ঠিকানা দিন!");
            
            let photoURL = "";
            const fileInput = document.getElementById('setup-photo');
            if (fileInput.files[0]) {
                const finish = showLoading(document.getElementById('save-setup'));
                try {
                    photoURL = await uploadToCloudinary(fileInput.files[0]);
                } catch (err) {
                    finish();
                    alert("ছবি আপলোড করতে সমস্যা হয়েছে, পরে আবার চেষ্টা করুন।");
                    return;
                }
                finish();
            }

            const profession = document.getElementById('set-prof').value;
            const userData = {
                name: n,
                profession: profession,
                bloodGroup: document.getElementById('set-blood').value,
                phone: document.getElementById('set-phone').value,
                address: addr,
                photoURL: photoURL,
                vehicleType: document.getElementById('set-vehicle')?.value || '',
                country: document.getElementById('set-country')?.value || '',
                institution: document.getElementById('set-institution')?.value || '',
                facebook: document.getElementById('set-facebook').value,
                whatsapp: document.getElementById('set-whatsapp').value,
                telegram: document.getElementById('set-telegram').value
            };

            await updateDoc(doc(db, "users", auth.currentUser.uid), userData);
            
            await updateDriverFromUser(auth.currentUser.uid, userData);
            await updateDoctorFromUser(auth.currentUser.uid, userData); // NEW

            showSuccessFull();
            setTimeout(() => { document.getElementById('b-nav').style.display='flex'; switchTab('home'); }, 2000);
        };

        // ========== BANNERS ==========
        document.getElementById('banner-image')?.addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('banner-preview').src = event.target.result;
                    document.getElementById('banner-preview').style.display = 'block';
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        document.getElementById('ab-btn').onclick = async () => {
            const file = document.getElementById('banner-image').files[0];
            if (!file) return alert('ছবি নির্বাচন করুন');
            const link = document.getElementById('ab-link').value;
            const finish = showLoading(document.getElementById('ab-btn'));
            try {
                const url = await uploadToCloudinary(file);
                await addDoc(collection(db, "banners"), { image: url, link: link, createdAt: serverTimestamp() });
                showToast('ব্যানার যোগ হয়েছে', 'check_circle');
                document.getElementById('banner-image').value = '';
                document.getElementById('banner-preview').style.display = 'none';
                document.getElementById('ab-link').value = '';
                loadAdminData();
            } catch (err) {
                alert('আপলোড ব্যর্থ');
            } finally {
                finish();
            }
        };

        let sInt;
        async function loadBanners() {
            const b = document.getElementById('banner-slider');
            const d = await getDocs(query(collection(db, "banners"), orderBy("createdAt", "desc")));
            if(d.empty) { b.innerHTML = "<div style='display:flex;justify-content:center;align-items:center;height:100%;color:#94a3b8'>ব্যানার নেই</div>"; return; }
            b.innerHTML = ""; let i=0;
            d.forEach(doc => { b.innerHTML += `<a href="${doc.data().link||'#'}"><img src="${doc.data().image}" class="banner-img ${i===0?'active':''}"></a>`; i++; });
            if(sInt) clearInterval(sInt);
            if(i>1) sInt = setInterval(()=>{
                const imgs = document.querySelectorAll('.banner-img'); let a=0;
                imgs.forEach((el,x)=>{if(el.classList.contains('active')){el.classList.remove('active');a=x;}});
                imgs[(a+1)%imgs.length].classList.add('active');
            }, 3500);
        }

        // ========== NOTICES ==========
        document.getElementById('an-image')?.addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('an-preview').src = event.target.result;
                    document.getElementById('an-preview').style.display = 'block';
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        document.getElementById('an-btn').onclick = async () => { 
            const t = document.getElementById('an-title').value; 
            if(!t) return alert('শিরোনাম দিন');
            let imageUrl = '';
            const file = document.getElementById('an-image').files[0];
            if (file) {
                const finish = showLoading(document.getElementById('an-btn'));
                try {
                    imageUrl = await uploadToCloudinary(file);
                } catch (err) {
                    finish();
                    alert('ছবি আপলোড ব্যর্থ');
                    return;
                }
                finish();
            }
            await addDoc(collection(db,"notices"), {
                title: t,
                description: document.getElementById('an-desc').value,
                imageUrl: imageUrl,
                createdAt: serverTimestamp()
            }); 
            document.getElementById('an-title').value = "";
            document.getElementById('an-desc').value = "";
            document.getElementById('an-image').value = "";
            document.getElementById('an-preview').style.display = 'none';
            showToast('নোটিশ পাবলিশ হয়েছে', 'campaign');
            loadAdminData(); 
        };

        function showNoticeDetail(notice) {
            document.getElementById('notice-modal-title').innerText = notice.title;
            document.getElementById('notice-modal-desc').innerText = notice.description || '';
            const imgEl = document.getElementById('notice-modal-img');
            if (notice.imageUrl) {
                imgEl.src = notice.imageUrl;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }
            openModal('notice-detail-modal');
        }

        async function loadNotices() {
            const n = document.getElementById('notice-list');
            const d = await getDocs(query(collection(db, "notices"), orderBy("createdAt", "desc")));
            n.innerHTML = d.empty ? "<p style='text-align:center;color:#94a3b8'>নোটিশ নেই</p>" : "";
            d.forEach(doc => {
                const data = doc.data();
                const noticeDiv = document.createElement('div');
                noticeDiv.className = 'notice-card';
                noticeDiv.onclick = () => showNoticeDetail(data);
                noticeDiv.innerHTML = `
                    <h4>${data.title}</h4>
                    <p>${data.description || ''}</p>
                    ${data.imageUrl ? `<img src="${data.imageUrl}" class="notice-img">` : ''}
                `;
                n.appendChild(noticeDiv);
            });
        }

        // ========== PLACES (updated with map link and edit) ==========
        window.loadPlaces = async (collectionName, listId) => {
            const l = document.getElementById(listId);
            l.innerHTML = "<p style='text-align:center;color:#94a3b8'>লোড হচ্ছে...</p>";
            const d = await getDocs(query(collection(db, collectionName), orderBy("createdAt", "desc")));
            if(d.empty) { l.innerHTML = "<p style='text-align:center'>কোনো তথ্য পাওয়া যায়নি</p>"; return; }
            l.innerHTML = "";
            d.forEach(doc => {
                const data = doc.data();
                const imgHtml = data.imageUrl ? `<img src="${data.imageUrl}" class="place-thumb">` : '<div class="place-thumb" style="background:#f1f5f9; display:flex; align-items:center; justify-content:center;"><span class="material-icons-round" style="color:#94a3b8">place</span></div>';
                l.innerHTML += `
                <div class="list-item" onclick='showPlaceDetails(${JSON.stringify(data).replace(/'/g, "&apos;")})'>
                    <div style="display:flex; align-items:center;">
                        ${imgHtml}
                        <div>
                            <h4 style="margin:0 0 3px; color:var(--primary);">${data.name}</h4>
                            <p style="margin:0; font-size:0.8rem; color:var(--text-sub)">${data.desc || ''}</p>
                        </div>
                    </div>
                    <span class="material-icons-round" style="color:var(--text-sub)">chevron_right</span>
                </div>`;
            });
        };

        window.showPlaceDetails = (place) => {
            document.getElementById('place-modal-name').innerText = place.name;
            document.getElementById('place-modal-desc').innerText = place.desc || 'কোনো বিবরণ নেই';
            const imgEl = document.getElementById('place-modal-img');
            if (place.imageUrl) {
                imgEl.src = place.imageUrl;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }
            // Map button
            const mapBtn = document.getElementById('place-modal-map');
            if (place.mapLink) {
                mapBtn.href = place.mapLink;
                mapBtn.style.display = 'block';
            } else {
                mapBtn.style.display = 'none';
            }
            openModal('place-modal');
        };

        // ========== VILLAGERS ==========
        let cachedV = [];
        async function loadVillagers() {
            const l = document.getElementById('villager-list');
            if(cachedV.length === 0) {
                l.innerHTML = "<p style='text-align:center;color:#94a3b8'>লোড হচ্ছে...</p>";
                const d = await getDocs(collection(db, "users")); cachedV = [];
                d.forEach(doc => cachedV.push({ id: doc.id, ...doc.data() }));
            }
            renderV(cachedV);
        }
        function renderV(list) {
            const l = document.getElementById('villager-list'); l.innerHTML = "";
            const v = list.filter(u => u.name && u.status !== 'banned');
            if(v.length===0) { l.innerHTML = "<p style='text-align:center'>কাউকে পাওয়া যায়নি</p>"; return; }
            v.forEach(u => {
                const sData = encodeURIComponent(JSON.stringify(u));
                const avatarHtml = u.photoURL ? `<img src="${u.photoURL}" onclick="event.stopPropagation(); openImageLightbox('${u.photoURL}')">` : u.name.charAt(0);
                l.innerHTML += `
                <div class="list-item" onclick="window.showU('${sData}')">
                    <div style="display:flex;align-items:center"><div class="avatar">${avatarHtml}</div><div class="info"><h4>${u.name}</h4><p>${u.profession||'পেশা নেই'}</p></div></div>
                    <a href="tel:${u.phone}" class="call-btn" onclick="event.stopPropagation()"><span class="material-icons-round">call</span></a>
                </div>`;
            });
        }
        document.getElementById('search-villager').addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            renderV(cachedV.filter(u => u.name?.toLowerCase().includes(q) || u.phone?.includes(q) || u.profession?.toLowerCase().includes(q)));
        });
        window.showU = (d) => {
            const u = JSON.parse(decodeURIComponent(d));
            document.getElementById('um-av-text').innerText = u.name.charAt(0);
            const avImg = document.getElementById('um-av-img');
            if (u.photoURL) {
                avImg.src = u.photoURL;
                avImg.style.display = 'block';
                document.getElementById('um-av-text').style.display = 'none';
            } else {
                avImg.style.display = 'none';
                document.getElementById('um-av-text').style.display = 'block';
            }
            document.getElementById('um-name').innerText = u.name;
            document.getElementById('um-role').innerText = u.profession||'-';
            document.getElementById('um-phone').innerText = u.phone||'-';
            document.getElementById('um-blood').innerText = u.bloodGroup||'-';
            document.getElementById('um-addr').innerText = u.address||'-';
            document.getElementById('um-call').href = `tel:${u.phone}`;
            
            // Social links in user modal (brand colors)
            const fbLink = document.getElementById('um-facebook');
            const waLink = document.getElementById('um-whatsapp');
            const tgLink = document.getElementById('um-telegram');
            if (u.facebook) { fbLink.href = formatFacebook(u.facebook); fbLink.style.display = 'inline-block'; } else fbLink.style.display = 'none';
            if (u.whatsapp) { waLink.href = formatWhatsApp(u.whatsapp); waLink.style.display = 'inline-block'; } else waLink.style.display = 'none';
            if (u.telegram) { tgLink.href = formatTelegram(u.telegram); tgLink.style.display = 'inline-block'; } else tgLink.style.display = 'none';
            
            openModal('user-modal');
        };

        // ========== SOCIAL MEDIA LINK FORMATTING ==========
        function formatFacebook(input) {
            if (!input) return '#';
            if (input.startsWith('http')) return input;
            let username = input.replace(/[^a-zA-Z0-9.]/g, '');
            return `https://facebook.com/${username}`;
        }
        function formatWhatsApp(input) {
            if (!input) return '#';
            if (input.includes('wa.me') || input.includes('whatsapp.com')) return input;
            let phone = input.replace(/\D/g, '');
            return `https://wa.me/${phone}`;
        }
        function formatTelegram(input) {
            if (!input) return '#';
            if (input.includes('t.me')) return input;
            let username = input.replace(/[@\s]/g, '');
            return `https://t.me/${username}`;
        }

        // ========== BLOOD DONORS ==========
        window.loadDonors = async (filter) => {
            const list = document.getElementById('bd-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const q = query(collection(db, "blood_donors"), orderBy("createdAt", "desc"));
            const snaps = await getDocs(q);
            list.innerHTML = '';
            snaps.forEach(doc => {
                const d = doc.data();
                if (filter === 'All' || d.bloodGroup === filter) {
                    list.innerHTML += `<div class="list-item"><div><b style="color:var(--danger)">${d.bloodGroup}</b> ${d.name}</div><a href="tel:${d.phone}" class="call-btn"><span class="material-icons-round">call</span></a></div>`;
                }
            });
        };

        document.getElementById('bd-add').onclick = async () => {
            const name = document.getElementById('bd-name').value;
            const group = document.getElementById('bd-grp').value;
            const phone = document.getElementById('bd-phone').value;
            if (!name || !group || !phone) return alert('সব ফিল্ড পূরণ করুন');
            await addDoc(collection(db, "blood_donors"), { name, bloodGroup: group, phone, createdAt: serverTimestamp() });
            showToast('রক্তদাতা যুক্ত হয়েছে');
            document.getElementById('bd-name').value = '';
            document.getElementById('bd-grp').value = '';
            document.getElementById('bd-phone').value = '';
            loadDonors(document.getElementById('bd-filter').value);
        };

        // ========== EMERGENCY SERVICES ==========
        async function loadEmergencyContacts() {
            const list = document.getElementById('emergency-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "emergency"), orderBy("createdAt", "desc")));
            list.innerHTML = '';
            if (snaps.empty) {
                list.innerHTML = '<p style="text-align:center; color:#94a3b8">কোনো তথ্য নেই</p>';
                return;
            }
            snaps.forEach(doc => {
                const data = doc.data();
                list.innerHTML += `
                    <div class="list-item">
                        <div><h4 style="margin:0">${data.name}</h4><small>${data.phone}</small></div>
                        <a href="tel:${data.phone}" class="call-btn" style="background:#fff7ed; color:var(--warning)"><span class="material-icons-round">call</span></a>
                    </div>
                `;
            });
        }

        // ========== AGRICULTURE INFO ==========
        async function loadAgriInfo() {
            const list = document.getElementById('agri-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "agri_info"), orderBy("createdAt", "desc")));
            list.innerHTML = '';
            if (snaps.empty) {
                list.innerHTML = '<p style="text-align:center; color:#94a3b8">কোনো তথ্য নেই</p>';
                return;
            }
            snaps.forEach(doc => {
                const data = doc.data();
                list.innerHTML += `
                    <div class="card" style="margin-bottom:10px;">
                        <h4 style="margin:0 0 5px; color:var(--accent)">${data.title}</h4>
                        <p style="margin:0 0 5px;">${data.description}</p>
                        ${data.contact ? `<small>যোগাযোগ: ${data.contact}</small>` : ''}
                    </div>
                `;
            });
        }

        // ========== TRANSPORT/DRIVER MODULE ==========
        window.loadDrivers = async function(search = '') {
    const list = document.getElementById('driver-list');

            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "drivers"), orderBy("updatedAt", "desc")));
            let drivers = [];
            snaps.forEach(doc => drivers.push({ id: doc.id, ...doc.data() }));

            if (search) {
                const q = search.toLowerCase();
                drivers = drivers.filter(d => 
                    d.name?.toLowerCase().includes(q) || 
                    d.phone?.includes(q) || 
                    d.vehicleType?.toLowerCase().includes(q)
                );
            }

            list.innerHTML = '';
            if (drivers.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#94a3b8">কোনো ড্রাইভার পাওয়া যায়নি</p>';
                return;
            }
            drivers.forEach(d => {
                const card = document.createElement('div');
                card.className = 'driver-card';
                card.innerHTML = `
                    <div class="driver-avatar">
                        ${d.photoURL ? `<img src="${d.photoURL}">` : '<span class="material-icons-round" style="font-size:40px; line-height:60px; text-align:center; width:100%; color:#94a3b8">person</span>'}
                    </div>
                    <div class="driver-info">
                        <h4>${d.name}</h4>
                        <p><span class="material-icons-round" style="font-size:16px; vertical-align:middle;">phone</span> ${d.phone}</p>
                        <p><span class="material-icons-round" style="font-size:16px; vertical-align:middle;">local_shipping</span> ${d.vehicleType || 'নেই'}</p>
                    </div>
                    <a href="tel:${d.phone}" class="driver-call"><span class="material-icons-round">call</span> কল</a>
                `;
                list.appendChild(card);
            });
        }

        document.getElementById('driver-search')?.addEventListener('input', (e) => {
            loadDrivers(e.target.value);
        });

        // ========== PROFILE ==========
        async function loadProfile() {
            if(!auth.currentUser) return;
            const d = await getDoc(doc(db,"users",auth.currentUser.uid));
            if(d.exists()) {
                const u = d.data();
                currentUserData = u;
                document.getElementById('my-name').innerText = u.name;
                document.getElementById('my-role').innerText = u.email;
                document.getElementById('up-name').value = u.name || '';
                document.getElementById('up-prof').value = u.profession || '';
                document.getElementById('up-phone').value = u.phone || '';
                document.getElementById('up-blood').value = u.bloodGroup || '';
                document.getElementById('up-addr').value = u.address || '';

                document.getElementById('up-facebook').value = u.facebook || '';
                document.getElementById('up-whatsapp').value = u.whatsapp || '';
                document.getElementById('up-telegram').value = u.telegram || '';

                document.getElementById('up-vehicle').value = u.vehicleType || '';
                document.getElementById('up-country').value = u.country || '';
                document.getElementById('up-institution').value = u.institution || '';

                const prof = u.profession;
                document.getElementById('up-driver-field').classList.toggle('show', prof === 'ড্রাইভার');
                document.getElementById('up-expat-field').classList.toggle('show', prof === 'প্রবাসী');
                document.getElementById('up-student-field').classList.toggle('show', prof === 'ছাত্র');

                if (u.photoURL) {
                    document.getElementById('profile-avatar-img').src = u.photoURL;
                    document.getElementById('profile-avatar-img').style.display = 'block';
                    document.getElementById('profile-avatar-icon').style.display = 'none';
                } else {
                    document.getElementById('profile-avatar-img').style.display = 'none';
                    document.getElementById('profile-avatar-icon').style.display = 'block';
                }

                document.getElementById('profile-info-grid').innerHTML = `
                    <div class="info-chip"><span class="material-icons-round">phone</span> ${u.phone || 'নেই'}</div>
                    <div class="info-chip"><span class="material-icons-round">bloodtype</span> ${u.bloodGroup || 'নেই'}</div>
                    <div class="info-chip"><span class="material-icons-round">location_on</span> ${u.address || 'নেই'}</div>
                `;

                // Social icons in profile view (brand colors)
                const fbLink = document.getElementById('profile-facebook');
                const waLink = document.getElementById('profile-whatsapp');
                const tgLink = document.getElementById('profile-telegram');
                if (u.facebook) { fbLink.href = formatFacebook(u.facebook); fbLink.style.display = 'inline-block'; } else fbLink.style.display = 'none';
                if (u.whatsapp) { waLink.href = formatWhatsApp(u.whatsapp); waLink.style.display = 'inline-block'; } else waLink.style.display = 'none';
                if (u.telegram) { tgLink.href = formatTelegram(u.telegram); tgLink.style.display = 'inline-block'; } else tgLink.style.display = 'none';
            }
        }

        document.getElementById('edit-avatar-btn').onclick = () => {
            document.getElementById('profile-photo').click();
        };
        document.getElementById('profile-photo').addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('profile-preview').src = event.target.result;
                    document.getElementById('profile-preview').style.display = 'block';
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        document.getElementById('up-btn').onclick = async () => {
            const updates = {
                name: document.getElementById('up-name').value,
                profession: document.getElementById('up-prof').value,
                phone: document.getElementById('up-phone').value,
                bloodGroup: document.getElementById('up-blood').value,
                address: document.getElementById('up-addr').value,
                vehicleType: document.getElementById('up-vehicle').value,
                country: document.getElementById('up-country').value,
                institution: document.getElementById('up-institution').value,
                facebook: document.getElementById('up-facebook').value,
                whatsapp: document.getElementById('up-whatsapp').value,
                telegram: document.getElementById('up-telegram').value
            };
            const fileInput = document.getElementById('profile-photo');
            if (fileInput.files[0]) {
                const finish = showLoading(document.getElementById('up-btn'));
                try {
                    updates.photoURL = await uploadToCloudinary(fileInput.files[0]);
                } catch (err) {
                    finish();
                    alert("ছবি আপলোড ব্যর্থ হয়েছে");
                    return;
                }
                finish();
            }
            await updateDoc(doc(db, "users", auth.currentUser.uid), updates);
            
            await updateDriverFromUser(auth.currentUser.uid, updates);
            await updateDoctorFromUser(auth.currentUser.uid, updates); // NEW

            showToast('প্রোফাইল আপডেট হয়েছে');
            loadProfile();
            document.getElementById('profile-preview').style.display = 'none';
            fileInput.value = '';
        };

        // ========== GALLERY ==========
        window.viewGalleryImage = (url) => {
            document.getElementById('gallery-modal-img').src = url;
            let downloadUrl = url;
            if (url.includes('/upload/')) {
                downloadUrl = url.replace('/upload/', '/upload/fl_attachment/');
            }
            document.getElementById('gallery-modal-download').href = downloadUrl;
            openModal('gallery-modal');
        };

        async function loadGallery() {
            const grid = document.getElementById('gallery-grid');
            grid.innerHTML = '<p style="text-align:center; color:#94a3b8">লোড হচ্ছে...</p>';
            const snaps = await getDocs(query(collection(db, "gallery"), orderBy("createdAt", "desc")));
            if (snaps.empty) {
                grid.innerHTML = '<p style="text-align:center; color:#94a3b8">কোনো ছবি নেই</p>';
                return;
            }
            grid.innerHTML = '';
            snaps.forEach(doc => {
                const imgUrl = doc.data().imageUrl;
                grid.innerHTML += `
                    <div class="gallery-item" onclick="viewGalleryImage('${imgUrl}')" style="cursor: pointer;">
                        <img src="${imgUrl}" loading="lazy">
                    </div>
                `;
            });
        }

        // ========== SPORTS ==========
        document.getElementById('sports-image')?.addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('sports-preview').src = event.target.result;
                    document.getElementById('sports-preview').style.display = 'block';
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        document.getElementById('sports-add-btn').onclick = async () => {
            const title = document.getElementById('sports-title').value;
            if (!title) return alert('শিরোনাম দিন');
            let imageUrl = '';
            const file = document.getElementById('sports-image').files[0];
            if (file) {
                const finish = showLoading(document.getElementById('sports-add-btn'));
                try {
                    imageUrl = await uploadToCloudinary(file);
                } catch (err) {
                    finish();
                    alert('ছবি আপলোড ব্যর্থ');
                    return;
                }
                finish();
            }
            await addDoc(collection(db, "sports_posts"), {
                title: title,
                description: document.getElementById('sports-desc').value,
                imageUrl: imageUrl,
                createdAt: serverTimestamp()
            });
            document.getElementById('sports-title').value = '';
            document.getElementById('sports-desc').value = '';
            document.getElementById('sports-image').value = '';
            document.getElementById('sports-preview').style.display = 'none';
            showToast('পোস্ট প্রকাশিত হয়েছে', 'sports_soccer');
            loadAdminSportsPosts();
        };

        async function loadAdminSportsPosts() {
            const listDiv = document.getElementById('admin-sports-list');
            listDiv.innerHTML = '<p style="text-align:center; color:#94a3b8;">লোড হচ্ছে...</p>';
            const snaps = await getDocs(query(collection(db, "sports_posts"), orderBy("createdAt", "desc")));
            if (snaps.empty) {
                listDiv.innerHTML = '<p style="text-align:center; color:#94a3b8;">কোনো পোস্ট নেই</p>';
                return;
            }
            listDiv.innerHTML = '';
            snaps.forEach(doc => {
                const data = doc.data();
                listDiv.innerHTML += `
                    <div class="admin-banner-item">
                        <div style="flex:1"><b>${data.title}</b></div>
                        <button onclick="window.delSportsPost('${doc.id}')" class="action-btn" style="background:var(--danger)">Delete</button>
                    </div>
                `;
            });
        }

        window.delSportsPost = async (id) => {
            if (confirm('পোস্টটি ডিলিট করতে চান?')) {
                await deleteDoc(doc(db, "sports_posts", id));
                loadAdminSportsPosts();
                if (document.getElementById('view-sports').style.display === 'block') loadSportsPosts();
                showToast('পোস্ট ডিলিট');
            }
        };

        async function loadSportsPosts() {
            const listDiv = document.getElementById('sports-list');
            listDiv.innerHTML = '<p style="text-align:center; color:#94a3b8;">লোড হচ্ছে...</p>';
            const snaps = await getDocs(query(collection(db, "sports_posts"), orderBy("createdAt", "desc")));
            if (snaps.empty) {
                listDiv.innerHTML = '<p style="text-align:center; color:#94a3b8;">কোনো খবর নেই</p>';
                return;
            }
            listDiv.innerHTML = '';
            snaps.forEach(doc => {
                const data = doc.data();
                const card = document.createElement('div');
                card.className = 'sports-card';
                card.onclick = () => showNoticeDetail(data);
                let html = '';
                if (data.imageUrl) html += `<img src="${data.imageUrl}" loading="lazy">`;
                html += `<h3>${data.title}</h3>`;
                if (data.description) html += `<p>${data.description}</p>`;
                card.innerHTML = html;
                listDiv.appendChild(card);
            });
        }

        // ========== MAP LINK ==========
        async function loadMapLink() {
            const mapDoc = await getDoc(doc(db, "settings", "map"));
            let mapUrl = "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3690.697669145946!2d91.78287341535794!3d22.32712954756306!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x30acd8000676fef3%3A0x6d9f8df5b6d519ff!2sChittagong!5e0!3m2!1sen!2sbd!4v1708240000000!5m2!1sen!2sbd";
            if (mapDoc.exists()) {
                mapUrl = mapDoc.data().url || mapUrl;
            }
            document.getElementById('map-iframe').src = mapUrl;
            document.getElementById('current-map-link').innerText = mapUrl;
        }

        document.getElementById('save-map-link')?.addEventListener('click', async () => {
            const newUrl = document.getElementById('map-link-input').value;
            if (!newUrl) return alert('URL দিন');
            await setDoc(doc(db, "settings", "map"), { url: newUrl });
            showToast('ম্যাপ লিংক আপডেট হয়েছে');
            loadMapLink();
            closeAdminSub();
        });

        // ========== ADMIN PANEL ==========
        window.openAdminSub = (id) => {
            document.getElementById('admin-main').style.display = 'none';
            document.getElementById('admin-sub-places').style.display = 'none';
            document.getElementById('admin-sub-users').style.display = 'none';
            document.getElementById('admin-sub-notices').style.display = 'none';
            document.getElementById('admin-sub-banners').style.display = 'none';
            document.getElementById('admin-sub-gallery').style.display = 'none';
            document.getElementById('admin-sub-theme').style.display = 'none';
            document.getElementById('admin-sub-map').style.display = 'none';
            document.getElementById('admin-sub-sports').style.display = 'none';
            document.getElementById('admin-sub-blood').style.display = 'none';
            document.getElementById('admin-sub-emergency').style.display = 'none';
            document.getElementById('admin-sub-agri').style.display = 'none';
            document.getElementById('admin-sub-transport').style.display = 'none';
            document.getElementById('admin-sub-ambulance').style.display = 'none';
            document.getElementById('admin-sub-police').style.display = 'none';
            document.getElementById('admin-sub-fire').style.display = 'none';
            document.getElementById('admin-sub-textslide').style.display = 'none';
            document.getElementById('admin-sub-importantpersons').style.display = 'none';
            document.getElementById('admin-sub-doctors').style.display = 'none';
            document.getElementById('admin-sub-marketprice').style.display = 'none';
            document.getElementById('admin-sub-' + id).style.display = 'block';
            if (id === 'gallery') loadAdminGallery();
            if (id === 'theme') renderThemeGrid();
            if (id === 'map') loadMapLink();
            if (id === 'sports') loadAdminSportsPosts();
            if (id === 'blood') loadAdminBloodDonors();
            if (id === 'emergency') loadAdminEmergency();
            if (id === 'agri') loadAdminAgri();
            if (id === 'transport') loadAdminDrivers();
            if (id === 'ambulance') loadAdminAmbulance();
            if (id === 'police') loadAdminPolice();
            if (id === 'fire') loadAdminFire();
            if (id === 'textslide') { loadAdminTextSlides(); loadTextSlideColor(); }
            if (id === 'importantpersons') loadAdminImportantPersons();
            if (id === 'doctors') loadAdminDoctors();
            if (id === 'marketprice') loadAdminMarketPrices();
        };

        window.closeAdminSub = () => {
            document.getElementById('admin-sub-places').style.display = 'none';
            document.getElementById('admin-sub-users').style.display = 'none';
            document.getElementById('admin-sub-notices').style.display = 'none';
            document.getElementById('admin-sub-banners').style.display = 'none';
            document.getElementById('admin-sub-gallery').style.display = 'none';
            document.getElementById('admin-sub-theme').style.display = 'none';
            document.getElementById('admin-sub-map').style.display = 'none';
            document.getElementById('admin-sub-sports').style.display = 'none';
            document.getElementById('admin-sub-blood').style.display = 'none';
            document.getElementById('admin-sub-emergency').style.display = 'none';
            document.getElementById('admin-sub-agri').style.display = 'none';
            document.getElementById('admin-sub-transport').style.display = 'none';
            document.getElementById('admin-sub-ambulance').style.display = 'none';
            document.getElementById('admin-sub-police').style.display = 'none';
            document.getElementById('admin-sub-fire').style.display = 'none';
            document.getElementById('admin-sub-textslide').style.display = 'none';
            document.getElementById('admin-sub-importantpersons').style.display = 'none';
            document.getElementById('admin-sub-doctors').style.display = 'none';
            document.getElementById('admin-sub-marketprice').style.display = 'none';
            document.getElementById('admin-main').style.display = 'block';
        };

        async function loadAdminData() {
            const us = await getDocs(collection(db,"users")); 
            const ns = await getDocs(query(collection(db,"notices"), orderBy("createdAt", "desc")));
            document.getElementById('st-user').innerText = us.size; 
            document.getElementById('st-note').innerText = ns.size;
            
            const ul = document.getElementById('admin-users'); ul.innerHTML="";
            us.forEach(d => {
                const u=d.data();
                const btn = u.status==='banned'?`<button onclick="window.actU('${d.id}','active')" class="action-btn" style="background:var(--accent)">Unban</button>`:`<button onclick="window.actU('${d.id}','banned')" class="action-btn" style="background:var(--warning)">Ban</button>`;
                ul.innerHTML += `<div class="list-item" style="cursor:default; flex-direction:column; align-items:flex-start;"> 
                    <div style="display:flex; justify-content:space-between; width:100%;"><b>${u.name || u.email}</b> <span>${u.role}</span></div>
                    <div style="font-size:0.9rem; color:var(--text-sub);">📞 ${u.phone || '—'} | 💼 ${u.profession || '—'}</div>
                    <div style="margin-top:5px;">${u.role!=='admin'?btn+` <button onclick="window.delU('${d.id}')" class="action-btn" style="background:var(--danger)">Del</button>`:''}</div>
                </div>`;
            });

            document.getElementById('au-search').addEventListener('input', (e) => {
                const q = e.target.value.toLowerCase();
                document.querySelectorAll('#admin-users .list-item').forEach(el => {
                    const text = el.innerText.toLowerCase();
                    el.style.display = text.includes(q) ? 'flex' : 'none';
                });
            });

            const bl = document.getElementById('admin-banners'); bl.innerHTML="";
            const bs = await getDocs(collection(db,"banners"));
            bs.forEach(d => { bl.innerHTML+=`<div class="admin-banner-item"><img src="${d.data().image}" class="admin-banner-img"><button onclick="window.delB('${d.id}')" class="action-btn" style="background:var(--danger)">Delete</button></div>`; });

            const nl = document.getElementById('admin-notices-list'); nl.innerHTML="";
            ns.forEach(d => {
                nl.innerHTML += `<div class="list-item" style="padding:10px; cursor:default; align-items:center;">
                    <div><b style="font-size:0.95rem">${d.data().title}</b></div>
                    <button onclick="window.delNotice('${d.id}')" class="action-btn" style="background:var(--danger)"><span class="material-icons-round" style="font-size:16px; vertical-align:middle;">delete</span></button>
                </div>`;
            });

            window.loadAdminPlaces();
        }

        window.delNotice = async(id) => {
            if(confirm('এই নোটিশটি ডিলিট করতে চান?')){
                await deleteDoc(doc(db,"notices",id)); 
                loadAdminData(); 
                showToast('নোটিশ ডিলিট হয়েছে');
            }
        };

        // Admin Places (updated with map link and edit)
        document.getElementById('ap-image').addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('ap-preview').src = event.target.result;
                    document.getElementById('ap-preview').style.display = 'block';
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        document.getElementById('ap-btn').onclick = async () => {
            const col = document.getElementById('ap-col').value;
            const name = document.getElementById('ap-name').value;
            const desc = document.getElementById('ap-desc').value;
            const mapLink = document.getElementById('ap-map-link').value;
            if(!name) return alert("প্রতিষ্ঠানের নাম আবশ্যক!");
            
            let imageUrl = "";
            const fileInput = document.getElementById('ap-image');
            if (fileInput.files[0]) {
                const finish = showLoading(document.getElementById('ap-btn'));
                try {
                    imageUrl = await uploadToCloudinary(fileInput.files[0]);
                } catch (err) {
                    finish();
                    alert("ছবি আপলোড ব্যর্থ");
                    return;
                }
                finish();
            }

            await addDoc(collection(db, col), { name: name, desc: desc, imageUrl: imageUrl, mapLink: mapLink, createdAt: serverTimestamp() });
            document.getElementById('ap-name').value = ""; document.getElementById('ap-desc').value = ""; document.getElementById('ap-map-link').value = "";
            document.getElementById('ap-image').value = "";
            document.getElementById('ap-preview').style.display = 'none';
            showToast('প্রতিষ্ঠান যুক্ত হয়েছে');
            document.getElementById('ad-view-col').value = col;
            loadAdminPlaces();
        };

        window.loadAdminPlaces = async () => {
            const col = document.getElementById('ad-view-col').value;
            const l = document.getElementById('admin-places-list');
            l.innerHTML = "<p style='text-align:center; color:#94a3b8; font-size:0.9rem;'>লোড হচ্ছে...</p>";
            const d = await getDocs(query(collection(db, col), orderBy("createdAt", "desc")));
            l.innerHTML = "";
            if(d.empty) { l.innerHTML = "<p style='text-align:center; color:#94a3b8; font-size:0.9rem;'>কোনো ডাটা নেই</p>"; return; }
            d.forEach(doc => {
                const data = doc.data();
                l.innerHTML += `<div class="list-item" style="padding:10px; cursor:default; flex-direction: column; align-items: flex-start;">
                    <div style="display:flex; justify-content:space-between; width:100%;">
                        <b style="font-size:0.95rem">${data.name}</b>
                        <div>
                            <button onclick="editPlace('${col}', '${doc.id}', '${data.name}', '${data.desc || ''}', '${data.mapLink || ''}')" class="action-btn" style="background:var(--primary)">Edit</button>
                            <button onclick="window.delPlace('${col}', '${doc.id}')" class="action-btn" style="background:var(--danger)">Delete</button>
                        </div>
                    </div>
                    ${data.mapLink ? `<small>ম্যাপ লিংক: ${data.mapLink}</small>` : ''}
                </div>`;
            });
        };

        window.editPlace = (col, id, oldName, oldDesc, oldMapLink) => {
            const newName = prompt('নাম পরিবর্তন করুন:', oldName);
            if (newName === null) return;
            const newDesc = prompt('বিবরণ পরিবর্তন করুন:', oldDesc);
            if (newDesc === null) return;
            const newMapLink = prompt('গুগল ম্যাপ লিংক পরিবর্তন করুন:', oldMapLink);
            if (newMapLink === null) return;
            updateDoc(doc(db, col, id), { name: newName, desc: newDesc, mapLink: newMapLink });
            showToast('আপডেট হয়েছে');
            loadAdminPlaces();
        };

        window.delPlace = async (col, id) => {
            if(confirm('আপনি কি এটি মুছতে চান?')) {
                await deleteDoc(doc(db, col, id));
                loadAdminPlaces();
                showToast('মুছে ফেলা হয়েছে');
            }
        };

        window.actU=async(id,s)=>{await updateDoc(doc(db,"users",id),{status:s}); loadAdminData(); showToast('স্টেট আপডেট');};
        window.delU=async(id)=>{if(confirm('ইউজারকে ডিলিট করতে চান?')){await deleteDoc(doc(db,"users",id)); loadAdminData(); showToast('ইউজার ডিলিট');}};
        window.delB=async(id)=>{if(confirm('ব্যানারটি ডিলিট করতে চান?')){await deleteDoc(doc(db,"banners",id)); loadAdminData(); showToast('ব্যানার ডিলিট');}};

        // Admin Gallery (unchanged)
        async function loadAdminGallery() {
            const listDiv = document.getElementById('admin-gallery-list');
            listDiv.innerHTML = '<p style="text-align:center; color:#94a3b8;">লোড হচ্ছে...</p>';
            const snaps = await getDocs(query(collection(db, "gallery"), orderBy("createdAt", "desc")));
            if (snaps.empty) {
                listDiv.innerHTML = '<p style="text-align:center; color:#94a3b8;">কোনো ছবি নেই</p>';
                return;
            }
            listDiv.innerHTML = '';
            snaps.forEach(doc => {
                const imgUrl = doc.data().imageUrl;
                listDiv.innerHTML += `
                    <div class="admin-banner-item">
                        <img src="${imgUrl}" class="admin-banner-img">
                        <button onclick="window.delGalleryImage('${doc.id}')" class="action-btn" style="background:var(--danger)">Delete</button>
                    </div>
                `;
            });
        }

        window.delGalleryImage = async (id) => {
            if (confirm('ছবিটি ডিলিট করতে চান?')) {
                await deleteDoc(doc(db, "gallery", id));
                loadAdminGallery();
                if (document.getElementById('view-gallery').style.display === 'block') loadGallery();
                showToast('ছবি ডিলিট');
            }
        };

        document.getElementById('gallery-upload-btn').onclick = async () => {
            const files = document.getElementById('gallery-upload').files;
            if (files.length === 0) return alert('কমপক্ষে একটি ছবি নির্বাচন করুন');
            const finish = showLoading(document.getElementById('gallery-upload-btn'));
            let successCount = 0;
            for (let file of files) {
                try {
                    const url = await uploadToCloudinary(file);
                    await addDoc(collection(db, "gallery"), { imageUrl: url, createdAt: serverTimestamp() });
                    successCount++;
                } catch (err) {
                    console.error(err);
                }
            }
            finish();
            showToast(`${successCount} টি ছবি আপলোড হয়েছে`);
            document.getElementById('gallery-upload').value = '';
            loadAdminGallery();
            if (document.getElementById('view-gallery').style.display === 'block') loadGallery();
        };

        // Admin Blood (unchanged)
        async function loadAdminBloodDonors() {
            const list = document.getElementById('admin-blood-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "blood_donors"), orderBy("createdAt", "desc")));
            list.innerHTML = '';
            snaps.forEach(doc => {
                const data = doc.data();
                list.innerHTML += `
                    <div class="admin-banner-item">
                        <div><b>${data.name}</b> (${data.bloodGroup}) - ${data.phone}</div>
                        <div>
                            <button onclick="editBloodDonor('${doc.id}', '${data.name}', '${data.bloodGroup}', '${data.phone}')" class="action-btn" style="background:var(--primary)">Edit</button>
                            <button onclick="deleteBloodDonor('${doc.id}')" class="action-btn" style="background:var(--danger)">Del</button>
                        </div>
                    </div>
                `;
            });
        }

        window.editBloodDonor = (id, name, group, phone) => {
            const newName = prompt('নাম পরিবর্তন করুন:', name);
            if (newName === null) return;
            const newGroup = prompt('রক্তের গ্রুপ পরিবর্তন করুন:', group);
            if (newGroup === null) return;
            const newPhone = prompt('মোবাইল নম্বর পরিবর্তন করুন:', phone);
            if (newPhone === null) return;
            updateDoc(doc(db, "blood_donors", id), { name: newName, bloodGroup: newGroup, phone: newPhone });
            showToast('আপডেট হয়েছে');
            loadAdminBloodDonors();
        };

        window.deleteBloodDonor = async (id) => {
            if (confirm('ডিলিট করতে চান?')) {
                await deleteDoc(doc(db, "blood_donors", id));
                loadAdminBloodDonors();
                showToast('ডিলিট হয়েছে');
            }
        };

        document.getElementById('abd-add').onclick = async () => {
            const name = document.getElementById('abd-name').value;
            const group = document.getElementById('abd-group').value;
            const phone = document.getElementById('abd-phone').value;
            if (!name || !group || !phone) return alert('সব ফিল্ড পূরণ করুন');
            await addDoc(collection(db, "blood_donors"), { name, bloodGroup: group, phone, createdAt: serverTimestamp() });
            showToast('রক্তদাতা যোগ হয়েছে');
            document.getElementById('abd-name').value = '';
            document.getElementById('abd-group').value = '';
            document.getElementById('abd-phone').value = '';
            loadAdminBloodDonors();
        };

        // Admin Emergency (unchanged)
        async function loadAdminEmergency() {
            const list = document.getElementById('admin-emergency-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "emergency"), orderBy("createdAt", "desc")));
            list.innerHTML = '';
            snaps.forEach(doc => {
                const data = doc.data();
                list.innerHTML += `
                    <div class="admin-banner-item">
                        <div><b>${data.name}</b> - ${data.phone}</div>
                        <div>
                            <button onclick="editEmergency('${doc.id}', '${data.name}', '${data.phone}')" class="action-btn" style="background:var(--primary)">Edit</button>
                            <button onclick="deleteEmergency('${doc.id}')" class="action-btn" style="background:var(--danger)">Del</button>
                        </div>
                    </div>
                `;
            });
        }

        window.editEmergency = (id, name, phone) => {
            const newName = prompt('নাম পরিবর্তন করুন:', name);
            if (newName === null) return;
            const newPhone = prompt('ফোন নম্বর পরিবর্তন করুন:', phone);
            if (newPhone === null) return;
            updateDoc(doc(db, "emergency", id), { name: newName, phone: newPhone });
            showToast('আপডেট হয়েছে');
            loadAdminEmergency();
        };

        window.deleteEmergency = async (id) => {
            if (confirm('ডিলিট করতে চান?')) {
                await deleteDoc(doc(db, "emergency", id));
                loadAdminEmergency();
                showToast('ডিলিট হয়েছে');
            }
        };

        document.getElementById('aem-add').onclick = async () => {
            const name = document.getElementById('aem-name').value;
            const phone = document.getElementById('aem-phone').value;
            if (!name || !phone) return alert('নাম ও ফোন দিন');
            await addDoc(collection(db, "emergency"), { name, phone, createdAt: serverTimestamp() });
            showToast('জরুরী সেবা যোগ হয়েছে');
            document.getElementById('aem-name').value = '';
            document.getElementById('aem-phone').value = '';
            loadAdminEmergency();
        };

        // Admin Agri (unchanged)
        async function loadAdminAgri() {
            const list = document.getElementById('admin-agri-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "agri_info"), orderBy("createdAt", "desc")));
            list.innerHTML = '';
            snaps.forEach(doc => {
                const data = doc.data();
                list.innerHTML += `
                    <div class="admin-banner-item">
                        <div><b>${data.title}</b> - ${data.contact || ''}</div>
                        <div>
                            <button onclick="editAgri('${doc.id}', '${data.title}', '${data.description}', '${data.contact}')" class="action-btn" style="background:var(--primary)">Edit</button>
                            <button onclick="deleteAgri('${doc.id}')" class="action-btn" style="background:var(--danger)">Del</button>
                        </div>
                    </div>
                `;
            });
        }

        window.editAgri = (id, title, desc, contact) => {
            const newTitle = prompt('শিরোনাম পরিবর্তন করুন:', title);
            if (newTitle === null) return;
            const newDesc = prompt('বিবরণ পরিবর্তন করুন:', desc);
            if (newDesc === null) return;
            const newContact = prompt('যোগাযোগ পরিবর্তন করুন:', contact);
            if (newContact === null) return;
            updateDoc(doc(db, "agri_info", id), { title: newTitle, description: newDesc, contact: newContact });
            showToast('আপডেট হয়েছে');
            loadAdminAgri();
        };

        window.deleteAgri = async (id) => {
            if (confirm('ডিলিট করতে চান?')) {
                await deleteDoc(doc(db, "agri_info", id));
                loadAdminAgri();
                showToast('ডিলিট হয়েছে');
            }
        };

        document.getElementById('aag-add').onclick = async () => {
            const title = document.getElementById('aag-title').value;
            const desc = document.getElementById('aag-desc').value;
            const contact = document.getElementById('aag-contact').value;
            if (!title || !desc) return alert('শিরোনাম ও বিবরণ দিন');
            await addDoc(collection(db, "agri_info"), { title, description: desc, contact, createdAt: serverTimestamp() });
            showToast('কৃষি তথ্য যোগ হয়েছে');
            document.getElementById('aag-title').value = '';
            document.getElementById('aag-desc').value = '';
            document.getElementById('aag-contact').value = '';
            loadAdminAgri();
        };

        // Admin Transport (unchanged)
        document.getElementById('ad-photo')?.addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('ad-preview').src = event.target.result;
                    document.getElementById('ad-preview').style.display = 'block';
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        async function loadAdminDrivers() {
            const list = document.getElementById('admin-driver-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "drivers"), orderBy("updatedAt", "desc")));
            list.innerHTML = '';
            snaps.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `
                    <div class="admin-banner-item">
                        <div><b>${d.name}</b> (${d.vehicleType}) - ${d.phone}</div>
                        <div>
                            <button onclick="editDriver('${doc.id}', '${d.name}', '${d.phone}', '${d.vehicleType}')" class="action-btn" style="background:var(--primary)">Edit</button>
                            <button onclick="deleteDriver('${doc.id}')" class="action-btn" style="background:var(--danger)">Del</button>
                        </div>
                    </div>
                `;
            });
        }

        window.editDriver = (id, name, phone, vehicle) => {
            const newName = prompt('নাম পরিবর্তন করুন:', name);
            if (newName === null) return;
            const newPhone = prompt('মোবাইল পরিবর্তন করুন:', phone);
            if (newPhone === null) return;
            const newVehicle = prompt('গাড়ির ধরন পরিবর্তন করুন:', vehicle);
            if (newVehicle === null) return;
            updateDoc(doc(db, "drivers", id), { name: newName, phone: newPhone, vehicleType: newVehicle });
            showToast('আপডেট হয়েছে');
            loadAdminDrivers();
        };

        window.deleteDriver = async (id) => {
            if (confirm('ড্রাইভার ডিলিট করতে চান?')) {
                await deleteDoc(doc(db, "drivers", id));
                loadAdminDrivers();
                showToast('ডিলিট হয়েছে');
            }
        };

        document.getElementById('ad-add').onclick = async () => {
            const name = document.getElementById('ad-name').value;
            const phone = document.getElementById('ad-phone').value;
            const vehicle = document.getElementById('ad-vehicle').value;
            if (!name || !phone || !vehicle) return alert('নাম, মোবাইল ও গাড়ির ধরন দিন');
            
            let photoURL = '';
            const file = document.getElementById('ad-photo').files[0];
            if (file) {
                const finish = showLoading(document.getElementById('ad-add'));
                try {
                    photoURL = await uploadToCloudinary(file);
                } catch (err) {
                    finish();
                    alert('ছবি আপলোড ব্যর্থ');
                    return;
                }
                finish();
            }

            await addDoc(collection(db, "drivers"), {
                name, phone, vehicleType: vehicle, photoURL, createdAt: serverTimestamp(), updatedAt: serverTimestamp()
            });
            showToast('ড্রাইভার যোগ হয়েছে');
            document.getElementById('ad-name').value = '';
            document.getElementById('ad-phone').value = '';
            document.getElementById('ad-vehicle').value = '';
            document.getElementById('ad-photo').value = '';
            document.getElementById('ad-preview').style.display = 'none';
            loadAdminDrivers();
        };

        document.getElementById('admin-driver-search')?.addEventListener('input', function(e) {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll('#admin-driver-list .admin-banner-item').forEach(el => {
                const text = el.innerText.toLowerCase();
                el.style.display = text.includes(q) ? 'flex' : 'none';
            });
        });

        // ========== WEATHER ==========
        window.loadWeather = async function() {
            document.getElementById('weather-loading').style.display = 'block';
            document.getElementById('weather-content').style.display = 'none';
            const lat = 22.95;
            const lon = 89.68;
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=10`);
                const data = await res.json();
                
                const current = data.current_weather;
                const daily = data.daily;
                
                document.getElementById('weather-today').innerText = current.temperature + '°C';
                const todayCondition = getWeatherCondition(current.weathercode);
                document.getElementById('weather-today-condition').innerText = todayCondition;
                
                const tomorrowTemp = daily.temperature_2m_max[1] + '°C';
                const tomorrowCode = daily.weathercode[1];
                document.getElementById('weather-tomorrow').innerText = tomorrowTemp;
                document.getElementById('weather-tomorrow-condition').innerText = getWeatherCondition(tomorrowCode);
                
                let forecastHtml = '';
                for (let i = 0; i < daily.time.length; i++) {
                    const date = new Date(daily.time[i]).toLocaleDateString('bn-BD', { weekday: 'short', day: 'numeric', month: 'short' });
                    const max = daily.temperature_2m_max[i];
                    const min = daily.temperature_2m_min[i];
                    const code = daily.weathercode[i];
                    const condition = getWeatherCondition(code);
                    forecastHtml += `
                        <div class="weather-forecast-item">
                            <span style="font-weight: 600;">${date}</span>
                            <span>${condition}</span>
                            <span><span style="color:var(--danger);">${max}°</span> / <span style="color:var(--primary);">${min}°</span></span>
                        </div>
                    `;
                }
                document.getElementById('weather-forecast').innerHTML = forecastHtml;
                
                setWeatherAnimation(current.weathercode);
                
                document.getElementById('weather-loading').style.display = 'none';
                document.getElementById('weather-content').style.display = 'block';
            } catch (e) {
                document.getElementById('weather-loading').innerHTML = 'ডেটা লোড করতে সমস্যা হয়েছে';
            }
        };

        function setWeatherAnimation(code) {
            const animDiv = document.getElementById('weather-animation');
            animDiv.innerHTML = '';
            if (code >= 51 && code <= 55) {
                animDiv.innerHTML = '<div class="rain"></div>';
            } else if (code >= 61 && code <= 65) {
                animDiv.innerHTML = '<div class="rain heavy"></div>';
            } else if (code === 1 || code === 2 || code === 3) {
                animDiv.innerHTML = '<div class="cloud"></div>';
            } else if (code === 0) {
                animDiv.innerHTML = '<div class="sun"></div>';
            } else if (code >= 45 && code <= 48) {
                animDiv.innerHTML = '<div class="wind"></div><div class="wind"></div><div class="wind"></div>';
            } else {
            }
        }

        function getWeatherCondition(code) {
            if (code === 0) return 'পরিষ্কার';
            if (code === 1 || code === 2 || code === 3) return 'আংশিক মেঘলা';
            if (code >= 45 && code <= 48) return 'কুয়াশা';
            if (code >= 51 && code <= 55) return 'হালকা বৃষ্টি';
            if (code >= 61 && code <= 65) return 'বৃষ্টি';
            if (code >= 71 && code <= 75) return 'তুষার';
            if (code >= 80 && code <= 82) return 'ঝড়ো বৃষ্টি';
            return 'অন্যান্য';
        }

        // ========== NEW EMERGENCY SERVICES ==========
        async function loadAmbulance() {
            const list = document.getElementById('ambulance-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "ambulance"), orderBy("createdAt", "desc")));
            renderEmergencyList(list, snaps);
        }
        async function loadPolice() {
            const list = document.getElementById('police-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "police"), orderBy("createdAt", "desc")));
            renderEmergencyList(list, snaps);
        }
        async function loadFire() {
            const list = document.getElementById('fire-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "fire"), orderBy("createdAt", "desc")));
            renderEmergencyList(list, snaps);
        }
        function renderEmergencyList(container, snaps) {
            container.innerHTML = '';
            if (snaps.empty) {
                container.innerHTML = '<p style="text-align:center; color:#94a3b8">কোনো তথ্য নেই</p>';
                return;
            }
            snaps.forEach(doc => {
                const data = doc.data();
                container.innerHTML += `
                    <div class="list-item">
                        <div><h4 style="margin:0">${data.name}</h4><small>${data.phone}</small></div>
                        <a href="tel:${data.phone}" class="call-btn" style="background:#e0f2fe; color:var(--primary)"><span class="material-icons-round">call</span></a>
                    </div>
                `;
            });
        }

        // Admin functions for Ambulance, Police, Fire (unchanged)
        async function loadAdminAmbulance() {
            const list = document.getElementById('admin-ambulance-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "ambulance"), orderBy("createdAt", "desc")));
            renderAdminEmergencyList(list, snaps, 'ambulance');
        }
        async function loadAdminPolice() {
            const list = document.getElementById('admin-police-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "police"), orderBy("createdAt", "desc")));
            renderAdminEmergencyList(list, snaps, 'police');
        }
        async function loadAdminFire() {
            const list = document.getElementById('admin-fire-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "fire"), orderBy("createdAt", "desc")));
            renderAdminEmergencyList(list, snaps, 'fire');
        }
        function renderAdminEmergencyList(container, snaps, type) {
            container.innerHTML = '';
            snaps.forEach(doc => {
                const data = doc.data();
                container.innerHTML += `
                    <div class="admin-banner-item">
                        <div><b>${data.name}</b> - ${data.phone}</div>
                        <div>
                            <button onclick="editEmergencyItem('${type}', '${doc.id}', '${data.name}', '${data.phone}')" class="action-btn" style="background:var(--primary)">Edit</button>
                            <button onclick="deleteEmergencyItem('${type}', '${doc.id}')" class="action-btn" style="background:var(--danger)">Del</button>
                        </div>
                    </div>
                `;
            });
        }
        window.editEmergencyItem = async (type, id, name, phone) => {
            const newName = prompt('নাম পরিবর্তন করুন:', name);
            if (newName === null) return;
            const newPhone = prompt('ফোন নম্বর পরিবর্তন করুন:', phone);
            if (newPhone === null) return;
            await updateDoc(doc(db, type, id), { name: newName, phone: newPhone });
            showToast('আপডেট হয়েছে');
            if (type === 'ambulance') loadAdminAmbulance();
            else if (type === 'police') loadAdminPolice();
            else if (type === 'fire') loadAdminFire();
        };
        window.deleteEmergencyItem = async (type, id) => {
            if (confirm('ডিলিট করতে চান?')) {
                await deleteDoc(doc(db, type, id));
                showToast('ডিলিট হয়েছে');
                if (type === 'ambulance') loadAdminAmbulance();
                else if (type === 'police') loadAdminPolice();
                else if (type === 'fire') loadAdminFire();
            }
        };

        document.getElementById('aamb-add').onclick = async () => {
            const name = document.getElementById('aamb-name').value;
            const phone = document.getElementById('aamb-phone').value;
            if (!name || !phone) return alert('নাম ও ফোন দিন');
            await addDoc(collection(db, "ambulance"), { name, phone, createdAt: serverTimestamp() });
            showToast('যোগ হয়েছে');
            document.getElementById('aamb-name').value = '';
            document.getElementById('aamb-phone').value = '';
            loadAdminAmbulance();
        };
        document.getElementById('apol-add').onclick = async () => {
            const name = document.getElementById('apol-name').value;
            const phone = document.getElementById('apol-phone').value;
            if (!name || !phone) return alert('নাম ও ফোন দিন');
            await addDoc(collection(db, "police"), { name, phone, createdAt: serverTimestamp() });
            showToast('যোগ হয়েছে');
            document.getElementById('apol-name').value = '';
            document.getElementById('apol-phone').value = '';
            loadAdminPolice();
        };
        document.getElementById('afire-add').onclick = async () => {
            const name = document.getElementById('afire-name').value;
            const phone = document.getElementById('afire-phone').value;
            if (!name || !phone) return alert('নাম ও ফোন দিন');
            await addDoc(collection(db, "fire"), { name, phone, createdAt: serverTimestamp() });
            showToast('যোগ হয়েছে');
            document.getElementById('afire-name').value = '';
            document.getElementById('afire-phone').value = '';
            loadAdminFire();
        };

        // ========== IMPORTANT PERSONS ==========
        // Admin Management
        document.getElementById('ip-image')?.addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('ip-preview').src = event.target.result;
                    document.getElementById('ip-preview').style.display = 'block';
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        async function loadAdminImportantPersons() {
            const list = document.getElementById('admin-importantpersons-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "important_persons"), orderBy("createdAt", "desc")));
            list.innerHTML = '';
            if (snaps.empty) {
                list.innerHTML = '<p style="text-align:center; color:#94a3b8;">কোনো ব্যক্তি নেই</p>';
                return;
            }
            snaps.forEach(doc => {
                const data = doc.data();
                list.innerHTML += `
                    <div class="admin-banner-item">
                        <div style="flex:1"><b>${data.name}</b> ${data.phone ? '- ' + data.phone : ''}</div>
                        <div>
                            <button onclick="editImportantPerson('${doc.id}', '${data.name}', '${data.phone || ''}', '${data.description || ''}', '${data.imageUrl || ''}')" class="action-btn" style="background:var(--primary)">Edit</button>
                            <button onclick="deleteImportantPerson('${doc.id}')" class="action-btn" style="background:var(--danger)">Del</button>
                        </div>
                    </div>
                `;
            });
        }

        window.editImportantPerson = (id, name, phone, desc, img) => {
            const newName = prompt('নাম পরিবর্তন করুন:', name);
            if (newName === null) return;
            const newPhone = prompt('মোবাইল নম্বর পরিবর্তন করুন:', phone);
            if (newPhone === null) return;
            const newDesc = prompt('বিস্তারিত পরিবর্তন করুন:', desc);
            if (newDesc === null) return;
            updateDoc(doc(db, "important_persons", id), { name: newName, phone: newPhone, description: newDesc });
            showToast('আপডেট হয়েছে');
            loadAdminImportantPersons();
            loadImportantPersons();
        };

        window.deleteImportantPerson = async (id) => {
            if (confirm('ডিলিট করতে চান?')) {
                await deleteDoc(doc(db, "important_persons", id));
                showToast('ডিলিট হয়েছে');
                loadAdminImportantPersons();
                loadImportantPersons();
            }
        };

        document.getElementById('ip-add').onclick = async () => {
            const name = document.getElementById('ip-name').value;
            const phone = document.getElementById('ip-phone').value;
            const desc = document.getElementById('ip-desc').value;
            if (!name) return alert('নাম দিন');
            let imageUrl = '';
            const file = document.getElementById('ip-image').files[0];
            if (file) {
                const finish = showLoading(document.getElementById('ip-add'));
                try {
                    imageUrl = await uploadToCloudinary(file);
                } catch (err) {
                    finish();
                    alert('ছবি আপলোড ব্যর্থ');
                    return;
                }
                finish();
            }
            await addDoc(collection(db, "important_persons"), {
                name,
                phone,
                description: desc,
                imageUrl,
                createdAt: serverTimestamp()
            });
            showToast('গুরুত্বপূর্ণ ব্যক্তি যোগ হয়েছে');
            document.getElementById('ip-name').value = '';
            document.getElementById('ip-phone').value = '';
            document.getElementById('ip-desc').value = '';
            document.getElementById('ip-image').value = '';
            document.getElementById('ip-preview').style.display = 'none';
            loadAdminImportantPersons();
        };

        // Frontend display
        async function loadImportantPersons() {
            const grid = document.getElementById('important-persons-grid');
            grid.innerHTML = '<p style="text-align:center; color:#94a3b8">লোড হচ্ছে...</p>';
            const snaps = await getDocs(query(collection(db, "important_persons"), orderBy("createdAt", "desc")));
            if (snaps.empty) {
                grid.innerHTML = '<p style="text-align:center; color:#94a3b8">কোনো তথ্য নেই</p>';
                return;
            }
            grid.innerHTML = '';
            snaps.forEach(doc => {
                const data = doc.data();
                const id = doc.id;
                const card = document.createElement('div');
                card.className = 'imp-person-card';
                card.onclick = () => showImportantPerson(data);
                const avatarHtml = data.imageUrl ? `<img src="${data.imageUrl}">` : `<span class="material-icons-round">person</span>`;
                card.innerHTML = `
                    <div class="imp-person-avatar">${avatarHtml}</div>
                    <div class="imp-person-name">${data.name}</div>
                `;
                grid.appendChild(card);
            });
        }

        function showImportantPerson(data) {
            document.getElementById('ipm-name').innerText = data.name;
            document.getElementById('ipm-desc').innerText = data.description || '';
            document.getElementById('ipm-phone').innerText = data.phone || '-';
            const avImg = document.getElementById('ipm-av-img');
            const avText = document.getElementById('ipm-av-text');
            if (data.imageUrl) {
                avImg.src = data.imageUrl;
                avImg.style.display = 'block';
                avText.style.display = 'none';
            } else {
                avImg.style.display = 'none';
                avText.innerText = data.name.charAt(0);
                avText.style.display = 'block';
            }
            const callBtn = document.getElementById('ipm-call');
            if (data.phone) {
                callBtn.href = `tel:${data.phone}`;
                callBtn.style.display = 'flex';
            } else {
                callBtn.style.display = 'none';
            }
            openModal('important-person-modal');
        }

        // ========== DOCTOR MODULE ==========
        // Admin Doctors
        document.getElementById('doc-image')?.addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('doc-preview').src = event.target.result;
                    document.getElementById('doc-preview').style.display = 'block';
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        async function loadAdminDoctors(search = '') {
            const list = document.getElementById('admin-doctor-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "doctors"), orderBy("updatedAt", "desc")));
            let doctors = [];
            snaps.forEach(doc => doctors.push({ id: doc.id, ...doc.data() }));

            if (search) {
                const q = search.toLowerCase();
                doctors = doctors.filter(d => 
                    d.name?.toLowerCase().includes(q) || 
                    d.phone?.includes(q)
                );
            }

            list.innerHTML = '';
            if (doctors.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#94a3b8;">কোনো ডাক্তার নেই</p>';
                return;
            }
            doctors.forEach(d => {
                list.innerHTML += `
                    <div class="admin-banner-item">
                        <div style="flex:1"><b>${d.name}</b> - ${d.phone}</div>
                        <div>
                            <button onclick="editDoctor('${d.id}', '${d.name}', '${d.phone}')" class="action-btn" style="background:var(--primary)">Edit</button>
                            <button onclick="deleteDoctor('${d.id}')" class="action-btn" style="background:var(--danger)">Del</button>
                        </div>
                    </div>
                `;
            });
        }

        window.editDoctor = (id, name, phone) => {
            const newName = prompt('নাম পরিবর্তন করুন:', name);
            if (newName === null) return;
            const newPhone = prompt('মোবাইল নম্বর পরিবর্তন করুন:', phone);
            if (newPhone === null) return;
            updateDoc(doc(db, "doctors", id), { name: newName, phone: newPhone });
            showToast('আপডেট হয়েছে');
            loadAdminDoctors();
        };

        window.deleteDoctor = async (id) => {
            if (confirm('ডিলিট করতে চান?')) {
                await deleteDoc(doc(db, "doctors", id));
                showToast('ডিলিট হয়েছে');
                loadAdminDoctors();
            }
        };

        document.getElementById('doc-add').onclick = async () => {
            const name = document.getElementById('doc-name').value;
            const phone = document.getElementById('doc-phone').value;
            if (!name || !phone) return alert('নাম ও মোবাইল দিন');
            
            let photoURL = '';
            const file = document.getElementById('doc-image').files[0];
            if (file) {
                const finish = showLoading(document.getElementById('doc-add'));
                try {
                    photoURL = await uploadToCloudinary(file);
                } catch (err) {
                    finish();
                    alert('ছবি আপলোড ব্যর্থ');
                    return;
                }
                finish();
            }

            await addDoc(collection(db, "doctors"), {
                name, phone, photoURL, createdAt: serverTimestamp(), updatedAt: serverTimestamp()
            });
            showToast('ডাক্তার যোগ হয়েছে');
            document.getElementById('doc-name').value = '';
            document.getElementById('doc-phone').value = '';
            document.getElementById('doc-image').value = '';
            document.getElementById('doc-preview').style.display = 'none';
            loadAdminDoctors();
        };

        document.getElementById('admin-doctor-search')?.addEventListener('input', function(e) {
            loadAdminDoctors(e.target.value);
        });

        // Frontend load doctors
        async function loadDoctors(search = '') {
            const list = document.getElementById('doctor-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "doctors"), orderBy("updatedAt", "desc")));
            let doctors = [];
            snaps.forEach(doc => doctors.push({ id: doc.id, ...doc.data() }));

            if (search) {
                const q = search.toLowerCase();
                doctors = doctors.filter(d => 
                    d.name?.toLowerCase().includes(q) || 
                    d.phone?.includes(q)
                );
            }

            list.innerHTML = '';
            if (doctors.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#94a3b8">কোনো ডাক্তার পাওয়া যায়নি</p>';
                return;
            }
            doctors.forEach(d => {
                const card = document.createElement('div');
                card.className = 'driver-card';
                card.innerHTML = `
                    <div class="driver-avatar">
                        ${d.photoURL ? `<img src="${d.photoURL}">` : '<span class="material-icons-round" style="font-size:40px; line-height:60px; text-align:center; width:100%; color:#94a3b8">person</span>'}
                    </div>
                    <div class="driver-info">
                        <h4>${d.name}</h4>
                        <p><span class="material-icons-round" style="font-size:16px; vertical-align:middle;">phone</span> ${d.phone}</p>
                    </div>
                    <a href="tel:${d.phone}" class="driver-call"><span class="material-icons-round">call</span> কল</a>
                `;
                list.appendChild(card);
            });
        }

        document.getElementById('doctor-search')?.addEventListener('input', (e) => {
            loadDoctors(e.target.value);
        });

        // ========== MARKET PRICE MODULE ==========
        // Admin Market Prices
        async function loadAdminMarketPrices() {
            const list = document.getElementById('admin-marketprice-list');
            list.innerHTML = 'লোড হচ্ছে...';
            const snaps = await getDocs(query(collection(db, "market_prices"), orderBy("createdAt", "desc")));
            list.innerHTML = '';
            if (snaps.empty) {
                list.innerHTML = '<p style="text-align:center; color:#94a3b8;">কোনো পণ্য নেই</p>';
                return;
            }
            snaps.forEach(doc => {
                const data = doc.data();
                list.innerHTML += `
                    <div class="admin-banner-item">
                        <div style="flex:1"><b>${data.commodity}</b> - ${data.price} টাকা/${data.unit}</div>
                        <div>
                            <button onclick="editMarketPrice('${doc.id}', '${data.commodity}', '${data.price}', '${data.unit}')" class="action-btn" style="background:var(--primary)">Edit</button>
                            <button onclick="deleteMarketPrice('${doc.id}')" class="action-btn" style="background:var(--danger)">Del</button>
                        </div>
                    </div>
                `;
            });
        }

        window.editMarketPrice = (id, commodity, price, unit) => {
            const newCommodity = prompt('পণ্যের নাম পরিবর্তন করুন:', commodity);
            if (newCommodity === null) return;
            const newPrice = prompt('মূল্য পরিবর্তন করুন:', price);
            if (newPrice === null) return;
            const newUnit = prompt('একক পরিবর্তন করুন:', unit);
            if (newUnit === null) return;
            updateDoc(doc(db, "market_prices", id), { commodity: newCommodity, price: parseFloat(newPrice), unit: newUnit });
            showToast('আপডেট হয়েছে');
            loadAdminMarketPrices();
        };

        window.deleteMarketPrice = async (id) => {
            if (confirm('ডিলিট করতে চান?')) {
                await deleteDoc(doc(db, "market_prices", id));
                showToast('ডিলিট হয়েছে');
                loadAdminMarketPrices();
            }
        };

        document.getElementById('mp-add').onclick = async () => {
            const commodity = document.getElementById('mp-commodity').value;
            const price = document.getElementById('mp-price').value;
            const unit = document.getElementById('mp-unit').value;
            if (!commodity || !price || !unit) return alert('সব ফিল্ড পূরণ করুন');
            await addDoc(collection(db, "market_prices"), {
                commodity,
                price: parseFloat(price),
                unit,
                createdAt: serverTimestamp()
            });
            showToast('পণ্য যোগ হয়েছে');
            document.getElementById('mp-commodity').value = '';
            document.getElementById('mp-price').value = '';
            document.getElementById('mp-unit').value = '';
            loadAdminMarketPrices();
        };

        // Frontend load market prices with real-time listener
        function loadMarketPrices() {
            const grid = document.getElementById('market-price-grid');
            grid.innerHTML = '<p style="text-align:center; color:#94a3b8">লোড হচ্ছে...</p>';
            const q = query(collection(db, "market_prices"), orderBy("commodity", "asc"));
            onSnapshot(q, (snapshot) => {
                grid.innerHTML = '';
                if (snapshot.empty) {
                    grid.innerHTML = '<p style="text-align:center; color:#94a3b8">কোনো দর তথ্য নেই</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    grid.innerHTML += `
                        <div class="market-price-card">
                            <div class="commodity-name">${data.commodity}</div>
                            <div class="price">${data.price}</div>
                            <div class="unit">টাকা/${data.unit}</div>
                        </div>
                    `;
                });
            });
        }

        // ========== MESSENGER DEEP LINK ==========
        window.openMessengerDeepLink = () => {
            // Try to open Messenger app directly, fallback to web
            const groupLink = 'https://m.me/j/Abaz6EIudL4KyMZP/';
            // For Android, we can use intent
            if (/android/i.test(navigator.userAgent)) {
                window.location.href = 'intent://m.me/j/Abaz6EIudL4KyMZP/#Intent;scheme=https;package=com.facebook.orca;end';
            } else {
                window.open(groupLink, '_blank');
            }
        };

        // ========== INIT ==========
        setupProfessionListeners();
        updateDateTime();

        // Register Service Worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('SW registered: ', registration);
                }).catch(error => {
                    console.log('SW registration failed: ', error);
                });
            });
        }
    </script>
</body>
                            </html>
