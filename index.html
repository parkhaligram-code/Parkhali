<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¶™‡¶æ‡¶∞‡¶ñ‡¶æ‡¶≤‡ßÄ ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        /* ================== PREMIUM THEME VARIABLES ================== */
        :root { 
            --primary: #2563eb;       /* Modern Blue */
            --primary-dark: #1e40af;
            --accent: #10b981;        /* Success Green */
            --danger: #ef4444;        /* Error Red */
            --surface: #ffffff;       /* Card BG */
            --background: #f1f5f9;    /* App BG */
            --text-main: #0f172a;
            --text-sub: #64748b;
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --header-gradient: linear-gradient(135deg, #2563eb, #0891b2);
        }

        /* ================== RESET & LAYOUT ================== */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            font-family: 'Hind Siliguri', sans-serif; 
            margin: 0; padding: 0; 
            background-color: var(--background); 
            color: var(--text-main); 
            padding-bottom: 85px; /* Space for Bottom Nav */
        }
        
        .container { 
            max-width: 480px; margin: 0 auto; min-height: 100vh; 
            position: relative; background: var(--background); 
            box-shadow: 0 0 20px rgba(0,0,0,0.05); 
        }

        /* ================== COMPACT HEADER ================== */
        header { 
            background: var(--header-gradient); 
            color: white; 
            padding: 1rem 1.2rem 2.5rem; /* Reduced Padding */
            border-bottom-left-radius: 24px; 
            border-bottom-right-radius: 24px; 
            position: relative; z-index: 10;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.2);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .app-name { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 6px; letter-spacing: 0.5px; }
        .logout-btn { 
            background: rgba(255,255,255,0.2); border: none; color: white; 
            padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; 
            display: none; align-items: center; gap: 4px; cursor: pointer; backdrop-filter: blur(4px);
        }
        .hero-text h2 { font-size: 1.4rem; margin: 0; font-weight: 700; }
        .hero-text p { font-size: 0.85rem; opacity: 0.9; margin: 0; font-family: 'Poppins', sans-serif; }

        /* ================== MAIN CONTENT ================== */
        main { padding: 0 1rem; margin-top: -1.8rem; position: relative; z-index: 20; }

        .card { 
            background: var(--surface); padding: 1.2rem; border-radius: var(--radius); 
            box-shadow: var(--shadow); margin-bottom: 1rem; border: 1px solid white;
        }
        .section-title { 
            font-size: 1rem; font-weight: 700; color: var(--text-main); 
            margin-bottom: 0.8rem; display: flex; align-items: center; gap: 6px; 
        }

        /* ================== 16:7 BANNER ================== */
        .banner-wrapper {
            position: relative; width: 100%; 
            padding-top: 43.75%; /* 16:7 Aspect Ratio Calculation */
            border-radius: var(--radius); overflow: hidden; 
            background: #e2e8f0; margin-bottom: 1rem;
            box-shadow: var(--shadow);
        }
        .banner-slide {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0; transition: opacity 0.5s ease-in-out;
        }
        .banner-slide.active { opacity: 1; }

        /* ================== VILLAGER LIST (Fixed) ================== */
        .search-box { 
            position: sticky; top: 0; background: var(--background); 
            z-index: 30; padding: 10px 0; 
        }
        .search-input {
            width: 100%; padding: 12px 15px 12px 40px; border: none; 
            border-radius: 50px; background: white; 
            box-shadow: var(--shadow); font-family: inherit;
        }
        .search-icon-overlay { position: absolute; left: 15px; top: 22px; color: #94a3b8; }
        
        .villager-card {
            display: flex; align-items: center; justify-content: space-between;
            background: white; padding: 12px; border-radius: 12px;
            margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer; transition: 0.2s;
        }
        .villager-card:active { transform: scale(0.98); background: #f8fafc; }
        .v-avatar { 
            width: 42px; height: 42px; background: #eff6ff; color: var(--primary); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: 700; margin-right: 12px; font-size: 18px; 
        }
        .v-info h4 { margin: 0; font-size: 0.95rem; color: var(--text-main); }
        .v-info p { margin: 2px 0 0; font-size: 0.75rem; color: var(--text-sub); }
        .v-action { 
            width: 36px; height: 36px; background: #f0fdf4; color: var(--accent); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
        }

        /* ================== BUTTONS & INPUTS ================== */
        .btn-primary { 
            width: 100%; padding: 12px; background: var(--primary); color: white; 
            border: none; border-radius: 12px; font-weight: 600; font-size: 0.95rem; 
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .btn-large-option {
            width: 100%; padding: 15px; background: white; color: var(--primary);
            border: 1px solid #eff6ff; border-radius: var(--radius);
            font-weight: 600; font-size: 1rem; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            box-shadow: var(--shadow); margin-bottom: 1rem;
        }
        .input-group { 
            width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; 
            border-radius: 10px; background: #f8fafc; font-family: inherit; 
        }
        .input-group:focus { border-color: var(--primary); background: white; }

        /* ================== SERVICES GRID ================== */
        .service-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .service-box { 
            background: white; padding: 15px; border-radius: var(--radius); text-align: center; 
            box-shadow: var(--shadow); cursor: pointer; border: 1px solid transparent; 
        }
        .service-box:active { border-color: var(--primary); transform: scale(0.98); }
        .s-icon { 
            width: 50px; height: 50px; border-radius: 14px; margin: 0 auto 8px; 
            display: flex; align-items: center; justify-content: center; font-size: 24px; 
        }

        /* ================== BOTTOM NAV ================== */
        .bottom-nav {
            position: fixed; bottom: 15px; left: 15px; right: 15px; max-width: 450px; margin: 0 auto;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            padding: 10px 20px; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); z-index: 100;
            display: none; justify-content: space-between; align-items: center;
        }
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; color: #94a3b8; 
            cursor: pointer; font-size: 0.7rem; font-weight: 600; flex: 1; transition: 0.3s;
        }
        .nav-item.active { color: var(--primary); }
        .nav-item .material-icons-round { font-size: 24px; margin-bottom: 2px; }
        
        .nav-fab {
            width: 55px; height: 55px; background: var(--primary); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4); border: 3px solid white;
            margin-top: -30px; transition: 0.2s;
        }
        .nav-fab:active { transform: scale(0.9); }

        /* ================== MODALS ================== */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
            z-index: 200; display: none; align-items: flex-end; justify-content: center;
        }
        .modal-sheet {
            background: white; width: 100%; max-width: 480px;
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 1.5rem; max-height: 85vh; overflow-y: auto;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-overlay.show .modal-sheet { transform: translateY(0); }
        
        /* Splash & Success */
        #splash { position: fixed; inset: 0; background: var(--header-gradient); z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; flex-direction: column; transition: 0.5s; }
        .hidden { opacity: 0; visibility: hidden; }
        
        /* Admin */
        .admin-item { display: flex; justify-content: space-between; padding: 10px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem; }
        .banner-preview { height: 60px; border-radius: 8px; object-fit: cover; }
    </style>
</head>
<body>

    <div id="splash">
        <span class="material-icons-round" style="font-size: 60px; animation: pulse 2s infinite">holiday_village</span>
        <h1 style="margin: 10px 0 0; font-size: 1.8rem;">‡¶™‡¶æ‡¶∞‡¶ñ‡¶æ‡¶≤‡ßÄ</h1>
        <p style="margin:0; opacity: 0.8; font-size: 0.9rem;">‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶≠‡¶ø‡¶≤‡ßá‡¶ú ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™</p>
    </div>

    <div class="container">
        <header>
            <div class="header-top">
                <div class="app-name"><span class="material-icons-round">widgets</span> ‡¶™‡¶æ‡¶∞‡¶ñ‡¶æ‡¶≤‡ßÄ</div>
                <button id="logout-btn" class="logout-btn"><span class="material-icons-round" style="font-size: 14px;">logout</span> ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
            </div>
            <div class="hero-text" id="hero-text">
                <h2>‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ!</h2>
                <p>‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶∏‡ßá‡¶¨‡¶æ‡¶Ø‡¶º ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ</p>
            </div>
        </header>

        <main>
            <div id="auth-view" style="display: none; padding-top: 1rem;">
                <div class="card" style="text-align: center;">
                    <h3 style="margin-bottom: 1rem; color: var(--primary);">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <input type="email" id="email" class="input-group" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤">
                    <input type="password" id="pass" class="input-group" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°">
                    <button id="login-btn" class="btn-primary">‡¶≤‡¶ó‡¶á‡¶®</button>
                    <p style="font-size: 0.85rem; margin-top: 15px;">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? <b style="color:var(--primary); cursor:pointer" onclick="toggleAuth(false)">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®</b></p>
                </div>
            </div>

            <div id="reg-view" style="display: none; padding-top: 1rem;">
                <div class="card">
                    <h3 style="margin-bottom: 1rem; color: var(--accent);">‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</h3>
                    <input type="email" id="reg-email" class="input-group" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤">
                    <input type="password" id="reg-pass" class="input-group" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°">
                    <button id="reg-btn" class="btn-primary" style="background: var(--accent);">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞</button>
                    <p style="text-align: center; font-size: 0.85rem; margin-top: 15px;">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? <b style="color:var(--primary); cursor:pointer" onclick="toggleAuth(true)">‡¶≤‡¶ó‡¶á‡¶®</b></p>
                </div>
            </div>

            <div id="profile-form-view" style="display: none;">
                <div class="card">
                    <h3 style="margin-bottom: 5px;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®</h3>
                    <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 15px;">‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡¶¨‡¶æ‡¶∏‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡ßü ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶ö‡ßá‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø</p>
                    <input id="pf-name" class="input-group" placeholder="‡¶™‡ßÅ‡¶∞‡ßã ‡¶®‡¶æ‡¶Æ">
                    <input id="pf-prof" class="input-group" placeholder="‡¶™‡ßá‡¶∂‡¶æ (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶õ‡¶æ‡¶§‡ßç‡¶∞, ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï)">
                    <input type="tel" id="pf-phone" class="input-group" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞">
                    <select id="pf-blood" class="input-group">
                        <option value="">‡¶∞‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
                    </select>
                    <input id="pf-addr" class="input-group" placeholder="‡¶™‡¶æ‡ßú‡¶æ/‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
                    <button id="save-profile" class="btn-primary">‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </div>

            <div id="home-view" style="display: none;">
                <div class="banner-wrapper" id="banner-slider">
                    <div style="display:flex; justify-content:center; align-items:center; height:100%; color:#94a3b8; font-size:0.9rem;">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
                </div>

                <button class="btn-large-option" onclick="switchView('villagers')">
                    <span class="material-icons-round" style="color:var(--primary)">groups</span> ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡¶¨‡¶æ‡¶∏‡ßÄ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
                </button>

                <div class="section-title"><span class="material-icons-round" style="color:var(--primary)">campaign</span> ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶¨‡ßã‡¶∞‡ßç‡¶°</div>
                <div id="notice-list"><p style="text-align:center; font-size:0.85rem; color:#94a3b8">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p></div>
            </div>

            <div id="villagers-view" style="display: none;">
                <div class="search-box">
                    <span class="material-icons-round search-icon-overlay">search</span>
                    <input type="text" id="v-search" class="search-input" placeholder="‡¶®‡¶æ‡¶Æ, ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡¶æ ‡¶™‡ßá‡¶∂‡¶æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...">
                </div>
                <div id="villager-list-container" style="padding-bottom: 20px;">
                    <p style="text-align:center; font-size:0.9rem; color:#94a3b8; margin-top:20px;">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
                </div>
            </div>

            <div id="services-view" style="display: none;">
                <div class="section-title">‡¶ú‡¶®‡¶™‡ßç‡¶∞‡¶ø‡ßü ‡¶∏‡ßá‡¶¨‡¶æ‡¶∏‡¶Æ‡ßÇ‡¶π</div>
                <div class="service-grid">
                    <div class="service-box" onclick="openModal('blood-modal'); loadDonors()">
                        <div class="s-icon" style="background:#fee2e2; color:#ef4444"><span class="material-icons-round">bloodtype</span></div>
                        <div style="font-size:0.9rem; font-weight:600">‡¶¨‡ßç‡¶≤‡¶æ‡¶° ‡¶°‡ßã‡¶®‡¶æ‡¶∞</div>
                    </div>
                    <div class="service-box" onclick="openModal('emergency-modal')">
                        <div class="s-icon" style="background:#ffedd5; color:#f97316"><span class="material-icons-round">support_agent</span></div>
                        <div style="font-size:0.9rem; font-weight:600">‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶∏‡ßá‡¶¨‡¶æ</div>
                    </div>
                    <div class="service-box" onclick="openModal('agri-modal')">
                        <div class="s-icon" style="background:#dcfce7; color:#16a34a"><span class="material-icons-round">agriculture</span></div>
                        <div style="font-size:0.9rem; font-weight:600">‡¶ï‡ßÉ‡¶∑‡¶ø ‡¶§‡¶•‡ßç‡¶Ø</div>
                    </div>
                </div>
            </div>

            <div id="profile-view" style="display: none;">
                <div class="card" style="text-align:center">
                    <div style="width:70px; height:70px; background:var(--primary); color:white; border-radius:50%; font-size:30px; display:flex; align-items:center; justify-content:center; margin:0 auto 10px"><span class="material-icons-round">person</span></div>
                    <h3 id="mp-name" style="margin:0">Loading...</h3>
                    <p id="mp-role" style="margin:5px 0 0; color:#64748b; font-size:0.9rem">-</p>
                </div>
                <div class="card">
                    <div class="section-title">‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</div>
                    <input id="up-name" class="input-group" placeholder="‡¶®‡¶æ‡¶Æ">
                    <input id="up-phone" class="input-group" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤">
                    <button id="update-profile" class="btn-primary">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </div>

            <div id="admin-view" style="display: none;">
                <div class="section-title">‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</div>
                <div class="card">
                    <input id="ban-img" class="input-group" placeholder="Image URL">
                    <input id="ban-link" class="input-group" placeholder="Link URL">
                    <button id="add-ban" class="btn-primary" style="background:#db2777">‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <div id="admin-ban-list" style="margin-top:15px"></div>
                </div>

                <div class="section-title">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</div>
                <div class="card">
                    <input id="nt-title" class="input-group" placeholder="‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ">
                    <textarea id="nt-desc" class="input-group" rows="2" placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§"></textarea>
                    <button id="add-notice" class="btn-primary">‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶∂</button>
                </div>
            </div>

        </main>

        <nav class="bottom-nav" id="bottom-nav">
            <div class="nav-item active" id="btn-home"><span class="material-icons-round">home</span>‡¶π‡ßã‡¶Æ</div>
            <div class="nav-fab" id="btn-services"><span class="material-icons-round">grid_view</span></div>
            <div class="nav-item" id="btn-admin" style="display:none"><span class="material-icons-round">admin_panel_settings</span>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®</div>
            <div class="nav-item" id="btn-profile"><span class="material-icons-round">person</span>‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</div>
        </nav>

        <div id="user-modal" class="modal-overlay">
            <div class="modal-sheet" style="text-align:center">
                <div style="width:70px; height:70px; background:#eff6ff; color:var(--primary); border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:30px; font-weight:bold" id="um-avatar">A</div>
                <h3 id="um-name" style="margin:0">Name</h3>
                <p id="um-role" style="color:#64748b; margin:5px 0 20px">Role</p>
                
                <div style="text-align:left; background:#f8fafc; padding:15px; border-radius:12px; font-size:0.9rem">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px"><span>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</span> <b id="um-phone">-</b></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px"><span>‡¶∞‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™:</span> <b id="um-blood" style="color:var(--danger)">-</b></div>
                    <div style="display:flex; justify-content:space-between"><span>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ:</span> <b id="um-addr">-</b></div>
                </div>
                <br>
                <a id="um-call" href="#" class="btn-primary" style="background:#10b981; text-decoration:none">‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶® <span class="material-icons-round">call</span></a>
                <br>
                <div style="color:#64748b; font-size:0.8rem; cursor:pointer" onclick="closeModal('user-modal')">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</div>
            </div>
        </div>

        <div id="blood-modal" class="modal-overlay"><div class="modal-sheet"><h3 style="margin:0 0 15px; color:var(--danger)">ü©∏ ‡¶¨‡ßç‡¶≤‡¶æ‡¶° ‡¶°‡ßã‡¶®‡¶æ‡¶∞</h3><div id="donor-list"></div><br><button onclick="closeModal('blood-modal')" class="btn-primary" style="background:#e5e7eb; color:#333">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button></div></div>
        <div id="emergency-modal" class="modal-overlay"><div class="modal-sheet"><h3 style="margin:0 0 15px; color:#f97316">‚òéÔ∏è ‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶∏‡ßá‡¶¨‡¶æ</h3><div class="villager-card"><div><b>999</b><br><small>‡¶ú‡¶æ‡¶§‡ßÄ‡ßü ‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶∏‡ßá‡¶¨‡¶æ</small></div><a href="tel:999" class="v-action"><span class="material-icons-round">call</span></a></div><br><button onclick="closeModal('emergency-modal')" class="btn-primary" style="background:#e5e7eb; color:#333">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button></div></div>
        <div id="agri-modal" class="modal-overlay"><div class="modal-sheet"><h3 style="margin:0 0 15px; color:#16a34a">üåæ ‡¶ï‡ßÉ‡¶∑‡¶ø ‡¶§‡¶•‡ßç‡¶Ø</h3><p>‡¶¨‡ßã‡¶∞‡ßã ‡¶Æ‡ßå‡¶∏‡ßÅ‡¶Æ‡ßá ‡¶∏‡ßá‡¶ö ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p><div class="villager-card"><div><b>16123</b><br><small>‡¶ï‡ßÉ‡¶∑‡¶ø ‡¶ï‡¶≤ ‡¶∏‡ßá‡¶®‡ßç‡¶ü‡¶æ‡¶∞</small></div><a href="tel:16123" class="v-action"><span class="material-icons-round">call</span></a></div><br><button onclick="closeModal('agri-modal')" class="btn-primary" style="background:#e5e7eb; color:#333">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button></div></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, doc, setDoc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // SETUP
        const firebaseConfig = { apiKey: "AIzaSyAuqcDRrtuQi2tdWXA2E_UWyq7pCrGpoy4", authDomain: "parkhali-village.firebaseapp.com", projectId: "parkhali-village" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app); const adminEmail = "admin@parkhali.com";

        // GLOBALS
        window.openModal = (id) => { const m=document.getElementById(id); m.style.display='flex'; setTimeout(()=>m.querySelector('.modal-sheet').style.transform='translateY(0)',10); }
        window.closeModal = (id) => { const m=document.getElementById(id); m.querySelector('.modal-sheet').style.transform='translateY(100%)'; setTimeout(()=>m.style.display='none',300); }
        window.toggleAuth = (login) => { document.getElementById('auth-view').style.display = login?'block':'none'; document.getElementById('reg-view').style.display = login?'none':'block'; }

        // NAVIGATION
        const views = { home: 'home-view', services: 'services-view', villagers: 'villagers-view', profile: 'profile-view', admin: 'admin-view', auth: 'auth-view', reg: 'reg-view', pform: 'profile-form-view' };
        const navs = { home: 'btn-home', services: 'btn-services', profile: 'btn-profile', admin: 'btn-admin' };

        function switchView(name) {
            Object.values(views).forEach(id => document.getElementById(id).style.display = 'none');
            Object.values(navs).forEach(id => document.getElementById(id).classList.remove('active'));

            document.getElementById(views[name]).style.display = 'block';
            
            // Allow back nav logic
            if(name === 'villagers') { document.getElementById('btn-home').classList.add('active'); }
            else if(navs[name]) { document.getElementById(navs[name]).classList.add('active'); }

            // Dynamic Header
            const hText = document.querySelector('#hero-text h2');
            const hSub = document.querySelector('#hero-text p');
            if(name === 'home') { hText.innerText = "‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ!"; hSub.innerText = auth.currentUser?.email.split('@')[0] || ''; loadBanners(); loadNotices(); }
            else if(name === 'villagers') { hText.innerText = "‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡¶¨‡¶æ‡¶∏‡ßÄ"; hSub.innerText = "‡¶∏‡¶ï‡¶≤‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ"; loadVillagers(); }
            else if(name === 'services') { hText.innerText = "‡¶∏‡ßá‡¶¨‡¶æ‡¶∏‡¶Æ‡ßÇ‡¶π"; hSub.innerText = "‡¶è‡¶ï‡¶®‡¶ú‡¶∞‡ßá ‡¶∏‡¶¨ ‡¶∏‡ßá‡¶¨‡¶æ"; }
            else if(name === 'admin') { hText.innerText = "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®"; hSub.innerText = "‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤"; loadAdminData(); }
            else if(name === 'profile') { hText.innerText = "‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤"; hSub.innerText = "‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡¶•‡ßç‡¶Ø"; loadProfile(); }
        }

        // NAV LISTENERS
        Object.keys(navs).forEach(key => document.getElementById(navs[key]).addEventListener('click', () => switchView(key)));

        // AUTH LOGIC
        onAuthStateChanged(auth, async (user) => {
            setTimeout(() => document.getElementById('splash').classList.add('hidden'), 1500);
            if(user) {
                const uDoc = await getDoc(doc(db, "users", user.uid));
                if(uDoc.exists()) {
                    const d = uDoc.data();
                    if(d.status === "banned" && user.email !== adminEmail) { signOut(auth); alert("Account Banned"); return; }
                    
                    document.getElementById('logout-btn').style.display = "flex";
                    if(!d.name && user.email !== adminEmail) {
                        document.getElementById('bottom-nav').style.display = "none";
                        switchView('pform');
                    } else {
                        document.getElementById('bottom-nav').style.display = "flex";
                        document.getElementById('btn-admin').style.display = (user.email === adminEmail) ? "flex" : "none";
                        switchView('home');
                    }
                } else {
                    await setDoc(doc(db, "users", user.uid), { email:user.email, role:"user", status:"active" });
                    switchView('pform');
                }
            } else {
                switchView('auth');
                document.getElementById('logout-btn').style.display = "none";
                document.getElementById('bottom-nav').style.display = "none";
            }
        });

        // LOGIN / REG
        document.getElementById('login-btn').onclick = async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value); }
            catch(e) { alert("Error: " + e.message); }
        };
        document.getElementById('reg-btn').onclick = async () => {
            try { await createUserWithEmailAndPassword(auth, document.getElementById('reg-email').value, document.getElementById('reg-pass').value); }
            catch(e) { alert("Error: " + e.message); }
        };
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        // SAVE PROFILE
        document.getElementById('save-profile').onclick = async () => {
            const n = document.getElementById('pf-name').value;
            const a = document.getElementById('pf-addr').value;
            if(!n || !a) return alert("Fill Name & Address");
            await updateDoc(doc(db, "users", auth.currentUser.uid), {
                name: n, profession: document.getElementById('pf-prof').value,
                bloodGroup: document.getElementById('pf-blood').value,
                phone: document.getElementById('pf-phone').value, address: a
            });
            switchView('home');
        };

        // HOME: BANNERS (16:7)
        let slideInt;
        async function loadBanners() {
            const c = document.getElementById('banner-slider');
            const s = await getDocs(query(collection(db, "banners"), orderBy("createdAt", "desc")));
            if(s.empty) { c.innerHTML = "<div style='display:flex;align-items:center;justify-content:center;height:100%;color:#cbd5e1'>No Banners</div>"; return; }
            c.innerHTML = ""; let i=0;
            s.forEach(d => {
                c.innerHTML += `<a href="${d.data().link || '#'}" target="_blank"><img src="${d.data().image}" class="banner-slide ${i===0?'active':''}"></a>`;
                i++;
            });
            if(slideInt) clearInterval(slideInt);
            if(i>1) slideInt = setInterval(() => {
                const all = document.querySelectorAll('.banner-slide'); let cur=0;
                all.forEach((el,x)=>{ if(el.classList.contains('active')){el.classList.remove('active'); cur=x;} });
                all[(cur+1)%all.length].classList.add('active');
            }, 3500);
        }

        // HOME: NOTICES
        async function loadNotices() {
            const c = document.getElementById('notice-list');
            const s = await getDocs(query(collection(db, "notices"), orderBy("createdAt", "desc")));
            c.innerHTML = s.empty ? "<p style='text-align:center;color:#94a3b8'>‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶®‡ßá‡¶á</p>" : "";
            s.forEach(d => c.innerHTML += `<div class="card" style="margin-bottom:10px; padding:10px; border-left:4px solid var(--primary)"><h4>${d.data().title}</h4><p style="margin:0;font-size:0.85rem;color:#64748b">${d.data().description}</p></div>`);
        }

        // VILLAGERS LIST (FIXED)
        let cachedUsers = [];
        async function loadVillagers() {
            const c = document.getElementById('villager-list-container');
            if(cachedUsers.length === 0) {
                c.innerHTML = "<p style='text-align:center;color:#94a3b8'>‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>";
                const s = await getDocs(collection(db, "users"));
                cachedUsers = []; s.forEach(d => cachedUsers.push(d.data()));
            }
            renderVillagers(cachedUsers);
        }
        function renderVillagers(list) {
            const c = document.getElementById('villager-list-container'); c.innerHTML = "";
            const valid = list.filter(u => u.name && u.status !== 'banned');
            if(valid.length === 0) { c.innerHTML = "<p style='text-align:center;color:#94a3b8'>‡¶ï‡¶æ‡¶â‡¶ï‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</p>"; return; }
            valid.forEach(u => {
                const uStr = encodeURIComponent(JSON.stringify(u));
                c.innerHTML += `
                <div class="villager-card" onclick="window.viewU('${uStr}')">
                    <div style="display:flex;align-items:center">
                        <div class="v-avatar">${u.name.charAt(0)}</div>
                        <div class="v-info"><h4>${u.name}</h4><p>${u.profession||'‡¶™‡ßá‡¶∂‡¶æ ‡¶®‡ßá‡¶á'}</p></div>
                    </div>
                    <a href="tel:${u.phone}" class="v-action" onclick="event.stopPropagation()"><span class="material-icons-round">call</span></a>
                </div>`;
            });
        }
        document.getElementById('v-search').addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            renderVillagers(cachedUsers.filter(u => u.name?.toLowerCase().includes(q) || u.phone?.includes(q) || u.profession?.toLowerCase().includes(q)));
        });
        window.viewU = (s) => {
            const u = JSON.parse(decodeURIComponent(s));
            document.getElementById('um-avatar').innerText = u.name.charAt(0);
            document.getElementById('um-name').innerText = u.name;
            document.getElementById('um-role').innerText = u.profession;
            document.getElementById('um-phone').innerText = u.phone || '-';
            document.getElementById('um-blood').innerText = u.bloodGroup || '-';
            document.getElementById('um-addr').innerText = u.address || '-';
            document.getElementById('um-call').href = `tel:${u.phone}`;
            openModal('user-modal');
        }

        // ADMIN
        document.getElementById('add-ban').onclick = async () => {
            const i = document.getElementById('ban-img').value;
            if(!i) return;
            await addDoc(collection(db, "banners"), { image: i, link: document.getElementById('ban-link').value, createdAt: serverTimestamp() });
            alert("Added!"); loadAdminData();
        };
        document.getElementById('add-notice').onclick = async () => {
            const t = document.getElementById('nt-title').value;
            if(!t) return;
            await addDoc(collection(db, "notices"), { title: t, description: document.getElementById('nt-desc').value, createdAt: serverTimestamp() });
            alert("Published!");
        };
        async function loadAdminData() {
            const c = document.getElementById('admin-ban-list'); c.innerHTML="Loading...";
            const s = await getDocs(collection(db, "banners")); c.innerHTML="";
            s.forEach(d => c.innerHTML += `<div class="admin-item"><img src="${d.data().image}" class="banner-preview"><button onclick="window.delB('${d.id}')" style="color:red;border:none">Delete</button></div>`);
        }
        window.delB = async(id) => { if(confirm('Delete?')) await deleteDoc(doc(db,"banners",id)); loadAdminData(); }

        // PROFILE & BLOOD
        async function loadProfile(){ if(auth.currentUser){const d=await getDoc(doc(db,"users",auth.currentUser.uid)); if(d.exists()){const u=d.data(); document.getElementById('mp-name').innerText=u.name; document.getElementById('mp-role').innerText=u.profession; document.getElementById('up-name').value=u.name; document.getElementById('up-phone').value=u.phone;}} }
        document.getElementById('update-profile').onclick=async()=>{ await updateDoc(doc(db,"users",auth.currentUser.uid),{name:document.getElementById('up-name').value, phone:document.getElementById('up-phone').value}); alert("Updated"); loadProfile(); }
        
        window.loadDonors = async () => {
            const c = document.getElementById('donor-list'); c.innerHTML = "Loading...";
            const s = await getDocs(query(collection(db,"blood_donors"), orderBy("createdAt","desc"))); c.innerHTML="";
            s.forEach(d => { const v=d.data(); c.innerHTML += `<div class="villager-card"><div><b>${v.bloodGroup}</b> ${v.name}</div><a href="tel:${v.phone}" class="v-action"><span class="material-icons-round">call</span></a></div>`; });
        }

    </script>
</body>
</html>
