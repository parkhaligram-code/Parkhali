<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>পারখালী গ্রাম</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#16a34a', secondary: '#15803d', dark: '#14532d', accent: '#facc15' },
                    fontFamily: { sans: ['Hind Siliguri', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Hind Siliguri', sans-serif; background-color: #f3f4f6; margin: 0; padding: 0; overflow-x: hidden; }
        .hidden-section { display: none !important; }
        
        /* Splash Screen Animation */
        #splash-screen { background: linear-gradient(135deg, #16a34a, #14532d); }
        .letter { display: inline-block; opacity: 0; transform: scale(0.5); font-size: 3.5rem; font-weight: bold; color: white; text-shadow: 2px 2px 10px rgba(0,0,0,0.2); }
        .animate-letter { animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { to { opacity: 1; transform: scale(1); } }

        /* Banner Slider */
        .slider-wrapper { aspect-ratio: 16/7; overflow: hidden; position: relative; width: 100%; border-radius: 0.5rem; }
        .slider-track { display: flex; transition: transform 0.5s ease-in-out; height: 100%; }
        .slide { min-width: 100%; height: 100%; object-fit: cover; cursor: pointer; }

        /* Modals & Overlays */
        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 100; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { transform: translateY(50px); transition: all 0.3s ease; }
        .modal-overlay.active .modal-content { transform: translateY(0); }

        /* Auth Tabs */
        .auth-tab-active { border-bottom: 3px solid #16a34a; color: #16a34a; font-weight: bold; }
        .auth-tab-inactive { color: #6b7280; }

        /* App Container & Bottom Nav */
        .app-container { max-width: 480px; margin: 0 auto; background: white; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .content-area { padding-bottom: 80px; padding-top: 60px; height: 100vh; overflow-y: auto; }
        .nav-center { transform: translateY(-25px); border: 5px solid #f3f4f6; }
        #loading-overlay { background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); z-index: 999; }

        /* Image preview */
        .image-preview { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* Pull to refresh spinner */
        .refresh-indicator { height: 50px; display: flex; justify-content: center; align-items: center; color: #16a34a; transition: opacity 0.2s; }
    </style>
</head>
<body>

<div class="app-container">

    <!-- Splash Screen -->
    <div id="splash-screen" class="absolute inset-0 z-[1000] flex flex-col items-center justify-center">
        <div class="w-24 h-24 bg-white/20 rounded-full flex items-center justify-center mb-6 animate-pulse">
            <i class="fas fa-leaf text-5xl text-white"></i>
        </div>
        <div id="splash-text" class="flex space-x-1">
            <span class="letter">পা</span><span class="letter">র</span><span class="letter">খা</span><span class="letter">লী</span>
        </div>
        <p class="text-white mt-4 opacity-90 text-lg tracking-wider">আমাদের প্রাণের গ্রাম</p>
    </div>

    <!-- Global Loading Overlay -->
    <div id="loading-overlay" class="hidden-section absolute inset-0 flex items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-primary"></div>
    </div>

    <!-- Auth Section (Login) -->
    <div id="auth-section" class="hidden-section flex flex-col min-h-screen bg-gray-50">
        <div class="bg-primary pt-16 pb-8 px-6 text-center text-white rounded-b-3xl shadow-lg">
            <div class="w-20 h-20 bg-white text-primary rounded-full flex items-center justify-center text-4xl mx-auto mb-4 shadow-inner"><i class="fas fa-home"></i></div>
            <h1 class="text-3xl font-bold">স্বাগতম</h1>
            <p class="opacity-80 mt-1">পারখালী গ্রামের অ্যাপে প্রবেশ করুন</p>
        </div>
        
        <div class="px-6 py-6 flex-grow">
            <div class="flex border-b mb-6">
                <button id="tab-phone-auth" class="w-1/2 py-3 auth-tab-active text-lg transition">মোবাইল নম্বর</button>
                <button id="tab-email-auth" class="w-1/2 py-3 auth-tab-inactive text-lg transition">ইমেইল</button>
            </div>

            <!-- Phone Login -->
            <div id="auth-phone-div" class="space-y-4">
                <div id="phone-input-step">
                    <label class="block text-gray-700 text-sm mb-1 font-semibold">আপনার মোবাইল নম্বর</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 bg-gray-100 border border-r-0 border-gray-300 rounded-l-lg text-gray-600 font-bold">+88</span>
                        <input type="tel" id="auth-phone" placeholder="01XXX-XXXXXX" class="w-full px-4 py-3 border border-gray-300 rounded-r-lg focus:outline-none focus:border-primary">
                    </div>
                    <button id="btn-send-otp" class="w-full bg-primary text-white rounded-lg py-3 mt-6 font-bold shadow-md hover:bg-secondary transition">OTP পাঠান</button>
                </div>
                <div id="otp-input-step" class="hidden-section">
                    <label class="block text-gray-700 text-sm mb-1 font-semibold">OTP কোড দিন</label>
                    <input type="number" id="auth-otp" placeholder="6-digit code" class="w-full px-4 py-3 rounded-lg border border-gray-300 text-center tracking-widest text-lg focus:outline-none focus:border-primary">
                    <button id="btn-verify-otp" class="w-full bg-primary text-white rounded-lg py-3 mt-6 font-bold shadow-md hover:bg-secondary transition">ভেরিফাই করুন</button>
                </div>
            </div>

            <!-- Email Login -->
            <div id="auth-email-div" class="hidden-section space-y-4">
                <div><label class="block text-gray-700 text-sm mb-1 font-semibold">ইমেইল</label><input type="email" id="auth-email" placeholder="example@mail.com" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:border-primary"></div>
                <div><label class="block text-gray-700 text-sm mb-1 font-semibold">পাসওয়ার্ড</label><input type="password" id="auth-password" placeholder="******" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:border-primary"></div>
                <div class="flex space-x-3 pt-2">
                    <button id="btn-login-email" class="w-1/2 bg-primary text-white rounded-lg py-3 font-bold shadow-md hover:bg-secondary transition">লগইন</button>
                    <button id="btn-register-email" class="w-1/2 bg-white text-primary border-2 border-primary rounded-lg py-3 font-bold hover:bg-gray-50 transition">রেজিস্ট্রেশন</button>
                </div>
            </div>
            <div class="text-center mt-6">
                <p class="text-gray-500">নতুন ব্যবহারকারী? <button id="go-to-register" class="text-primary font-bold underline">একাউন্ট তৈরি করুন</button></p>
            </div>
        </div>
        <div id="recaptcha-container"></div>
    </div>

    <!-- Registration Section (New) -->
    <div id="register-section" class="hidden-section flex flex-col min-h-screen bg-white">
        <div class="bg-gradient-to-br from-primary to-secondary pt-12 pb-8 px-6 text-center text-white rounded-b-3xl shadow-xl relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full"></div>
            <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-white/10 rounded-full"></div>
            <button id="back-to-auth" class="absolute left-4 top-4 text-white text-xl"><i class="fas fa-arrow-left"></i></button>
            <h2 class="text-3xl font-bold mb-2">নতুন একাউন্ট</h2>
            <p class="opacity-90">আপনার পছন্দের মাধ্যম বেছে নিন</p>
        </div>

        <div class="px-6 py-8 flex-grow">
            <div class="flex border-b mb-8">
                <button id="reg-phone-tab" class="w-1/2 py-3 auth-tab-active text-lg">মোবাইল</button>
                <button id="reg-email-tab" class="w-1/2 py-3 auth-tab-inactive text-lg">ইমেইল</button>
            </div>

            <!-- Registration Phone -->
            <div id="reg-phone-div" class="space-y-5">
                <div>
                    <label class="block text-gray-700 text-sm mb-1 font-semibold">মোবাইল নম্বর</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 bg-gray-100 border border-r-0 border-gray-300 rounded-l-lg text-gray-600 font-bold">+88</span>
                        <input type="tel" id="reg-phone" placeholder="01XXX-XXXXXX" class="w-full px-4 py-3 border border-gray-300 rounded-r-lg focus:outline-none focus:border-primary">
                    </div>
                </div>
                <button id="btn-reg-phone-send-otp" class="w-full bg-primary text-white rounded-lg py-4 font-bold shadow-md hover:bg-secondary transition transform hover:scale-[1.02] active:scale-[0.98]">OTP পাঠান</button>
            </div>

            <!-- Registration Email -->
            <div id="reg-email-div" class="hidden-section space-y-5">
                <div>
                    <label class="block text-gray-700 text-sm mb-1 font-semibold">ইমেইল</label>
                    <input type="email" id="reg-email" placeholder="example@mail.com" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm mb-1 font-semibold">পাসওয়ার্ড</label>
                    <input type="password" id="reg-password" placeholder="******" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary">
                </div>
                <button id="btn-reg-email-submit" class="w-full bg-primary text-white rounded-lg py-4 font-bold shadow-md hover:bg-secondary transition transform hover:scale-[1.02] active:scale-[0.98]">রেজিস্ট্রেশন</button>
            </div>
        </div>
    </div>

    <!-- Profile Setup Section (with image upload) -->
    <div id="setup-section" class="hidden-section flex flex-col min-h-screen bg-white">
        <div class="bg-gradient-to-r from-primary to-secondary p-6 text-white text-center rounded-b-3xl">
            <h2 class="text-2xl font-bold mt-4">প্রোফাইল তৈরি করুন</h2>
            <p class="opacity-90">আপনার সঠিক তথ্য দিয়ে যুক্ত হোন</p>
        </div>
        <div class="px-6 py-8 space-y-4 overflow-y-auto pb-24">
            <!-- Profile Picture Upload -->
            <div class="flex flex-col items-center mb-4">
                <div class="relative">
                    <img id="profile-preview" src="https://via.placeholder.com/100" class="image-preview">
                    <label for="profile-upload" class="absolute bottom-0 right-0 bg-primary text-white w-8 h-8 rounded-full flex items-center justify-center cursor-pointer shadow-lg hover:bg-secondary transition"><i class="fas fa-camera"></i></label>
                    <input type="file" id="profile-upload" accept="image/*" class="hidden">
                </div>
                <p class="text-xs text-gray-500 mt-2">প্রোফাইল ছবি আপলোড করুন</p>
            </div>

            <div><label class="block text-gray-700 text-sm mb-1 font-semibold">আপনার নাম</label><input type="text" id="setup-name" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary" placeholder="যেমন: মো: ওয়ালিদ"></div>
            
            <div id="setup-phone-container"><label class="block text-gray-700 text-sm mb-1 font-semibold">মোবাইল নম্বর</label><input type="tel" id="setup-phone" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary" placeholder="01XXX-XXXXXX"></div>
            
            <div><label class="block text-gray-700 text-sm mb-1 font-semibold">পেশা / চাকুরী</label><input type="text" id="setup-profession" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary" placeholder="যেমন: ছাত্র, ব্যবসায়ী, শিক্ষক"></div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 text-sm mb-1 font-semibold">রক্তের গ্রুপ</label>
                    <select id="setup-blood" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-white focus:border-primary">
                        <option value="">নির্বাচন করুন</option>
                        <option value="A+">A+</option><option value="A-">A-</option>
                        <option value="B+">B+</option><option value="B-">B-</option>
                        <option value="O+">O+</option><option value="O-">O-</option>
                        <option value="AB+">AB+</option><option value="AB-">AB-</option>
                    </select>
                </div>
                <div><label class="block text-gray-700 text-sm mb-1 font-semibold">পাড়ার নাম</label><input type="text" id="setup-para" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-primary" placeholder="যেমন: পূর্ব পাড়া"></div>
            </div>

            <!-- Social Links (new) -->
            <div class="border-t pt-4 mt-2">
                <h4 class="font-bold text-gray-700 mb-3">সামাজিক যোগাযোগ (ঐচ্ছিক)</h4>
                <div class="space-y-3">
                    <div class="flex items-center border rounded-lg overflow-hidden">
                        <span class="bg-blue-100 text-blue-600 w-10 flex justify-center"><i class="fab fa-facebook-f"></i></span>
                        <input type="text" id="setup-facebook" placeholder="Facebook username বা লিংক" class="flex-grow px-3 py-2 border-l focus:outline-none">
                    </div>
                    <div class="flex items-center border rounded-lg overflow-hidden">
                        <span class="bg-green-100 text-green-600 w-10 flex justify-center"><i class="fab fa-whatsapp"></i></span>
                        <input type="text" id="setup-whatsapp" placeholder="WhatsApp নম্বর" class="flex-grow px-3 py-2 border-l focus:outline-none">
                    </div>
                    <div class="flex items-center border rounded-lg overflow-hidden">
                        <span class="bg-blue-200 text-blue-500 w-10 flex justify-center"><i class="fab fa-telegram-plane"></i></span>
                        <input type="text" id="setup-telegram" placeholder="Telegram username" class="flex-grow px-3 py-2 border-l focus:outline-none">
                    </div>
                </div>
            </div>
            
            <button id="btn-save-profile" class="w-full bg-primary text-white rounded-lg py-4 mt-6 font-bold text-lg shadow-lg hover:bg-secondary transition"><i class="fas fa-check-circle mr-2"></i> তথ্য সেভ করুন</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden-section h-full flex flex-col">
        <header class="absolute top-0 w-full bg-primary text-white px-4 py-3 flex items-center justify-between z-40 shadow-md">
            <h2 class="text-xl font-bold flex items-center"><i class="fas fa-leaf mr-2 text-accent"></i> পারখালী</h2>
            <div class="relative w-[55%]">
                <input type="text" placeholder="গ্রামবাসী খুঁজুন..." class="w-full bg-white/20 text-white placeholder-white/70 px-4 py-1.5 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-white">
                <i class="fas fa-search absolute right-3 top-2.5 text-white/70 text-xs"></i>
            </div>
        </header>

        <main class="content-area bg-gray-100 relative" id="main-content">
            <!-- Pull to refresh indicator -->
            <div id="refresh-indicator" class="refresh-indicator opacity-0"><i class="fas fa-spinner fa-spin mr-2"></i> রিফ্রেশ হচ্ছে...</div>
            
            <!-- Home Tab -->
            <div id="tab-home" class="p-4 page-tab space-y-5">
                <div class="flex items-center justify-between bg-white p-4 rounded-xl shadow-sm border-l-4 border-primary">
                    <div><p class="text-gray-500 text-xs font-semibold">স্বাগতম</p><h3 class="text-lg font-bold text-gray-800" id="welcome-name">---</h3></div>
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-primary overflow-hidden" id="home-profile-pic">
                        <i class="fas fa-user-circle text-2xl"></i>
                    </div>
                </div>

                <div class="slider-wrapper shadow-md bg-white">
                    <div id="banner-track" class="slider-track"></div>
                    <div id="banner-dots" class="absolute bottom-2 left-0 right-0 flex justify-center space-x-2"></div>
                </div>

                <h4 class="font-bold text-gray-800 text-lg px-1">এক নজরে গ্রাম</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center space-x-3">
                        <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center text-xl"><i class="fas fa-users"></i></div>
                        <div><h5 class="font-semibold text-gray-700 text-sm">সর্বমোট সদস্য</h5><p id="total-users-count" class="text-lg font-bold text-gray-900">0</p></div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center space-x-3">
                        <div class="w-12 h-12 rounded-full bg-emerald-50 text-emerald-500 flex items-center justify-center text-xl"><i class="fas fa-mosque"></i></div>
                        <div><h5 class="font-semibold text-gray-700 text-sm">মসজিদ</h5><p class="text-lg font-bold text-gray-900">৩ টি</p></div>
                    </div>
                </div>
            </div>

            <!-- Villagers Tab -->
            <div id="tab-villagers" class="hidden-section p-4 page-tab">
                <div class="relative mb-5">
                    <input type="text" id="search-villager" placeholder="নাম, পেশা বা নম্বর দিয়ে খুঁজুন..." class="w-full px-4 py-3 pl-11 rounded-xl border border-gray-200 shadow-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none">
                    <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                </div>
                <div id="villagers-list" class="space-y-3"></div>
            </div>

            <!-- Services Tab -->
            <div id="tab-services" class="hidden-section p-4 page-tab">
                <h3 class="text-xl font-bold text-gray-800 mb-5 text-center mt-2">জরুরী সেবাসমূহ</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-5 rounded-xl shadow-sm text-center border border-gray-100 hover:shadow-md transition"><div class="w-14 h-14 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl"><i class="fas fa-ambulance"></i></div><h5 class="font-bold text-gray-700">অ্যাম্বুলেন্স</h5></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm text-center border border-gray-100 hover:shadow-md transition"><div class="w-14 h-14 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl"><i class="fas fa-user-md"></i></div><h5 class="font-bold text-gray-700">ডাক্তার</h5></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm text-center border border-gray-100 hover:shadow-md transition"><div class="w-14 h-14 bg-yellow-50 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl"><i class="fas fa-bolt"></i></div><h5 class="font-bold text-gray-700">বিদ্যুৎ অফিস</h5></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm text-center border border-gray-100 hover:shadow-md transition"><div class="w-14 h-14 bg-green-50 text-green-600 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl"><i class="fas fa-shield-alt"></i></div><h5 class="font-bold text-gray-700">থানা পুলিশ</h5></div>
                </div>
            </div>

            <!-- Notice Tab -->
            <div id="tab-notice" class="hidden-section p-4 page-tab">
                <h3 class="font-bold text-gray-800 mb-4 text-lg">গ্রামের নোটিশ বোর্ড</h3>
                <div id="notices-list" class="space-y-3"></div>
            </div>

            <!-- Profile Tab (with edit option) -->
            <div id="tab-profile" class="hidden-section p-4 page-tab">
                <div class="bg-white rounded-2xl shadow-sm p-6 text-center border border-gray-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-24 bg-primary/10"></div>
                    <div class="w-24 h-24 mx-auto mb-3 relative z-10 overflow-hidden rounded-full border-4 border-white shadow-md" id="profile-pic-container">
                        <img id="prof-pic" src="https://via.placeholder.com/100" class="w-full h-full object-cover">
                    </div>
                    <h2 id="prof-name" class="text-2xl font-bold text-gray-800">---</h2>
                    <p id="prof-profession" class="text-primary font-semibold text-sm mb-1">---</p>
                    <p id="prof-para" class="text-gray-500 text-sm mb-5"><i class="fas fa-map-marker-alt mr-1"></i>---</p>
                    
                    <div class="grid grid-cols-2 gap-3 text-left mb-6">
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-100 flex items-center space-x-3"><i class="fas fa-tint text-red-500 text-xl"></i><div><p class="text-xs text-gray-500">রক্তের গ্রুপ</p><p id="prof-blood" class="font-bold text-gray-800">---</p></div></div>
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-100 flex items-center space-x-3"><i class="fas fa-phone-alt text-green-500 text-xl"></i><div class="overflow-hidden"><p class="text-xs text-gray-500">মোবাইল</p><p id="prof-phone" class="font-bold text-gray-800 text-sm truncate">---</p></div></div>
                    </div>

                    <!-- Social Links Display -->
                    <div class="flex justify-center space-x-4 mb-6" id="profile-social-links"></div>

                    <div class="flex space-x-2">
                        <button id="btn-edit-profile" class="flex-1 bg-primary/10 text-primary font-bold py-3 rounded-xl border border-primary/30 hover:bg-primary/20 transition"><i class="fas fa-edit mr-2"></i> সম্পাদনা</button>
                        <button id="btn-logout" class="flex-1 bg-red-50 text-red-500 font-bold py-3 rounded-xl border border-red-100 hover:bg-red-100 transition"><i class="fas fa-sign-out-alt mr-2"></i> লগআউট</button>
                    </div>
                </div>
            </div>

            <!-- Admin Tab (enhanced) -->
            <div id="tab-admin" class="hidden-section p-4 page-tab">
                <div class="bg-gradient-to-r from-gray-800 to-gray-900 text-white rounded-2xl shadow-lg p-6 text-center mb-6 relative overflow-hidden">
                    <i class="fas fa-user-shield text-5xl mb-3 text-accent opacity-90"></i>
                    <h2 class="text-2xl font-bold">এডমিন প্যানেল</h2>
                    <p class="text-sm opacity-80">অ্যাপ কন্ট্রোল সেন্টার</p>
                </div>

                <!-- Theme Selector -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 mb-6">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-palette text-primary mr-2"></i> থিম কালার</h3>
                    <div class="grid grid-cols-4 gap-3" id="theme-selector">
                        <!-- Dynamically filled -->
                    </div>
                </div>

                <!-- Banner Management with Cloudinary Upload -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 mb-6">
                    <h3 class="font-bold text-gray-700 mb-3">ব্যানার আপলোড</h3>
                    <div class="mb-3">
                        <label class="block text-sm text-gray-600 mb-1">ছবি নির্বাচন করুন</label>
                        <input type="file" id="admin-banner-file" accept="image/*" class="w-full text-sm border p-2 rounded-lg">
                        <img id="admin-banner-preview" class="mt-2 max-h-32 rounded-lg hidden">
                    </div>
                    <input type="text" id="admin-banner-url" placeholder="ক্লিক লিংক URL (ঐচ্ছিক)" class="w-full px-4 py-2 mb-3 rounded-lg border border-gray-300 text-sm">
                    <button id="btn-upload-banner" class="w-full bg-dark text-white rounded-lg py-2 font-bold hover:bg-black transition"><i class="fas fa-cloud-upload-alt mr-1"></i> আপলোড ব্যানার</button>
                </div>

                <!-- Notice Management -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 mb-6">
                    <h3 class="font-bold text-gray-700 mb-3">নতুন নোটিশ</h3>
                    <textarea id="admin-notice-text" rows="2" placeholder="নোটিশ লিখুন..." class="w-full px-4 py-2 mb-3 rounded-lg border border-gray-300 text-sm"></textarea>
                    <button id="btn-add-notice" class="w-full bg-dark text-white rounded-lg py-2 font-bold hover:bg-black transition"><i class="fas fa-plus-circle mr-1"></i> নোটিশ দিন</button>
                </div>

                <!-- User Management -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 mb-6">
                    <h3 class="font-bold text-gray-700 mb-3">ইউজার ম্যানেজমেন্ট</h3>
                    <input type="text" id="admin-user-search" placeholder="নাম বা ফোন দিয়ে সার্চ..." class="w-full px-4 py-2 mb-3 rounded-lg border border-gray-300 text-sm">
                    <div id="admin-user-list" class="max-h-80 overflow-y-auto space-y-2"></div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="absolute bottom-0 w-full bg-white shadow-[0_-5px_15px_rgba(0,0,0,0.05)] flex justify-around items-center px-2 py-2 z-40 rounded-t-2xl border-t border-gray-100">
            <button onclick="switchTab('home')" class="nav-btn flex flex-col items-center text-gray-400 hover:text-primary w-1/5" data-target="tab-home"><i class="fas fa-home text-xl mb-1"></i><span class="text-[10px] font-bold">হোম</span></button>
            <button onclick="switchTab('villagers')" class="nav-btn flex flex-col items-center text-gray-400 hover:text-primary w-1/5" data-target="tab-villagers"><i class="fas fa-users text-xl mb-1"></i><span class="text-[10px] font-bold">গ্রামবাসী</span></button>
            
            <div class="w-1/5 flex justify-center relative">
                <button onclick="switchTab('services')" class="nav-btn nav-center w-14 h-14 bg-gradient-to-br from-primary to-secondary text-white rounded-full flex items-center justify-center shadow-[0_5px_15px_rgba(22,163,74,0.4)] hover:scale-105 transition-transform" data-target="tab-services">
                    <i class="fas fa-th-large text-2xl"></i>
                </button>
            </div>
            
            <button onclick="switchTab('notice')" class="nav-btn flex flex-col items-center text-gray-400 hover:text-primary w-1/5" data-target="tab-notice"><i class="fas fa-bell text-xl mb-1"></i><span class="text-[10px] font-bold">নোটিশ</span></button>
            <button onclick="switchTab('profile')" class="nav-btn flex flex-col items-center text-gray-400 hover:text-primary w-1/5" data-target="tab-profile"><i class="fas fa-user text-xl mb-1"></i><span class="text-[10px] font-bold">প্রোফাইল</span></button>
            
            <button id="admin-nav-btn" onclick="switchTab('admin')" class="hidden-section nav-btn flex flex-col items-center text-dark hover:text-primary w-1/5" data-target="tab-admin"><i class="fas fa-shield-alt text-xl mb-1"></i><span class="text-[10px] font-bold">এডমিন</span></button>
        </nav>
    </div>
</div>

<!-- Success Modal -->
<div id="success-modal" class="fixed inset-0 modal-overlay flex items-center justify-center px-4">
    <div class="modal-content bg-white w-full max-w-sm rounded-2xl p-6 text-center shadow-2xl">
        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-check text-4xl text-green-500"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">অভিনন্দন!</h3>
        <p class="text-gray-600 font-medium">আপনার প্রোফাইল সফলভাবে তৈরি হয়েছে।</p>
    </div>
</div>

<!-- Villager Details Modal -->
<div id="villager-modal" class="fixed inset-0 modal-overlay flex items-center justify-center px-4 z-[100]">
    <div class="modal-content bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl relative">
        <button onclick="closeModal('villager-modal')" class="absolute top-3 right-3 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200 z-10"><i class="fas fa-times"></i></button>
        <div class="bg-primary/10 h-24 w-full absolute top-0 left-0"></div>
        <div class="px-6 pt-12 pb-6 text-center relative z-10">
            <div class="w-20 h-20 mx-auto mb-3 overflow-hidden rounded-full border-4 border-white shadow-md">
                <img id="v-modal-pic" src="https://via.placeholder.com/100" class="w-full h-full object-cover">
            </div>
            <h3 id="v-modal-name" class="text-2xl font-bold text-gray-800">---</h3>
            <p id="v-modal-prof" class="text-primary font-semibold text-sm mb-4">---</p>
            
            <div class="space-y-3 text-left bg-gray-50 p-4 rounded-xl border border-gray-100">
                <div class="flex items-center"><i class="fas fa-map-marker-alt w-6 text-gray-400"></i> <span id="v-modal-para" class="text-gray-700 font-medium">---</span></div>
                <div class="flex items-center"><i class="fas fa-phone-alt w-6 text-gray-400"></i> <a id="v-modal-phone" href="#" class="text-blue-600 font-bold">---</a></div>
                <div class="flex items-center"><i class="fas fa-tint w-6 text-gray-400"></i> <span id="v-modal-blood" class="font-bold text-red-500 bg-red-100 px-2 rounded">---</span></div>
                <!-- Social Icons -->
                <div id="v-modal-social" class="flex justify-center space-x-4 pt-2"></div>
            </div>
            <div class="mt-5 flex space-x-3">
                <a id="v-modal-call" href="#" class="w-full bg-green-500 text-white py-2 rounded-lg font-bold shadow hover:bg-green-600"><i class="fas fa-phone mr-1"></i> কল করুন</a>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="edit-profile-modal" class="fixed inset-0 modal-overlay flex items-center justify-center px-4 z-[100]">
    <div class="modal-content bg-white w-full max-w-sm rounded-2xl overflow-y-auto max-h-[90vh] shadow-2xl">
        <div class="bg-primary p-4 text-white flex justify-between items-center sticky top-0">
            <h3 class="font-bold text-lg">প্রোফাইল সম্পাদনা</h3>
            <button onclick="closeModal('edit-profile-modal')" class="text-white"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-5 space-y-4">
            <div class="flex flex-col items-center">
                <img id="edit-preview" src="https://via.placeholder.com/100" class="w-20 h-20 rounded-full object-cover border-2 border-primary">
                <label for="edit-profile-upload" class="mt-2 text-primary text-sm cursor-pointer"><i class="fas fa-camera"></i> পরিবর্তন করুন</label>
                <input type="file" id="edit-profile-upload" accept="image/*" class="hidden">
            </div>
            <div><label class="block text-gray-700 text-sm mb-1">নাম</label><input type="text" id="edit-name" class="w-full px-4 py-2 rounded-lg border border-gray-300"></div>
            <div><label class="block text-gray-700 text-sm mb-1">পেশা</label><input type="text" id="edit-profession" class="w-full px-4 py-2 rounded-lg border border-gray-300"></div>
            <div><label class="block text-gray-700 text-sm mb-1">পাড়া</label><input type="text" id="edit-para" class="w-full px-4 py-2 rounded-lg border border-gray-300"></div>
            <div><label class="block text-gray-700 text-sm mb-1">রক্তের গ্রুপ</label>
                <select id="edit-blood" class="w-full px-4 py-2 rounded-lg border border-gray-300">
                    <option value="">নির্বাচন করুন</option>
                    <option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option><option value="B-">B-</option>
                    <option value="O+">O+</option><option value="O-">O-</option><option value="AB+">AB+</option><option value="AB-">AB-</option>
                </select>
            </div>
            <div><label class="block text-gray-700 text-sm mb-1">ফেসবুক</label><input type="text" id="edit-facebook" class="w-full px-4 py-2 rounded-lg border border-gray-300"></div>
            <div><label class="block text-gray-700 text-sm mb-1">হোয়াটসঅ্যাপ</label><input type="text" id="edit-whatsapp" class="w-full px-4 py-2 rounded-lg border border-gray-300"></div>
            <div><label class="block text-gray-700 text-sm mb-1">টেলিগ্রাম</label><input type="text" id="edit-telegram" class="w-full px-4 py-2 rounded-lg border border-gray-300"></div>
            <button id="btn-update-profile" class="w-full bg-primary text-white py-3 rounded-lg font-bold"><i class="fas fa-save mr-2"></i> আপডেট</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, getDocs, addDoc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAuqcDRrtuQi2tdWXA2E_UWyq7pCrGpoy4",
      authDomain: "parkhali-village.firebaseapp.com",
      projectId: "parkhali-village",
      storageBucket: "parkhali-village.firebasestorage.app",
      messagingSenderId: "645968583344",
      appId: "1:645968583344:web:89a049e6ffaba4af33b975",
      measurementId: "G-WD2LSS97KC"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Cloudinary config
    const CLOUD_NAME = 'dwnpdwnvc';
    const UPLOAD_PRESET = 'Parkhali';

    // Global variables
    let currentUserData = null;
    let allVillagers = [];
    let confirmationResult = null;
    let bannersLoaded = false;
    let noticesLoaded = false;

    // Helper functions
    const showLoader = (show) => document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    const showSection = (sectionId) => {
        ['auth-section', 'register-section', 'setup-section', 'main-app'].forEach(id => document.getElementById(id).classList.add('hidden-section'));
        document.getElementById(sectionId).classList.remove('hidden-section');
    };
    window.openModal = (id) => document.getElementById(id).classList.add('active');
    window.closeModal = (id) => document.getElementById(id).classList.remove('active');

    // Tab switching
    window.switchTab = function(tabName) {
        document.querySelectorAll('.page-tab').forEach(tab => tab.classList.add('hidden-section'));
        document.getElementById(`tab-${tabName}`).classList.remove('hidden-section');
        
        document.querySelectorAll('.nav-btn').forEach(btn => {
            if(!btn.classList.contains('nav-center')) { btn.classList.remove('text-primary'); btn.classList.add('text-gray-400'); }
        });
        const activeBtn = document.querySelector(`[data-target="tab-${tabName}"]`);
        if(activeBtn && !activeBtn.classList.contains('nav-center')) { activeBtn.classList.remove('text-gray-400'); activeBtn.classList.add('text-primary'); }

        if(tabName === 'villagers') loadVillagers();
        if(tabName === 'home') loadBanners();
        if(tabName === 'notice') loadNotices();
        if(tabName === 'admin') loadAdminData();
    };

    // ================== CLOUDINARY UPLOAD ==================
    async function uploadToCloudinary(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', UPLOAD_PRESET);

        const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        return data.secure_url;
    }

    // ================== SPLASH & AUTH STATE ==================
    window.onload = () => {
        const letters = document.querySelectorAll('.letter');
        letters.forEach((letter, index) => { setTimeout(() => { letter.classList.add('animate-letter'); }, index * 150); });

        setTimeout(() => {
            onAuthStateChanged(auth, async (user) => {
                document.getElementById('splash-screen').classList.add('hidden-section');
                if (user) { 
                    checkProfileAndRedirect(user); 
                } else { 
                    showSection('auth-section'); 
                }
            });
        }, 2500);
    };

    // ================== AUTH TOGGLE ==================
    document.getElementById('tab-phone-auth').addEventListener('click', (e) => {
        e.target.className = "w-1/2 py-3 auth-tab-active text-lg transition";
        document.getElementById('tab-email-auth').className = "w-1/2 py-3 auth-tab-inactive text-lg transition";
        document.getElementById('auth-phone-div').classList.remove('hidden-section');
        document.getElementById('auth-email-div').classList.add('hidden-section');
    });
    document.getElementById('tab-email-auth').addEventListener('click', (e) => {
        e.target.className = "w-1/2 py-3 auth-tab-active text-lg transition";
        document.getElementById('tab-phone-auth').className = "w-1/2 py-3 auth-tab-inactive text-lg transition";
        document.getElementById('auth-email-div').classList.remove('hidden-section');
        document.getElementById('auth-phone-div').classList.add('hidden-section');
    });

    // Go to registration
    document.getElementById('go-to-register').addEventListener('click', () => showSection('register-section'));
    document.getElementById('back-to-auth').addEventListener('click', () => showSection('auth-section'));

    // Registration tabs
    document.getElementById('reg-phone-tab').addEventListener('click', (e) => {
        document.getElementById('reg-phone-tab').className = "w-1/2 py-3 auth-tab-active text-lg";
        document.getElementById('reg-email-tab').className = "w-1/2 py-3 auth-tab-inactive text-lg";
        document.getElementById('reg-phone-div').classList.remove('hidden-section');
        document.getElementById('reg-email-div').classList.add('hidden-section');
    });
    document.getElementById('reg-email-tab').addEventListener('click', (e) => {
        document.getElementById('reg-email-tab').className = "w-1/2 py-3 auth-tab-active text-lg";
        document.getElementById('reg-phone-tab').className = "w-1/2 py-3 auth-tab-inactive text-lg";
        document.getElementById('reg-email-div').classList.remove('hidden-section');
        document.getElementById('reg-phone-div').classList.add('hidden-section');
    });

    // ================== PHONE AUTH (Login & Register) ==================
    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible' });

    // Login OTP send
    document.getElementById('btn-send-otp').addEventListener('click', () => {
        let phone = document.getElementById('auth-phone').value;
        if(phone.startsWith('0')) phone = phone.substring(1);
        const phoneNumber = "+880" + phone;
        
        showLoader(true);
        signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier)
        .then((result) => {
            confirmationResult = result;
            showLoader(false);
            document.getElementById('phone-input-step').classList.add('hidden-section');
            document.getElementById('otp-input-step').classList.remove('hidden-section');
        }).catch((err) => { showLoader(false); alert("Error: " + err.message); });
    });

    // Register OTP send
    document.getElementById('btn-reg-phone-send-otp').addEventListener('click', () => {
        let phone = document.getElementById('reg-phone').value;
        if(phone.startsWith('0')) phone = phone.substring(1);
        const phoneNumber = "+880" + phone;
        
        showLoader(true);
        signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier)
        .then((result) => {
            confirmationResult = result;
            showLoader(false);
            // For registration, after OTP verification, user will be created and redirected to setup
            // We'll handle it in onAuthStateChanged
        }).catch((err) => { showLoader(false); alert("Error: " + err.message); });
    });

    document.getElementById('btn-verify-otp').addEventListener('click', () => {
        const code = document.getElementById('auth-otp').value;
        showLoader(true);
        confirmationResult.confirm(code).catch(err => { showLoader(false); alert("ভুল কোড!"); });
    });

    // ================== EMAIL REGISTRATION ==================
    document.getElementById('btn-reg-email-submit').addEventListener('click', () => {
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-password').value;
        if(email && pass) {
            showLoader(true);
            createUserWithEmailAndPassword(auth, email, pass)
            .catch(err => { showLoader(false); alert(err.message); });
        } else alert("ইমেইল ও পাসওয়ার্ড দিন");
    });

    // Email login
    document.getElementById('btn-login-email').addEventListener('click', () => {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-password').value;
        if(email && pass) {
            showLoader(true);
            signInWithEmailAndPassword(auth, email, pass)
            .catch(err => { showLoader(false); alert("ভুল ইমেইল বা পাসওয়ার্ড"); });
        }
    });

    // Email register (from auth section) - now goes to register section
    document.getElementById('btn-register-email').addEventListener('click', () => {
        showSection('register-section');
        document.getElementById('reg-email-tab').click();
    });

    // ================== PROFILE SETUP ==================
    // Profile picture preview
    document.getElementById('profile-upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                document.getElementById('profile-preview').src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('btn-save-profile').addEventListener('click', async () => {
        const name = document.getElementById('setup-name').value;
        let phone = document.getElementById('setup-phone').value;
        if(auth.currentUser.phoneNumber) phone = auth.currentUser.phoneNumber;
        const profession = document.getElementById('setup-profession').value;
        const blood = document.getElementById('setup-blood').value;
        const para = document.getElementById('setup-para').value;
        const facebook = document.getElementById('setup-facebook').value;
        const whatsapp = document.getElementById('setup-whatsapp').value;
        const telegram = document.getElementById('setup-telegram').value;

        if(!name || !phone || !profession || !para) return alert("দয়া করে সব তথ্য দিন!");
        
        showLoader(true);

        // Upload profile picture if selected
        let photoURL = '';
        const fileInput = document.getElementById('profile-upload');
        if(fileInput.files.length > 0) {
            try {
                photoURL = await uploadToCloudinary(fileInput.files[0]);
            } catch(e) { console.error("Upload failed", e); }
        }

        try {
            await setDoc(doc(db, "users", auth.currentUser.uid), {
                uid: auth.currentUser.uid,
                email: auth.currentUser.email || "",
                name: name,
                phone: phone,
                profession: profession,
                blood: blood,
                para: para,
                facebook: facebook,
                whatsapp: whatsapp,
                telegram: telegram,
                photoURL: photoURL,
                joined: new Date().toISOString(),
                banned: false
            });
            showLoader(false);
            openModal('success-modal');
            setTimeout(() => {
                closeModal('success-modal');
                checkProfileAndRedirect(auth.currentUser);
            }, 2500);
        } catch(e) { showLoader(false); console.error(e); alert("তথ্য সেভ করতে সমস্যা হয়েছে।"); }
    });

    // ================== PROFILE CHECK ==================
    async function checkProfileAndRedirect(user) {
        showLoader(true);
        const docRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(docRef);
        showLoader(false);

        if (docSnap.exists()) {
            currentUserData = docSnap.data();
            if(currentUserData.banned) {
                alert("আপনি ব্ল্যাকলিস্টেড! প্রশাসকের সাথে যোগাযোগ করুন।");
                signOut(auth);
                return;
            }
            setupMainApp(user, currentUserData);
            showSection('main-app');
            switchTab('home');
        } else {
            if(user.phoneNumber) {
                document.getElementById('setup-phone').value = user.phoneNumber;
                document.getElementById('setup-phone-container').classList.add('hidden-section');
            }
            showSection('setup-section');
        }
    }

    function setupMainApp(user, data) {
        document.getElementById('welcome-name').innerText = data.name;
        document.getElementById('prof-name').innerText = data.name;
        document.getElementById('prof-profession').innerText = data.profession;
        document.getElementById('prof-para').innerText = data.para;
        document.getElementById('prof-blood').innerText = data.blood || 'N/A';
        document.getElementById('prof-phone').innerText = data.phone;
        if(data.photoURL) {
            document.getElementById('prof-pic').src = data.photoURL;
            document.getElementById('home-profile-pic').innerHTML = `<img src="${data.photoURL}" class="w-full h-full object-cover">`;
        }
        // Social links
        renderProfileSocial(data);
        
        // Admin check
        if(user.email === 'mdwld2005@gmail.com') {
            document.getElementById('admin-nav-btn').classList.remove('hidden-section');
            document.querySelectorAll('.nav-btn').forEach(btn => { if(!btn.classList.contains('hidden-section')) btn.classList.replace('w-1/5', 'w-1/6'); });
        }
        loadBanners();
        loadNotices();
    }

    function renderProfileSocial(data) {
        const container = document.getElementById('profile-social-links');
        container.innerHTML = '';
        if(data.facebook) container.innerHTML += `<a href="https://facebook.com/${data.facebook}" target="_blank" class="text-blue-600 text-xl"><i class="fab fa-facebook"></i></a>`;
        if(data.whatsapp) container.innerHTML += `<a href="https://wa.me/${data.whatsapp}" target="_blank" class="text-green-600 text-xl"><i class="fab fa-whatsapp"></i></a>`;
        if(data.telegram) container.innerHTML += `<a href="https://t.me/${data.telegram}" target="_blank" class="text-blue-400 text-xl"><i class="fab fa-telegram"></i></a>`;
    }

    // ================== EDIT PROFILE ==================
    document.getElementById('btn-edit-profile').addEventListener('click', () => {
        if(!currentUserData) return;
        document.getElementById('edit-name').value = currentUserData.name || '';
        document.getElementById('edit-profession').value = currentUserData.profession || '';
        document.getElementById('edit-para').value = currentUserData.para || '';
        document.getElementById('edit-blood').value = currentUserData.blood || '';
        document.getElementById('edit-facebook').value = currentUserData.facebook || '';
        document.getElementById('edit-whatsapp').value = currentUserData.whatsapp || '';
        document.getElementById('edit-telegram').value = currentUserData.telegram || '';
        if(currentUserData.photoURL) document.getElementById('edit-preview').src = currentUserData.photoURL;
        openModal('edit-profile-modal');
    });

    document.getElementById('edit-profile-upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = (ev) => document.getElementById('edit-preview').src = ev.target.result;
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('btn-update-profile').addEventListener('click', async () => {
        showLoader(true);
        const updates = {
            name: document.getElementById('edit-name').value,
            profession: document.getElementById('edit-profession').value,
            para: document.getElementById('edit-para').value,
            blood: document.getElementById('edit-blood').value,
            facebook: document.getElementById('edit-facebook').value,
            whatsapp: document.getElementById('edit-whatsapp').value,
            telegram: document.getElementById('edit-telegram').value,
        };
        const fileInput = document.getElementById('edit-profile-upload');
        if(fileInput.files.length > 0) {
            try {
                updates.photoURL = await uploadToCloudinary(fileInput.files[0]);
            } catch(e) { console.error("Upload failed", e); }
        }
        try {
            await updateDoc(doc(db, "users", auth.currentUser.uid), updates);
            currentUserData = { ...currentUserData, ...updates };
            setupMainApp(auth.currentUser, currentUserData);
            closeModal('edit-profile-modal');
        } catch(e) { alert("আপডেট ব্যর্থ"); }
        showLoader(false);
    });

    // ================== BANNER SLIDER ==================
    async function loadBanners() {
        const track = document.getElementById('banner-track');
        try {
            const querySnapshot = await getDocs(collection(db, "banners"));
            let banners = [];
            querySnapshot.forEach((doc) => banners.push({id: doc.id, ...doc.data()}));
            
            if(banners.length > 0) {
                track.innerHTML = '';
                banners.forEach(b => {
                    track.innerHTML += `<img src="${b.imgUrl}" onclick="window.open('${b.linkUrl || '#'}', '_blank')" class="slide">`;
                });
                startSlider(banners.length);
            } else {
                track.innerHTML = '<div class="slide bg-gray-200 flex items-center justify-center"><i class="fas fa-image text-4xl text-gray-400"></i></div>';
            }
        } catch(e) { console.log("Banner load error", e); }
    }

    function startSlider(count) {
        if(count <= 1) return;
        const track = document.getElementById('banner-track');
        let index = 0;
        setInterval(() => {
            index = (index + 1) % count;
            track.style.transform = `translateX(-${index * 100}%)`;
        }, 3500);
    }

    // Admin: Upload banner with Cloudinary
    document.getElementById('admin-banner-file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('admin-banner-preview').src = ev.target.result;
                document.getElementById('admin-banner-preview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('btn-upload-banner').addEventListener('click', async () => {
        const fileInput = document.getElementById('admin-banner-file');
        const linkUrl = document.getElementById('admin-banner-url').value || '#';
        if(!fileInput.files.length) return alert("ছবি নির্বাচন করুন");
        
        showLoader(true);
        try {
            const imgUrl = await uploadToCloudinary(fileInput.files[0]);
            await addDoc(collection(db, "banners"), { imgUrl, linkUrl, addedAt: new Date() });
            alert("ব্যানার যুক্ত হয়েছে!");
            fileInput.value = '';
            document.getElementById('admin-banner-preview').classList.add('hidden');
            document.getElementById('admin-banner-url').value = '';
        } catch(e) { alert("Error: "+e.message); }
        showLoader(false);
    });

    // ================== NOTICES ==================
    async function loadNotices() {
        const list = document.getElementById('notices-list');
        try {
            const querySnapshot = await getDocs(collection(db, "notices"));
            let notices = [];
            querySnapshot.forEach((doc) => notices.push(doc.data()));
            list.innerHTML = '';
            if(notices.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center">কোনো নোটিশ নেই</p>';
            } else {
                notices.sort((a,b) => new Date(b.addedAt) - new Date(a.addedAt));
                notices.forEach(n => {
                    list.innerHTML += `
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-primary mb-3">
                            <div class="flex justify-between items-start mb-2"><h4 class="font-bold text-gray-800">নোটিশ</h4><span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">${new Date(n.addedAt).toLocaleDateString('bn')}</span></div>
                            <p class="text-sm text-gray-600 leading-relaxed">${n.text}</p>
                        </div>
                    `;
                });
            }
        } catch(e) { console.error(e); }
    }

    document.getElementById('btn-add-notice').addEventListener('click', async () => {
        const text = document.getElementById('admin-notice-text').value;
        if(!text) return alert("নোটিশ লিখুন");
        showLoader(true);
        try {
            await addDoc(collection(db, "notices"), { text, addedAt: new Date() });
            alert("নোটিশ দেওয়া হয়েছে");
            document.getElementById('admin-notice-text').value = '';
            loadNotices();
        } catch(e) { alert(e.message); }
        showLoader(false);
    });

    // ================== VILLAGERS ==================
    async function loadVillagers() {
        if(allVillagers.length === 0) {
            showLoader(true);
            const querySnapshot = await getDocs(collection(db, "users"));
            allVillagers = [];
            querySnapshot.forEach((doc) => { allVillagers.push({id: doc.id, ...doc.data()}); });
            document.getElementById('total-users-count').innerText = allVillagers.length;
            showLoader(false);
        }
        renderVillagers(allVillagers.filter(v => !v.banned));
    }

    function renderVillagers(dataList) {
        const listContainer = document.getElementById('villagers-list');
        listContainer.innerHTML = '';
        dataList.forEach(v => {
            const vData = encodeURIComponent(JSON.stringify(v));
            listContainer.innerHTML += `
                <div onclick="showVillagerDetails('${vData}')" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center cursor-pointer hover:bg-green-50 transition">
                    <div class="w-12 h-12 rounded-full flex-shrink-0 mr-4 overflow-hidden border border-gray-200">
                        <img src="${v.photoURL || 'https://via.placeholder.com/100'}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-grow">
                        <h4 class="font-bold text-gray-800">${v.name}</h4>
                        <p class="text-[11px] font-semibold text-primary mb-0.5">${v.profession || 'সদস্য'}</p>
                        <p class="text-xs text-gray-500"><i class="fas fa-map-marker-alt text-gray-400 mr-1"></i>${v.para}</p>
                    </div>
                    <div class="text-right"><i class="fas fa-chevron-right text-gray-300"></i></div>
                </div>
            `;
        });
    }

    window.showVillagerDetails = (encodedData) => {
        const v = JSON.parse(decodeURIComponent(encodedData));
        document.getElementById('v-modal-name').innerText = v.name;
        document.getElementById('v-modal-prof').innerText = v.profession || 'সদস্য';
        document.getElementById('v-modal-para').innerText = v.para;
        document.getElementById('v-modal-phone').innerText = v.phone;
        document.getElementById('v-modal-phone').href = `tel:${v.phone}`;
        document.getElementById('v-modal-call').href = `tel:${v.phone}`;
        document.getElementById('v-modal-blood').innerText = v.blood || 'N/A';
        document.getElementById('v-modal-pic').src = v.photoURL || 'https://via.placeholder.com/100';
        
        const socialDiv = document.getElementById('v-modal-social');
        socialDiv.innerHTML = '';
        if(v.facebook) socialDiv.innerHTML += `<a href="https://facebook.com/${v.facebook}" target="_blank" class="text-blue-600 text-xl"><i class="fab fa-facebook"></i></a>`;
        if(v.whatsapp) socialDiv.innerHTML += `<a href="https://wa.me/${v.whatsapp}" target="_blank" class="text-green-600 text-xl"><i class="fab fa-whatsapp"></i></a>`;
        if(v.telegram) socialDiv.innerHTML += `<a href="https://t.me/${v.telegram}" target="_blank" class="text-blue-400 text-xl"><i class="fab fa-telegram"></i></a>`;
        
        openModal('villager-modal');
    };

    document.getElementById('search-villager').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allVillagers.filter(v => 
            !v.banned && (
                v.name.toLowerCase().includes(term) || 
                v.phone.includes(term) || 
                (v.profession && v.profession.toLowerCase().includes(term))
            )
        );
        renderVillagers(filtered);
    });

    // ================== ADMIN USER MANAGEMENT ==================
    async function loadAdminData() {
        // Load users
        const querySnapshot = await getDocs(collection(db, "users"));
        const users = [];
        querySnapshot.forEach((doc) => users.push({id: doc.id, ...doc.data()}));
        renderUserList(users);
        
        // Load theme options
        renderThemeSelector();
    }

    function renderUserList(users) {
        const container = document.getElementById('admin-user-list');
        container.innerHTML = '';
        users.forEach(u => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg border';
            div.innerHTML = `
                <div class="flex items-center space-x-2">
                    <img src="${u.photoURL || 'https://via.placeholder.com/40'}" class="w-8 h-8 rounded-full object-cover">
                    <div>
                        <p class="font-bold text-sm">${u.name}</p>
                        <p class="text-xs text-gray-500">${u.phone}</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button class="ban-btn text-xs px-2 py-1 rounded ${u.banned ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}" data-uid="${u.id}" data-banned="${u.banned || false}">${u.banned ? 'আনব্যান' : 'ব্যান'}</button>
                    <button class="delete-btn text-xs px-2 py-1 rounded bg-red-600 text-white" data-uid="${u.id}">ডিলিট</button>
                </div>
            `;
            container.appendChild(div);
        });

        // Add event listeners
        document.querySelectorAll('.ban-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const uid = e.target.dataset.uid;
                const banned = e.target.dataset.banned === 'true';
                await updateDoc(doc(db, "users", uid), { banned: !banned });
                loadAdminData();
            });
        });
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                if(confirm("নিশ্চিত?")) {
                    await deleteDoc(doc(db, "users", e.target.dataset.uid));
                    loadAdminData();
                }
            });
        });
    }

    document.getElementById('admin-user-search').addEventListener('input', async (e) => {
        const term = e.target.value.toLowerCase();
        const querySnapshot = await getDocs(collection(db, "users"));
        const users = [];
        querySnapshot.forEach((doc) => {
            const u = doc.data();
            if(u.name.toLowerCase().includes(term) || u.phone.includes(term)) users.push({id: doc.id, ...u});
        });
        renderUserList(users);
    });

    // ================== THEME SELECTOR ==================
    const gradients = [
        'from-green-400 to-blue-500', 'from-purple-400 to-pink-500', 'from-yellow-400 to-red-500',
        'from-indigo-500 to-purple-600', 'from-red-400 to-yellow-500', 'from-green-500 to-teal-500',
        'from-blue-500 to-cyan-500', 'from-pink-500 to-rose-500', 'from-orange-500 to-amber-500',
        'from-gray-700 to-gray-900', 'from-emerald-500 to-lime-500', 'from-violet-500 to-fuchsia-500'
    ];

    function renderThemeSelector() {
        const container = document.getElementById('theme-selector');
        container.innerHTML = '';
        gradients.forEach(g => {
            const btn = document.createElement('button');
            btn.className = `h-10 rounded-lg bg-gradient-to-r ${g} border-2 border-white shadow hover:scale-105 transition`;
            btn.onclick = () => applyTheme(g);
            container.appendChild(btn);
        });
    }

    async function applyTheme(gradient) {
        // Save to Firestore settings
        await setDoc(doc(db, "settings", "theme"), { gradient });
        // Apply to header and bottom nav
        document.querySelector('header').className = `absolute top-0 w-full bg-gradient-to-r ${gradient} text-white px-4 py-3 flex items-center justify-between z-40 shadow-md`;
        document.querySelector('.nav-center').className = `nav-center w-14 h-14 bg-gradient-to-r ${gradient} text-white rounded-full flex items-center justify-center shadow-[0_5px_15px_rgba(0,0,0,0.4)] hover:scale-105 transition-transform`;
        // Also apply to other elements if needed
    }

    // ================== PULL TO REFRESH ==================
    let startY = 0;
    const content = document.getElementById('main-content');
    content.addEventListener('touchstart', (e) => {
        if(content.scrollTop === 0) startY = e.touches[0].clientY;
    });
    content.addEventListener('touchmove', (e) => {
        if(content.scrollTop === 0 && e.touches[0].clientY > startY + 50) {
            document.getElementById('refresh-indicator').style.opacity = '1';
        }
    });
    content.addEventListener('touchend', async (e) => {
        if(content.scrollTop === 0 && startY && e.changedTouches[0].clientY > startY + 50) {
            document.getElementById('refresh-indicator').style.opacity = '1';
            // Refresh data
            allVillagers = [];
            bannersLoaded = false;
            noticesLoaded = false;
            await loadBanners();
            await loadVillagers();
            await loadNotices();
            document.getElementById('refresh-indicator').style.opacity = '0';
        }
        startY = 0;
    });

    // ================== LOGOUT ==================
    document.getElementById('btn-logout').addEventListener('click', () => { signOut(auth).then(() => { window.location.reload(); }); });
</script>
</body>
</html>
